# MyTodo Server 后端架构设计文档

**文档版本**: 1.0

---

## 1. 文档目的与范围

本文档描述 MyTodo Server 后端的总体架构、模块划分、关键业务/技术流程、部署拓扑、配置与运维要点，并给出扩展点与风险控制建议。

- 范围：后端服务（Flask + Gevent + SQLite + Redis + Socket.IO）
- 不包含：前端架构、第三方服务内部实现细节

---

## 2. 总体架构概览

### 2.1 架构风格

- 典型的 **分层架构**（路由层 / 服务层 / 数据层），以功能模块拆分文件与目录。
- 以 **单进程 + Gevent 协程** 为主要并发模型，辅以少量线程执行 CPU/阻塞型任务。
- 支持 **WebSocket**（Flask-SocketIO, gevent async mode）。

### 2.2 关键组件

- **Web 框架**：Flask
- **并发/网络**：Gevent WSGIServer + WebSocketHandler
- **持久化存储**：SQLite（SQLAlchemy）
- **缓存与轻量队列/列表**：Redis
- **定时任务**：APScheduler
- **外部能力**：
  - AI：Dify/豆包等（见 `core/ai/`）
  - 语音：ASR/TTS（见 `core/chat/`、`core/tts/`）
  - 设备：蓝牙/DLNA/小米/Agent（见 `core/device/`、`core/services/*_mgr.py`）

---

## 3. 项目结构与模块划分

### 3.1 目录结构

```
core/
├── api/          # 路由层（Blueprint）
├── services/     # 业务逻辑层（各类 mgr）
├── device/       # 设备控制层（蓝牙/DLNA/小米/Agent 等）
├── db/           # 数据访问层（SQLite/Redis 封装）
├── models/       # 数据模型层（SQLAlchemy Models）
├── ai/           # AI 服务层
├── chat/         # 聊天服务层（含 ASR）
├── tts/          # TTS 服务层
└── tools/        # 工具与兼容性修复
```

### 3.2 模块职责

- **入口与应用工厂**
  - `main.py`：服务启动、WSGI 中间件挂载、静态资源挂载
  - `core/__init__.py:create_app()`：创建 Flask App、注册蓝图、初始化 socket/db/ai/scheduler

- **路由层（core/api）**
  - 按设备/媒体/PDF/播放列表等维度拆分。
  - 统一返回结构通常为 `{"code":0|非0,"msg":"...","data":...}`（`core.utils._ok/_err` 或各 mgr 返回）。

- **服务层（core/services）**
  - 对外暴露可复用的业务能力（例如音频合成/转码、播放列表、设备管理、定时任务）。
  - 封装异步/后台执行策略（线程、gevent 等）。

- **设备层（core/device）**
  - 对接外部设备协议与 SDK（蓝牙、DLNA、miservice、Agent HTTP）。

- **数据层（core/db + core/models）**
  - SQLite：以 SQLAlchemy 为主。
  - Redis：用于缓存、列表存储（例如播放列表/抽奖数据/临时数据）。

---

## 4. 运行时拓扑与请求路径

### 4.1 WSGI 挂载

`main.py` 使用 `DispatcherMiddleware` 将服务挂载为：

- `/api` -> Flask API（业务接口）
- `/web` -> 静态资源（`static` 目录）

因此：代码中声明 `/xxx` 的路由，实际访问路径为 `/api/xxx`。

### 4.2 关键中间件/钩子

- 全局 `after_request` 设置 CORS 相关 header。
- 非生产环境附加禁用缓存 header。

---

## 5. 数据存储设计

### 5.1 SQLite（关系型）

- 用途：核心业务数据、持久化对象。
- 技术：SQLAlchemy。
- 现状风险：SQLite 在高并发写入下会成为瓶颈；若规模增长建议迁移到 PostgreSQL/MySQL。

### 5.2 Redis（缓存/列表）

- 用途：缓存字符串、列表分页读取、轻量任务/临时状态。
- 接口：`core/db/rds_mgr.py`。

---

## 6. 关键流程说明

### 6.1 API 请求处理流程（HTTP）

1. Client -> `/api/...`
2. WSGI Server（gevent）接入
3. Flask 路由匹配（Blueprint）
4. 路由函数解析参数（query/json/form/file）
5. 调用 services/db/device 等模块
6. 返回统一结构或文件流

### 6.2 WebSocket（Socket.IO）流程

1. Client 建立 Socket.IO 连接
2. `create_app()` 初始化 SocketIO（gevent async_mode）
3. `chat_mgr.init(socketio)` 注册事件/处理流式输出

### 6.3 音频合成/转码（后台任务）

- 由 `core/services/audio_merge_mgr.py`、`audio_convert_mgr.py` 管理。
- 路由在 `core/api/media_routes.py`。
- 典型流程：创建任务 -> 上传/添加文件 -> 调整顺序 -> start -> 查询状态 -> download/save。

### 6.4 PDF 解密（后台任务）

- 路由在 `core/api/pdf_routes.py`。
- 服务在 `core/services/pdf_mgr.py`。
- 典型流程：upload -> decrypt -> task status -> download/list -> delete。

---

## 7. 配置、日志与运维

### 7.1 配置管理

- 单一配置入口：`core/config.py`。
- 使用 `python-dotenv` 加载 `.env`。
- 重要配置：HOST/PORT、MAX_CONTENT_LENGTH、DB/Redis、AI/TTS/ASR、设备地址、FFmpeg 路径与超时、CORS Origins。

### 7.2 日志

- 应用日志：`logs/app.log`
- 访问日志：`logs/access.log`
- 建议补充：慢请求/慢查询日志、审计日志。

### 7.3 部署形态

- 当前：`python main.py` 单进程 + gevent。
- 建议：生产环境可考虑 gunicorn 多 worker（gevent worker）+ 反向代理（Nginx/Caddy）。

---

## 8. 安全与权限设计（现状与建议）

### 8.1 现状

- 当前接口普遍无认证/授权。
- CORS 配置偏宽松（`*`）。

### 8.2 建议

- 引入认证（JWT / API Key）。
- 对设备控制/文件操作接口加鉴权与审计。
- CORS Origins 在生产环境启用白名单。
- 对所有输入做统一校验（可引入 Pydantic/Marshmallow）。

---

## 9. 扩展点与演进路线

### 9.1 规模与并发

- 将 SQLite 迁移到 PostgreSQL/MySQL。
- 引入任务队列（Celery/RQ）承载 CPU/长耗时任务。

### 9.2 可观测性

- 健康检查端点 `/health`。
- Prometheus 指标（请求耗时、队列长度、任务状态）。
- Sentry 错误追踪。

### 9.3 工程化

- 单元测试（pytest）+ 集成测试。
- CI 校验（lint/typecheck/test）。

---

## 10. 已知风险与约束

- SQLite 写入并发瓶颈。
- 缺少认证授权导致安全风险。
- 部分接口输入校验不足（路径/SQL/文件上传）。
- 单进程模型限制水平扩展。

---

## 11. 参考

- [后端项目评估报告](./后端项目评估报告.md)
- [配置管理统一方案](./配置管理统一方案.md)
- [API 文档入口](./api/api.md)
