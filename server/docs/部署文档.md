# MyTodo Server 部署文档

本文档描述 MyTodo Server（后端）与前端静态资源的部署方式，覆盖：依赖准备、环境变量、systemd 运行、日志与常见运维操作。

---

## 1. 部署形态概览

- **后端**：`python main.py` 启动（内置 gevent WSGI server）
- **前端**：构建后产物复制到 `server/static/`，通过后端挂载的 `/web` 提供静态页面
- **数据库**：默认 SQLite（项目根目录 `data.db`）
- **缓存/队列**：Redis（必须）

---

## 2. 运行环境要求

- Linux 服务器（推荐 Debian/Ubuntu/CentOS 皆可）
- Python 3.x（推荐 Conda/venv）
- Redis（本机或远程均可）
- Node.js + npm（仅在需要构建前端时需要）

---

## 3. 代码与目录

假设部署目录为：`/mnt/data/project/MyTodo/server`（按你实际路径调整）。

关键文件：

- `main.py`：后端入口
- `core/config/config.py`：配置入口（从环境变量读取）
- `deploy.sh`：前端构建并复制到 `static/` 的脚本
- `logs/`：日志目录（如不存在会自动创建/或由日志配置创建）

---

## 4. 环境变量与 .env

项目会自动加载部署目录下的 `.env`（如果存在）。建议在部署目录创建 `.env`，并至少配置：

```bash
ENV=production
HOST=0.0.0.0
PORT=8000

# Redis
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_DB=0

# CORS（生产建议设置为白名单）
CORS_ORIGINS=https://yourdomain.com

# 可选：仅对 PostgreSQL/MySQL 等 Client/Server 数据库连接池参数生效
DB_POOL_SIZE=10
DB_MAX_OVERFLOW=20
DB_POOL_RECYCLE=3600
DB_POOL_PRE_PING=true
```

说明：

- SQLite 场景下不会通过 `pool_size` 提升吞吐；高并发建议迁移到 PostgreSQL/MySQL。
- AI/TTS/ASR 等外部服务相关的密钥/地址也建议放在 `.env` 中配置。

---

## 5. Redis 部署

### 5.1 使用系统服务（示例）

根据发行版安装并启动 Redis（命令因系统不同略有差异）。

### 5.2 使用 Docker（示例）

如需 docker 方式，可参考 `docs/server.md` 中的 Redis 部署片段。

---

## 6. 前端构建与部署（可选）

如果你需要部署前端页面（`/web`），在后端目录执行：

```bash
./deploy.sh
```

脚本会：

- 在 `frontend/` 下执行 `npm run build`
- 将 `frontend/dist/` 中的产物复制到 `static/`
- 自动修复 `static/index.html` 的资源路径（mac/Linux 分别用不同 `sed` 参数）

部署后访问：

- `http://<host>:8000/web/index.html`

---

## 7. systemd 部署（推荐）

### 7.1 创建 service 文件

创建 `/etc/systemd/system/my-todo.service`：

```ini
[Unit]
Description=MyTodo Server
After=network.target

[Service]
Type=simple
User=leo
WorkingDirectory=/mnt/data/project/MyTodo/server
Environment="PATH=/home/leo/.conda/envs/flask_env/bin:/usr/local/bin:/usr/bin:/bin"
ExecStart=/home/leo/.conda/envs/flask_env/bin/python /mnt/data/project/MyTodo/server/main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

你需要根据实际情况调整：

- `User`
- `WorkingDirectory`
- `Environment PATH`
- `ExecStart` 指向的 python 与项目路径

### 7.2 启动/重启/查看状态

```bash
sudo systemctl daemon-reload
sudo systemctl enable my-todo
sudo systemctl start my-todo

sudo systemctl status my-todo
sudo systemctl restart my-todo
```

### 7.3 查看日志

如果日志写入文件：查看 `logs/` 下文件。

如果你需要 systemd/journald：

```bash
sudo journalctl -u my-todo -f
```

---

## 8. 反向代理（可选）

如需公网访问/HTTPS，常用方式：

- Nginx
- Caddy

相关命令与片段可以参考 `docs/server.md`（其中也包含证书/端口等运维记录）。

---

## 9. 健康检查与接口文档

- 健康检查：
  - `GET /health`
  - `GET /api/health`
- Swagger UI（flask-smorest 自动生成）：`/docs`
- OpenAPI JSON：`/openapi.json`

示例：

- `http://127.0.0.1:8000/docs`
- `http://127.0.0.1:8000/openapi.json`

---

## 10. 常见问题

### 10.1 `database is locked`

SQLite 并发写入时可能出现锁库：

- 避免并发写
- 引入串行写策略（队列/锁/重试）
- 并发增加建议迁移到 PostgreSQL/MySQL

### 10.2 静态资源 404 或路径错误

优先使用 `./deploy.sh` 构建并复制静态资源；脚本会修复 `index.html` 中 `/assets/` 等路径。
