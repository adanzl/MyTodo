# MyTodo Server 开发指南（精简版）

本文档仅包含本项目后端在本地开发所需的最小步骤。

---

## 1. 环境要求

- Python 3.x（推荐使用 Conda/venv 隔离环境）
- Redis（本地启动或使用远程 Redis）

---

## 2. 安装与依赖

### 2.1 创建并激活环境（任选其一）

Conda（推荐）：

```bash
conda create -n flask_env python=3.13
conda activate flask_env
```

venv：

```bash
python -m venv .venv
source .venv/bin/activate
```

### 2.2 安装依赖

```bash
python -m pip install -U pip
python -m pip install -r requirements.txt
```

### 2.3 mac 开发环境如何处理 `dbus-python`

`dbus-python` 一般仅在 Linux 运行环境需要/可用，macOS 上安装会很不方便。

推荐在 `requirements.txt` 使用平台标记，让它只在 Linux 安装：

```diff
- dbus-python>=1.2.18
+ dbus-python>=1.2.18; platform_system == "Linux"
```

改完后重新执行：

```bash
python -m pip install -r requirements.txt
```

---

## 3. 配置（最小化）

项目会自动加载根目录的 `.env`（如果存在）。你可以创建一个最小 `.env`：

```bash
ENV=development
PORT=8000

REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
```

---

## 4. 启动服务

```bash
python main.py
```

常用地址：

- API：`http://127.0.0.1:8000/api`
- 健康检查：`http://127.0.0.1:8000/health`
- API 文档（手写）：见 `docs/api/api.md`（仓库内文档），或启动后通过 Web 前端访问 `http://127.0.0.1:8000/web/index.html` 在页面内查看接口说明
- API 文档（自动生成 / smorest Swagger UI）：`http://127.0.0.1:8000/docs`
- OpenAPI JSON（自动生成）：`http://127.0.0.1:8000/openapi.json`

---

## 5. 测试与覆盖率

运行全部测试：

```bash
pytest
```

查看 `core/services` 覆盖率：

```bash
pytest -q --cov=core/services --cov-report=term-missing:skip-covered tests/services
```

如果你的 `pytest` 不在 PATH，可使用环境内的完整路径，例如：

```bash
/opt/homebrew/Caskroom/miniconda/base/envs/flask_env/bin/pytest -q tests/services
```

---

## 6. 常见问题

- **macOS 安装 `dbus-python` 失败**：按「2.3」用 `platform_system == "Linux"` 跳过。
- **SQLite 报 `database is locked`**：SQLite 单写多读属正常限制；并发写多时建议串行写入或迁移到 PostgreSQL/MySQL。
