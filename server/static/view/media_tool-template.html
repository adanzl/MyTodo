<div class="p-1">
  <!-- 页签 -->
  <el-tabs v-model="activeTab" class="flex-1 flex flex-col overflow-hidden h-[calc(100vh-150px)]">
    <el-tab-pane label="音频合成" name="audio_merge">
      <div class="flex gap-4 h-full">
        <!-- 左侧：任务列表 -->
        <div class="w-64 border rounded p-3 flex flex-col">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-base font-semibold">任务列表</h3>
            <div class="flex items-center gap-1">
              <el-button
                type="info"
                size="small"
                plain
                @click="loadTaskList"
                :loading="loading"
                class="!w-8 !h-6 !p-0">
                <el-icon v-if="!loading"><Refresh /></el-icon>
              </el-button>
              <el-button
                type="success"
                size="small"
                @click="handleCreateTask"
                :loading="loading"
                class="!w-8 !h-6 !p-0">
                <el-icon><Plus /></el-icon>
              </el-button>
            </div>
          </div>
          <div
            v-if="taskList && taskList.length > 0"
            class="flex-1 overflow-y-auto space-y-2 pr-1 min-h-[400px]">
            <div
              v-for="task in taskList"
              :key="task.task_id"
              class="border rounded px-3 py-2 cursor-pointer hover:bg-gray-50 group min-h-[60px] flex flex-col justify-between"
              :class="{ 'border-blue-500 bg-blue-50': currentTask && task.task_id === currentTask.task_id }"
              @click="handleViewTask(task.task_id)">
              <!-- 第一行：名称、文件数量 -->
              <div class="flex items-center justify-between gap-2">
                <div class="text-sm font-medium truncate flex-1 min-w-0">{{ task.name }}</div>
                <span class="text-xs text-gray-500 whitespace-nowrap flex items-center gap-1 flex-shrink-0">
                  <el-icon><Document class="!w-3 !h-3" /></el-icon>
                  <span class="whitespace-nowrap w-5 flex items-center justify-center">{{ task.files ? task.files.length : 0 }}</span>
                </span>
              </div>
              <!-- 第二行：状态、下载按钮、删除按钮 -->
              <div class="flex items-center justify-between gap-2 min-h-[20px]">
                <el-tag 
                  v-if="task.status === 'pending'" 
                  type="info" 
                  size="small"
                  class="!h-5 !text-xs">等待中</el-tag>
                <el-tag 
                  v-else-if="task.status === 'processing'" 
                  type="warning" 
                  size="small"
                  class="!h-5 !text-xs">处理中</el-tag>
                <el-tag 
                  v-else-if="task.status === 'success'" 
                  type="success" 
                  size="small"
                  class="!h-5 !text-xs">成功</el-tag>
                <el-tag 
                  v-else-if="task.status === 'failed'" 
                  type="danger" 
                  size="small"
                  class="!h-5 !text-xs">失败</el-tag>
                <div class="flex items-center gap-1 flex-shrink-0">
                  <el-button
                    v-if="task.status === 'success' && task.result_file"
                    type="primary"
                    size="small"
                    plain
                    @click.stop="handleDownloadResultFromList(task)"
                    class="!h-5 !text-xs !px-2">
                    下载
                  </el-button>
                  <el-button
                    type="danger"
                    size="small"
                    plain
                    @click.stop="handleDeleteTask(task.task_id)"
                    :disabled="task.status === 'processing'"
                    class="!h-5 !text-xs !px-2">
                    删除
                  </el-button>
                </div>
              </div>
            </div>
          </div>
          <div v-else class="flex-1 flex items-center justify-center text-sm text-gray-400">
            暂无任务，请点击"新建"创建
          </div>
        </div>

        <!-- 右侧：任务详情 -->
        <div class="flex-1 border rounded p-3 flex flex-col max-w-2xl" v-if="currentTask">
          <div class="flex items-center justify-between mb-3 flex-shrink-0">
            <h3 class="text-base font-semibold">任务详情: {{ currentTask.name }}</h3>
          </div>

          <div class="flex-1 overflow-auto flex flex-col gap-3">
            <!-- 任务信息 -->
            <div class="flex items-center gap-4 flex-shrink-0">
              <el-tag :type="getStatusTagType(currentTask.status)" size="small">
                {{ getStatusText(currentTask.status) }}
              </el-tag>
              <span v-if="currentTask.error_message" class="text-red-500 text-xs">
                错误: {{ currentTask.error_message }}
              </span>
            </div>

            <!-- 文件列表 -->
            <div class="border rounded p-2 flex-1 flex flex-col overflow-hidden">
              <div class="flex items-center justify-between mb-2 flex-shrink-0">
                <h4 class="text-sm font-semibold">文件列表</h4>
                <el-button 
                  type="primary" 
                  size="small" 
                  :disabled="currentTask.status === 'processing'" 
                  @click="handleOpenFileBrowser"
                  class="!h-6 !text-xs">
                  添加文件
                </el-button>
              </div>
              <div class="flex-1 overflow-auto">
                <el-table :data="currentTask.files || []" stripe style="width: 100%" size="small">
                  <el-table-column type="index" label="序号" width="60" />
                  <el-table-column prop="name" label="文件名" min-width="200" />
                  <el-table-column label="文件大小" width="100">
                    <template #default="{ row }">
                      {{ formatFileSize(row.size) }}
                    </template>
                  </el-table-column>
                  <el-table-column label="操作" width="100" fixed="right">
                    <template #default="{ row, $index }">
                      <el-button
                        type="danger"
                        size="small"
                        plain
                        @click="handleRemoveFile($index)"
                        :disabled="currentTask.status === 'processing'"
                        class="!h-6 !text-xs">
                        删除
                      </el-button>
                    </template>
                  </el-table-column>
                </el-table>
              </div>
            </div>

            <!-- 操作按钮 -->
            <div class="flex items-center gap-2 flex-shrink-0">
              <el-button
                type="success"
                size="small"
                @click="handleStartMerge"
                :disabled="!currentTask.files || currentTask.files.length === 0 || currentTask.status === 'processing'"
                :loading="currentTask.status === 'processing'"
                class="!h-7 !text-xs">
                开始合成
              </el-button>
              <el-button
                v-if="currentTask.status === 'success' && currentTask.result_file"
                type="primary"
                size="small"
                @click="handleDownloadResult"
                class="!h-7 !text-xs">
                下载结果
              </el-button>
            </div>
          </div>
        </div>

        <!-- 右侧：空状态 -->
        <div class="flex-1 border rounded p-3 flex flex-col max-w-2xl" v-else>
          <div class="flex items-center justify-between mb-3 flex-shrink-0">
            <h3 class="text-base font-semibold">任务详情</h3>
          </div>
          <div class="flex-1 flex items-center justify-center text-sm text-gray-400">
            请从左侧选择一个任务查看详情
          </div>
        </div>
      </div>
    </el-tab-pane>
  </el-tabs>

  <!-- 文件对话框 -->
  <file-dialog
    :visible="fileBrowserDialogVisible"
    @update:visible="fileBrowserDialogVisible = $event"
    title="选择文件添加到任务"
    confirm-button-text="添加"
    :confirm-loading="loading"
    @confirm="handleFileBrowserConfirm"
    @close="handleCloseFileBrowser">
  </file-dialog>
</div>
