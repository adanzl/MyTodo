<div class="p-1">
  <!-- 顶部：水平标签页形式的 plan 列表 -->
  <div class="mb-3">
    <div class="flex items-center">
      <el-radio-group
        size="large"
        :model-value="activePlanId"
        @change="handleSelectPlan"
        class="">
        <el-radio-button
          v-for="plan in planCollection"
          :key="plan.id"
          :value="plan.id">
          {{ plan.name }}
        </el-radio-button>
      </el-radio-group>
      <div class="flex items-center gap-2 ml-2 flex-shrink-0">
        <el-button
          type="primary"
          size="small"
          plain
          @click="refreshPlanStatus"
          :loading="planRefreshing"
          class="!w-8 !h-6 !p-0">
          <el-icon v-if="!planRefreshing"><Refresh /></el-icon>
        </el-button>
        <el-button
          type="success"
          size="small"
          @click="handleCreatePlan"
          class="!w-8 !h-6 !p-0">
          <el-icon><Plus /></el-icon>
        </el-button>
      </div>
      <div v-if="planCollection.length === 0" class="text-sm text-gray-400 ml-2">
        暂无计划
      </div>
    </div>
  </div>

  <!-- 主要内容区域：左右两部分 -->
  <div v-if="planStatus" class="flex gap-4 h-[calc(100vh-200px)]">
    <!-- 左侧：文件列表（前置列表 + 正式列表） -->
    <div class="flex-1 border rounded p-3 flex flex-col">
      <!-- 前置列表 -->
      <div class="border rounded p-2 mb-2 flex-shrink-0">
        <div class="flex items-center justify-between mb-2">
          <div class="text-xs font-semibold text-gray-600">
            前置文件（播放时优先播放）
            <span
              v-if="planStatus && getPreListFileCountForWeekday(getCurrentWeekday()) > 0"
              class="ml-2 text-gray-500">
              共 {{ getPreListFileCountForWeekday(getCurrentWeekday()) }} 首
            </span>
            <el-tag
              v-if="planStatus.isPlaying && planStatus.in_pre_files"
              type="success"
              size="small"
              class="ml-2">
              播放中
            </el-tag>
          </div>
          <div class="flex items-center gap-1 pr-1">
            <el-button
              type="primary"
              size="small"
              plain
              @click="handleOpenFileBrowserForPreList(getCurrentWeekday())"
              :disabled="!planStatus || preFilesDragMode"
              title="添加文件">
              +
            </el-button>
            <el-button
              :type="preFilesDragMode ? 'success' : 'default'"
              plain
              size="small"
              class="!w-8 !h-6"
              @click="handleTogglePreFilesDragMode"
              :disabled="!planStatus || getPreListFileCountForWeekday(getCurrentWeekday()) === 0"
              :title="preFilesDragMode ? '点击退出拖拽排序模式' : '点击进入拖拽排序模式'">
              <el-icon v-if="preFilesDragMode"><Check /></el-icon>
              <ion-icon v-else class="!w-3.5 !h-3.5" name="chevron-expand-sharp"></ion-icon>
            </el-button>
            <el-button
              type="danger"
              size="small"
              circle
              plain
              @click="handleClearPreLists"
              :disabled="!planStatus || getPreListFileCountForWeekday(getCurrentWeekday()) === 0 || planLoading || preFilesDragMode"
              class="mr-1"
              title="清空列表">
              <el-icon><Delete /></el-icon>
            </el-button>
          </div>
        </div>
        
        <!-- 周一到周日按钮 -->
        <div class="flex items-center gap-1 mb-3">
          <el-button
            v-for="day in [1,2,3,4,5,6,7]"
            :key="day"
            size="small"
            :type="getCurrentWeekday() === day ? 'primary' : 'default'"
            plain
            @click="handleSelectWeekday(day)"
            class="flex-1">
            {{ ['', '周一', '周二', '周三', '周四', '周五', '周六', '周日'][day] }}
            <span class="ml-1 text-xs">
              ({{ getPreListFileCountForWeekday(day) }})
            </span>
          </el-button>
        </div>

        <!-- 当前选中日期的前置列表文件 -->
        <div class="space-y-1 max-h-[200px] overflow-y-auto">
          <template v-for="(preList, preListIndex) in getActivePreListsForWeekday(getCurrentWeekday())" :key="'pre-list-' + preListIndex">
            <div
              v-for="(file, fileIndex) in preList.files"
              :key="'pre-file-' + preListIndex + '-' + fileIndex"
              class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded"
              :class="{ 'bg-blue-50': isPreListFilePlaying(getCurrentWeekday(), fileIndex) }"
              :style="{ cursor: preFilesDragMode ? 'move' : 'default', userSelect: 'none' }"
              :draggable="preFilesDragMode"
              @dragstart="handlePreFileDragStart($event, fileIndex)"
              @dragend="handlePreFileDragEnd($event)"
              @dragover.prevent="handlePreFileDragOver($event)"
              @dragleave="(e) => { if (e.currentTarget) { e.currentTarget.style.backgroundColor = ''; e.currentTarget.style.borderTop = ''; e.currentTarget.style.borderBottom = ''; } }"
              @drop.prevent="handlePreFileDrop($event, fileIndex)">
              <span class="text-xs text-gray-500 w-6">{{ fileIndex + 1 }}</span>
              <span
                class="flex-1 text-xs truncate"
                :class="{ 'text-blue-600': isPreListFilePlaying(getCurrentWeekday(), fileIndex) }"
                :title="file.uri">
                {{ file.uri.split('/').pop() }}
              </span>
              <el-tag v-if="file.duration" type="info" size="small" class="w-12 text-center">
                {{ formatDuration(file.duration) }}
              </el-tag>
              <el-button
                type="plain"
                size="small"
                circle
                @click.stop="handleDeletePreListFile(getCurrentWeekday(), fileIndex)"
                :disabled="preFilesDragMode"
                title="删除">
                <el-icon><Minus /></el-icon>
              </el-button>
            </div>
          </template>
          <div v-if="getPreListFileCountForWeekday(getCurrentWeekday()) === 0" class="text-xs text-gray-400 text-center py-2">
            当前日期无前置列表
          </div>
        </div>
      </div>

      <!-- 正式列表 -->
      <div class="border rounded p-2 flex-1 flex flex-col min-h-0">
        <div class="flex items-center justify-between mb-2 pr-1">
          <div class="text-xs font-semibold text-gray-600">
            正式文件（播放时记录进度）
            <span
              v-if="planStatus && planStatus.main_list && planStatus.main_list.files && planStatus.main_list.files.length > 0"
              class="ml-2 text-gray-500">
              共 {{ planStatus.main_list.files.length }} 首， 当前: {{ planStatus.file_index !== undefined && planStatus.file_index >= 0 ? planStatus.file_index + 1 : '-' }} / {{ planStatus.main_list.files.length }}
            </span>
            <el-tag
              v-if="planStatus.isPlaying && !planStatus.in_pre_files"
              type="success"
              size="small"
              class="ml-2">
              播放中
            </el-tag>
          </div>
          <div class="flex items-center gap-1">
            <el-button
              type="primary"
              plain
              size="small"
              class="!w-8 !h-6"
              @click="handleOpenFileBrowserForMainList"
              :disabled="!planStatus || mainFilesDragMode"
              title="添加文件">
              +
            </el-button>
            <el-button
              :type="mainFilesDragMode ? 'success' : 'default'"
              plain
              size="small"
              class="!w-8 !h-6"
              @click="handleToggleMainFilesDragMode"
              :disabled="!planStatus || !planStatus.main_list || !planStatus.main_list.files || planStatus.main_list.files.length === 0"
              :title="mainFilesDragMode ? '点击退出拖拽排序模式' : '点击进入拖拽排序模式'">
              <el-icon v-if="mainFilesDragMode"><Check /></el-icon>
              <ion-icon v-else class="!w-3.5 !h-3.5" name="chevron-expand-sharp"></ion-icon>
            </el-button>
            <el-button
              type="danger"
              size="small"
              circle
              plain
              class="mr-1"
              @click="handleClearMainList"
              :disabled="!planStatus || !planStatus.main_list || !planStatus.main_list.files || planStatus.main_list.files.length === 0 || planLoading || mainFilesDragMode"
              title="清空列表">
              <el-icon><Delete /></el-icon>
            </el-button>
          </div>
        </div>
        
        <div class="flex-1 overflow-y-auto">
          <div v-if="planStatus.main_list && planStatus.main_list.files && planStatus.main_list.files.length > 0" class="space-y-1">
            <div
              v-for="(file, fileIndex) in planStatus.main_list.files"
              :key="'main-file-' + fileIndex"
              class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded"
              :class="{ 'bg-blue-50': fileIndex === planStatus.file_index && !planStatus.in_pre_files }"
              :style="{ cursor: mainFilesDragMode ? 'move' : 'default', userSelect: 'none' }"
              :draggable="mainFilesDragMode"
              @dragstart="handleMainFileDragStart($event, fileIndex)"
              @dragend="handleMainFileDragEnd($event)"
              @dragover.prevent="handleMainFileDragOver($event)"
              @dragleave="(e) => { if (e.currentTarget) { e.currentTarget.style.backgroundColor = ''; e.currentTarget.style.borderTop = ''; e.currentTarget.style.borderBottom = ''; } }"
              @drop.prevent="handleMainFileDrop($event, fileIndex)">
              <span class="text-xs text-gray-500 w-6">{{ fileIndex + 1 }}</span>
              <span
                class="flex-1 text-xs truncate"
                :class="{ 'text-blue-600': fileIndex === planStatus.file_index && !planStatus.in_pre_files }"
                :title="file.uri">
                {{ file.uri.split('/').pop() }}
              </span>
              <el-tag v-if="file.duration" type="info" size="small" class="w-12 text-center">
                {{ formatDuration(file.duration) }}
              </el-tag>
              <el-button
                type="plain"
                size="small"
                circle
                @click.stop="handleDeleteMainListFile(fileIndex)"
                :disabled="mainFilesDragMode"
                title="删除">
                <el-icon><Minus /></el-icon>
              </el-button>
            </div>
          </div>
          <div v-else class="text-xs text-gray-400 text-center py-2">正式列表为空</div>
        </div>
      </div>
    </div>

    <!-- 右侧：功能按钮 + 定时任务 + 设备配置 -->
    <div class="w-80 border rounded p-3 flex flex-col">
      <div v-if="planStatus" class="flex-1 overflow-y-auto space-y-4">
        <!-- 第一部分：功能按钮 -->
        <div class="border rounded p-3">
          <h4 class="text-sm font-semibold mb-3">功能操作</h4>
          <div class="flex flex-wrap gap-2">
            <el-button
              type="plain"
              size="small"
              circle
              @click="handlePlayPlan"
              :disabled="playing || !planStatus || (!planStatus.device_address && !planStatus.device?.address)"
              title="播放">
              <el-icon v-if="playing" size="12" class="animate-spin"><Loading /></el-icon>
              <span v-else>▶</span>
            </el-button>
            <el-button
              type="plain"
              size="small"
              circle
              @click="handleStopPlan"
              :disabled="stopping"
              title="停止">
              <el-icon v-if="stopping" size="12" class="animate-spin"><Loading /></el-icon>
              <span v-else>⏹</span>
            </el-button>
            <el-button
              type="plain"
              size="small"
              circle
              @click="handleStartEditPlanName(activePlanId)"
              title="改名">
              <el-icon><Edit /></el-icon>
            </el-button>
            <el-button
              type="plain"
              size="small"
              circle
              @click="handlePlanMenuCommand('copy', activePlanId)"
              title="复制">
              <el-icon><DocumentCopy /></el-icon>
            </el-button>
            <el-button
              v-if="planCollection.length > 1"
              type="plain"
              size="small"
              circle
              @click="handlePlanMenuCommand('delete', activePlanId)"
              title="删除">
              <el-icon><Delete /></el-icon>
            </el-button>
          </div>
        </div>

        <!-- 第二部分：定时任务配置 -->
        <div class="border rounded p-3">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-semibold">定时任务 (Cron)</h4>
            <el-switch
              :model-value="planStatus.schedule?.enabled === 1"
              @change="(val) => handleTogglePlanCronEnabled(val)"
              active-text="开启"
              inactive-text="关闭">
            </el-switch>
          </div>

          <div class="space-y-2">
            <div>
              <div class="text-xs text-gray-600 mb-1">Cron 表达式</div>
              <div class="flex items-center gap-2">
                <el-input
                  :model-value="planStatus.schedule?.cron || ''"
                  @input="(val) => handleUpdatePlanCron(val)"
                  placeholder="例如: 0 0 * * *"
                  size="small"
                  :disabled="planStatus.schedule?.enabled !== 1">
                </el-input>
                <el-button
                  type="info"
                  size="small"
                  @click="handleOpenCronBuilder"
                  :disabled="planStatus.schedule?.enabled !== 1">
                  助手
                </el-button>
              </div>
            </div>

            <div>
              <div class="text-xs text-gray-600 mb-1">持续时间（分钟）</div>
              <el-input-number
                :model-value="planStatus.schedule?.duration || 0"
                @change="handleUpdatePlanDuration"
                :min="0"
                :max="1440"
                :step="1"
                size="small"
                :disabled="planStatus.schedule?.enabled !== 1"
                class="w-full">
              </el-input-number>
              <div class="text-xs text-gray-500 mt-1">0表示不自动停止</div>
            </div>

            <div>
              <el-button
                type="success"
                size="small"
                @click="handlePreviewPlanCron"
                :disabled="!planStatus.schedule?.cron || planStatus.schedule?.enabled !== 1"
                class="w-full">
                预览执行时间
              </el-button>
            </div>
          </div>
        </div>

        <!-- 第三部分：设备配置 -->
        <div class="border rounded p-3">
          <h4 class="text-sm font-semibold mb-2">设备配置</h4>

          <div class="space-y-2">
            <div>
              <div class="text-xs text-gray-600 mb-1">设备类型</div>
              <el-select
                :model-value="planStatus.device?.type || planStatus.device_type || ''"
                @change="handleUpdatePlanDeviceType"
                placeholder="选择设备类型"
                size="small"
                class="w-full">
                <el-option label="蓝牙" value="bluetooth" />
                <el-option label="DLNA" value="dlna" />
                <el-option label="设备代理" value="agent" />
                <el-option label="小米设备" value="mi" />
              </el-select>
            </div>

            <div>
              <div class="text-xs text-gray-600 mb-1 flex items-center gap-2">
                <span>设备地址</span>
                <span v-if="planStatus.device?.name" class="text-xs text-gray-500">
                  {{ planStatus.device.name }}
                </span>
              </div>
              <div class="flex items-center gap-2">
                <el-input
                  :model-value="planStatus.device?.address || planStatus.device_address || ''"
                  @input="(val) => handleUpdatePlanDeviceAddress(val)"
                  placeholder="设备地址"
                  size="small"
                  class="flex-1">
                </el-input>
                <el-button
                  size="small"
                  type="danger"
                  plain
                  @click="handleUpdatePlanDeviceAddress('')"
                  :disabled="!planStatus.device?.address && !planStatus.device_address"
                  title="清空设备地址">
                  清空
                </el-button>
              </div>
            </div>
          </div>

          <!-- 设备列表 -->
          <div class="mt-3">
            <div class="flex items-center justify-between mb-2">
              <h5 class="text-xs font-semibold text-gray-700">设备列表</h5>
              <el-button
                type="primary"
                size="small"
                @click="handleOpenScanDialog">
                扫描设备
              </el-button>
            </div>
            <div class="space-y-2 max-h-[200px] overflow-y-auto" v-loading="loading">
              <div
                v-for="device in connectedDeviceList"
                :key="device.address"
                class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50">
                <div class="flex-1 min-w-0">
                  <div class="text-sm font-medium truncate">{{ device.name }}</div>
                  <div class="text-xs text-gray-500 truncate">{{ device.address }}</div>
                </div>
                <el-button
                  size="small"
                  type="primary"
                  @click="handleSelectDevice(device)"
                  :disabled="device.address === (planStatus.device?.address || planStatus.device_address)">
                  选择
                </el-button>
              </div>
              <div
                v-if="connectedDeviceList.length === 0"
                class="text-xs text-gray-400 text-center py-4">
                暂无设备
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-else class="flex-1 flex items-center justify-center text-sm text-gray-400">
        请先选择一个计划查看配置
      </div>
    </div>
  </div>
  <div v-else class="flex items-center justify-center h-[calc(100vh-200px)] text-sm text-gray-400">
    请先创建一个计划或选择一个计划查看详情
  </div>

  <!-- Cron 构建器对话框 -->
  <el-dialog v-model="cronBuilderVisible" title="Cron 表达式构建器" width="600px">
    <!-- Cron 构建器内容，参考 media.js 中的实现 -->
    <div class="space-y-4">
      <div>
        <div class="text-sm font-semibold mb-2">秒</div>
        <el-radio-group v-model="cronBuilder.second" @change="updateCronExpression">
          <el-radio label="*">每秒</el-radio>
          <el-radio label="0">0秒</el-radio>
          <el-radio label="custom">自定义</el-radio>
        </el-radio-group>
        <el-input
          v-if="cronBuilder.second === 'custom'"
          v-model="cronBuilder.secondCustom"
          @input="updateCronExpression"
          placeholder="例如: 0,30 或 */30"
          size="small"
          class="mt-2">
        </el-input>
      </div>
      <!-- 类似地添加分钟、小时、日、月、周 -->
      <div>
        <div class="text-sm font-semibold mb-2">分钟</div>
        <el-radio-group v-model="cronBuilder.minute" @change="updateCronExpression">
          <el-radio label="*">每分钟</el-radio>
          <el-radio label="0">0分</el-radio>
          <el-radio label="custom">自定义</el-radio>
        </el-radio-group>
        <el-input
          v-if="cronBuilder.minute === 'custom'"
          v-model="cronBuilder.minuteCustom"
          @input="updateCronExpression"
          placeholder="例如: 0,30 或 */30"
          size="small"
          class="mt-2">
        </el-input>
      </div>
      <div>
        <div class="text-sm font-semibold mb-2">小时</div>
        <el-radio-group v-model="cronBuilder.hour" @change="updateCronExpression">
          <el-radio label="*">每小时</el-radio>
          <el-radio label="0">0点</el-radio>
          <el-radio label="custom">自定义</el-radio>
        </el-radio-group>
        <el-input
          v-if="cronBuilder.hour === 'custom'"
          v-model="cronBuilder.hourCustom"
          @input="updateCronExpression"
          placeholder="例如: 8,12,18"
          size="small"
          class="mt-2">
        </el-input>
      </div>
      <div>
        <div class="text-sm font-semibold mb-2">日</div>
        <el-radio-group v-model="cronBuilder.day" @change="updateCronExpression">
          <el-radio label="*">每天</el-radio>
          <el-radio label="custom">自定义</el-radio>
        </el-radio-group>
        <el-input
          v-if="cronBuilder.day === 'custom'"
          v-model="cronBuilder.dayCustom"
          @input="updateCronExpression"
          placeholder="例如: 1,15"
          size="small"
          class="mt-2">
        </el-input>
      </div>
      <div>
        <div class="text-sm font-semibold mb-2">月</div>
        <el-radio-group v-model="cronBuilder.month" @change="updateCronExpression">
          <el-radio label="*">每月</el-radio>
          <el-radio label="custom">自定义</el-radio>
        </el-radio-group>
        <el-input
          v-if="cronBuilder.month === 'custom'"
          v-model="cronBuilder.monthCustom"
          @input="updateCronExpression"
          placeholder="例如: 1,6,12"
          size="small"
          class="mt-2">
        </el-input>
      </div>
      <div>
        <div class="text-sm font-semibold mb-2">周</div>
        <el-radio-group v-model="cronBuilder.weekday" @change="updateCronExpression">
          <el-radio label="*">每天</el-radio>
          <el-radio label="1-5">工作日</el-radio>
          <el-radio label="0,6">周末</el-radio>
          <el-radio label="custom">自定义</el-radio>
        </el-radio-group>
        <el-input
          v-if="cronBuilder.weekday === 'custom'"
          v-model="cronBuilder.weekdayCustom"
          @input="updateCronExpression"
          placeholder="例如: 1,3,5"
          size="small"
          class="mt-2">
        </el-input>
      </div>
      <div>
        <div class="text-sm font-semibold mb-2">生成的 Cron 表达式</div>
        <el-input
          v-model="cronBuilder.generated"
          readonly
          size="small">
        </el-input>
      </div>
    </div>
    <template #footer>
      <el-button @click="handleCloseCronBuilder">取消</el-button>
      <el-button type="primary" @click="handleApplyCronExpression">应用</el-button>
      <el-button type="success" @click="handlePreviewGeneratedCron">预览</el-button>
    </template>
  </el-dialog>

  <!-- Cron 预览对话框 -->
  <el-dialog v-model="cronPreviewVisible" title="Cron 执行时间预览" width="500px">
    <div class="space-y-2">
      <div
        v-for="(time, index) in cronPreviewTimes"
        :key="index"
        class="p-2 border rounded">
        {{ time }}
      </div>
    </div>
  </el-dialog>

  <!-- 文件浏览器对话框 -->
  <FileDialog
    :visible="fileBrowserDialogVisible"
    @update:visible="fileBrowserDialogVisible = $event"
    title="选择文件添加到计划"
    confirm-button-text="添加"
    :confirm-loading="planLoading"
    @confirm="handleFileSelected"
    @close="handleCloseFileBrowser">
  </FileDialog>

  <!-- 设备扫描对话框 -->
  <el-dialog v-model="scanDialogVisible" title="扫描设备" width="500px">
    <!-- 设备扫描内容 -->
    <div class="space-y-2" v-loading="loading">
      <div
        v-for="device in deviceList"
        :key="device.address"
        class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50">
        <div class="flex-1 min-w-0">
          <div class="text-sm font-medium truncate">{{ device.name }}</div>
          <div class="text-xs text-gray-500 truncate">{{ device.address }}</div>
        </div>
        <el-button
          size="small"
          type="primary"
          @click="handleSelectScannedDevice(device)">
          选择
        </el-button>
      </div>
    </div>
  </el-dialog>
</div>
