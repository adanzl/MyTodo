<el-dialog v-model="visible" width="810" :before-close="handleClose">
  <template #header>
    <div></div>
  </template>
  <div class="flex flex-col gap-4">
    <div>
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
          <h4 class="text-base font-semibold w-24">Agent设备</h4>
          <el-button
            type="primary"
            plain
            size="small"
            @click="handleRefreshAgentList"
            :loading="agentListLoading">
            <el-icon v-if="!agentListLoading"><Refresh /></el-icon>
            <span class="ml-1">刷新</span>
          </el-button>
        </div>
      </div>
      <el-table :data="agentList" stripe class="w-full" v-loading="agentListLoading" :height="200">
        <el-table-column prop="name" label="设备名称" min-width="150" />
        <el-table-column label="详情" min-width="250">
          <template #default="{ row }">
            <div class="flex flex-col gap-1">
              <div class="text-sm flex items-start">
                <span class="text-gray-600 inline-block w-12 flex-shrink-0">地址：</span>
                <span class="text-gray-800">{{ row.address }}</span>
              </div>
              <div class="text-sm flex items-start">
                <span class="text-gray-600 inline-block w-12 flex-shrink-0">ID：</span>
                <span class="text-gray-800">{{ row.agent_id }}</span>
              </div>
            </div>
          </template>
        </el-table-column>
        <el-table-column label="支持的操作" min-width="100">
          <template #default="{ row }">
            <el-tag
              v-for="action in row.actions"
              :key="action"
              size="small"
              type="info"
              class="mr-1">
              {{ action }}
            </el-tag>
            <span v-if="!row.actions || row.actions.length === 0" class="text-gray-400">无</span>
          </template>
        </el-table-column>
        <el-table-column label="状态/心跳" width="90">
          <template #default="{ row }">
            <div class="flex flex-col items-center gap-1">
              <el-tag :type="row.is_online ? 'success' : 'danger'" size="small">
                {{ row.is_online ? '在线' : '离线' }}
              </el-tag>
              <span class="text-xs text-gray-500"> {{ row.last_heartbeat_ago }}秒前 </span>
            </div>
          </template>
        </el-table-column>
        <el-table-column label="测试按钮" width="180">
          <template #default="{ row }">
            <div class="flex flex-col gap-1">
              <div class="flex gap-1 items-center">
                <el-icon class="!w-4 !h-5"><Cpu /></el-icon>
                <span class="text-[12px] mr-1 !w-4">B1</span>
                <el-button
                  v-for="i in 2"
                  :key="i"
                  size="small"
                  type="primary"
                  plain
                  @click="handleTestAgentButton(row.agent_id, `F${12 + i}`)"
                  :loading="row[`testing_F${12 + i}`]"
                  class="flex-1">
                  F{{ 12 + i }}
                </el-button>
              </div>
              <div class="flex gap-1 items-center">
                <el-icon class="!w-4 !h-5"><Cpu /></el-icon>
                <span class="text-[12px] mr-1 !w-4">B2</span>
                <el-button
                  v-for="i in 2"
                  :key="i + 2"
                  size="small"
                  type="primary"
                  plain
                  @click="handleTestAgentButton(row.agent_id, `F${12 + i + 2}`)"
                  :loading="row[`testing_F${12 + i + 2}`]"
                  class="flex-1">
                  F{{ 12 + i + 2 }}
                </el-button>
              </div>
              <div class="flex gap-1 items-center">
                <el-icon class="!w-4 !h-5"><Cpu /></el-icon>
                <span class="text-[12px] mr-1 !w-4">B3</span>
                <el-button
                  v-for="i in 2"
                  :key="i + 4"
                  size="small"
                  type="primary"
                  plain
                  @click="handleTestAgentButton(row.agent_id, `F${12 + i + 4}`)"
                  :loading="row[`testing_F${12 + i + 4}`]"
                  class="flex-1">
                  F{{ 12 + i + 4 }}
                </el-button>
              </div>
            </div>
          </template>
        </el-table-column>
        <template #empty>
          <div class="text-center text-gray-400 py-8">暂无设备，请等待设备注册</div>
        </template>
      </el-table>
    </div>
    <div>
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
          <h4 class="text-base font-semibold w-24">小米设备</h4>
          <el-button type="primary" plain size="small" @click="scanMiDevices" :loading="miScanning">
            <el-icon v-if="!miScanning"><Refresh /></el-icon>
            <span class="ml-1">扫描</span>
          </el-button>
        </div>
      </div>
      <el-table :data="miDeviceList" stripe class="w-full" v-loading="miScanning" :height="280">
        <el-table-column prop="name" label="设备名称" min-width="150" />
        <el-table-column label="详情" min-width="400">
          <template #default="{ row }">
            <div class="flex flex-col gap-1">
              <div class="text-sm flex items-start">
                <span class="text-gray-600 inline-block w-12 flex-shrink-0">ID：</span>
                <span class="text-gray-800">{{ row.deviceID || '-' }}</span>
              </div>
              <div class="text-sm flex items-start">
                <span class="text-gray-600 inline-block w-12 flex-shrink-0">地址：</span>
                <span class="text-gray-800 w-40">{{ row.mac || '-' }}</span>
                <span class="text-gray-600 inline-block w-12 flex-shrink-0">DTD：</span>
                <span class="text-gray-800 w-40">{{ row.miotDID || '-' }}</span>
              </div>
            </div>
          </template>
        </el-table-column>
        <el-table-column label="功能" min-width="200">
          <template #default="{ row }">
            <div class="flex flex-col gap-2">
              <div class="flex items-center gap-2">
                <span class="text-gray-600 inline-block w-11 flex-shrink-0">音量：</span>
                <span class="text-gray-800 w-5">
                  {{ row.volume !== undefined ? row.volume : '-' }}
                </span>
                <el-button
                  size="small"
                  type="info"
                  plain
                  circle
                  @click="getMiDeviceVolume(row)"
                  :loading="row._volumeRefreshing"
                  :disabled="row._volumeRefreshing || row._volumeChanging"
                  title="刷新音量"
                  class="p-0.5 !w-[17px] !h-[17px]">
                  <el-icon v-if="!row._volumeRefreshing"><Refresh /></el-icon>
                </el-button>
                <el-button
                  size="small"
                  class="!w-8 !h-6"
                  type="danger"
                  plain
                  @click="handleStopMiDevice(row)"
                  :disabled="row._stopping"
                  title="停止播放">
                  <el-icon v-if="row._stopping" class="animate-spin"> <Loading /> </el-icon>
                  <span v-else>⏹</span>
                </el-button>
              </div>
              <div class="flex items-center gap-2">
                <el-slider
                  :model-value="row.volume ?? 0"
                  @input="(val) => { row.volume = val; }"
                  @change="(val) => { setMiDeviceVolume(row, val); }"
                  :min="5"
                  :max="100"
                  :step="1"
                  :disabled="row._volumeChanging || row._volumeRefreshing || row.volume === undefined"
                  size="small"
                  class="flex-1 max-w-[200px]">
                </el-slider>
              </div>
            </div>
          </template>
        </el-table-column>
        <template #empty>
          <div class="text-center text-gray-400 py-8">暂无设备，点击"扫描设备"开始扫描</div>
        </template>
      </el-table>
    </div>
  </div>
</el-dialog>
