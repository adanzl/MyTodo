<div class="p-4">
  <!-- 已连接的设备列表 -->
  <div>
    <div class="flex items-center gap-2 mb-2">
      <h3 class="text-lg font-semibold">已连接的设备</h3>
      <el-button type="primary" @click="handleOpenScanDialog" size="small"> 扫描设备 </el-button>
    </div>
    <el-table :data="connectedDeviceList" stripe class="w-full" v-loading="loading" :height="200">
      <el-table-column prop="name" label="设备名称" min-width="150" />
      <el-table-column prop="address" label="地址" min-width="120" />
      <el-table-column label="状态" width="100">
        <template #default="{ row }">
          <el-tag type="success" v-if="row.connected">已连接</el-tag>
          <el-tag type="info" v-else>未连接</el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="100">
        <template #default="{ row }">
          <el-button
            size="small"
            type="danger"
            @click="handleDisconnectDevice(row)"
            :loading="row.disconnecting"
            :disabled="row.disconnecting">
            断开
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>

  <!-- 播放控制 -->
  <div class="mt-4">
    <div class="flex items-center gap-2">
      <el-button 
        type="success" 
        @click="handlePlayDirectory" 
        :loading="playing"
        :disabled="connectedDeviceList.length === 0">
        播放
      </el-button>
      <el-button type="danger" @click="handleStopPlayback" :loading="stopping">
        停止
      </el-button>
    </div>
  </div>

  <!-- Cron 表达式配置 -->
  <div class="mt-4">
    <div class="text-sm text-gray-600 mb-2">重复时间配置 (Cron 表达式)</div>
    <div class="flex items-center gap-2">
      <el-input
        v-model="cronExpression"
        placeholder="例如: 0 0 * * * (每天0点执行)"
        class="!w-[280px]"
        @input="updateNextRunTime">
        <template #prepend>Cron</template>
      </el-input>
      <el-button type="info" size="small" @click="handleOpenCronBuilder"> 帮助 </el-button>
      <el-button type="success" size="small" @click="handlePreviewCron" :disabled="!cronExpression">
        预览
      </el-button>
      <span v-if="nextRunTime" class="text-sm text-gray-500 ml-2">
        下次运行: {{ nextRunTime }}
      </span>
    </div>
  </div>

  <!-- Cron 可视化生成弹窗 -->
  <el-dialog
    v-model="cronBuilderVisible"
    title="Cron 表达式生成器"
    width="700"
    :before-close="handleCloseCronBuilder">
    <div class="space-y-4 m-4">
      <!-- 秒 -->
      <div>
        <div class="text-sm font-medium mb-2">秒 (0-59)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.second"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每秒钟</el-radio>
            <el-radio label="0" class="!w-[80px]">第0秒</el-radio>
            <el-radio label="30" class="!w-[80px]">第30秒</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.secondCustom"
            placeholder="例如: 0,30 或 */10"
            :disabled="cronBuilder.second !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 分 -->
      <div>
        <div class="text-sm font-medium mb-2">分 (0-59)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.minute"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每分钟</el-radio>
            <el-radio label="0" class="!w-[80px]">第0分</el-radio>
            <el-radio label="30" class="!w-[80px]">第30分</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.minuteCustom"
            placeholder="例如: 0,30 或 */15"
            :disabled="cronBuilder.minute !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 时 -->
      <div>
        <div class="text-sm font-medium mb-2">时 (0-23)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.hour"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每小时</el-radio>
            <el-radio label="0" class="!w-[80px]">0点</el-radio>
            <el-radio label="9" class="!w-[80px]">9点</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.hourCustom"
            placeholder="例如: 9,12,18 或 */2"
            :disabled="cronBuilder.hour !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 日 -->
      <div>
        <div class="text-sm font-medium mb-2">日 (1-31)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.day"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每天</el-radio>
            <el-radio label="1" class="!w-[80px]">每月1号</el-radio>
            <el-radio label="15" class="!w-[80px]">每月15号</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.dayCustom"
            placeholder="例如: 1,15 或 */5"
            :disabled="cronBuilder.day !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 月 -->
      <div>
        <div class="text-sm font-medium mb-2">月 (1-12)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.month"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每月</el-radio>
            <el-radio label="1" class="!w-[80px]">1月</el-radio>
            <el-radio label="6" class="!w-[80px]">6月</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.monthCustom"
            placeholder="例如: 1,6,12 或 */3"
            :disabled="cronBuilder.month !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 周 -->
      <div>
        <div class="text-sm font-medium mb-2">周 (0-7, 0和7表示周日)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.weekday"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每天</el-radio>
            <el-radio label="1-5" class="!w-[80px]">工作日</el-radio>
            <el-radio label="0,6" class="!w-[80px]">周末</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.weekdayCustom"
            placeholder="例如: 1,3,5 或 1-5"
            :disabled="cronBuilder.weekday !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 生成的 Cron 表达式 -->
      <div class="border-t pt-4">
        <div class="text-sm font-medium mb-2">生成的 Cron 表达式：</div>
        <el-input v-model="cronBuilder.generated" readonly class="mb-2"> </el-input>
        <div class="flex gap-2">
          <el-button type="primary" size="small" @click="handleApplyCronExpression">
            应用
          </el-button>
          <el-button type="info" size="small" @click="handlePreviewGeneratedCron">
            预览执行时间
          </el-button>
        </div>
      </div>

      <!-- 常用示例 -->
      <div class="border-t pt-4">
        <div class="text-sm font-medium mb-2">常用示例：</div>
        <div class="space-y-2">
          <div class="flex items-center gap-2 flex-wrap">
            <el-button size="small" @click="applyExample('0 0 * * *')"> 每天0点 </el-button>
            <el-button size="small" @click="applyExample('0 */30 * * *')"> 每30分钟 </el-button>
            <el-button size="small" @click="applyExample('0 0 9 * * 1-5')"> 工作日9点 </el-button>
            <el-button size="small" @click="applyExample('0 0 0 1 * *')"> 每月1号0点 </el-button>
          </div>
        </div>
      </div>
    </div>
  </el-dialog>

  <!-- Cron 预览弹窗 -->
  <el-dialog v-model="cronPreviewVisible" title="Cron 执行时间预览" width="500">
    <div v-if="cronPreviewTimes.length > 0">
      <div class="text-sm text-gray-600 mb-3">下3次执行时间：</div>
      <el-timeline>
        <el-timeline-item
          v-for="(time, index) in cronPreviewTimes"
          :key="index"
          :timestamp="time"
          placement="top">
          <div class="font-medium">第 {{ index + 1 }} 次执行</div>
        </el-timeline-item>
      </el-timeline>
    </div>
    <div v-else class="text-center text-gray-400 py-4">
      无法解析 Cron 表达式，请检查格式是否正确
    </div>
  </el-dialog>

  <!-- 目录选择 -->
  <div class="mt-4">
    <div class="flex items-center gap-2">
      <el-button type="primary" @click="handleOpenDirectoryDialog"> 选择目录 </el-button>
      <el-input v-model="selectedPath" placeholder="请选择目录" readonly class="flex-1"> </el-input>
    </div>
    <!-- 文件列表 -->
    <div v-if="selectedPath" class="mt-4">
      <div v-if="fileList.length > 0 || fileListLoading" class="text-sm text-gray-600 mb-2">
        文件列表 ({{ fileList.length }})
      </div>
      <div v-if="fileList.length > 0" class="border rounded p-3 max-h-60 overflow-y-auto">
        <div class="grid grid-cols-3 gap-2">
          <el-tag
            v-for="(file, index) in fileList"
            :key="index"
            size="small"
            type="info"
            :title="file"
            class="!pt-[2px]"
            style="
              text-align: left;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
              display: block;
              width: 100%;
            ">
            {{ file }}
          </el-tag>
        </div>
      </div>
      <div v-if="fileList.length === 0 && !fileListLoading" class="text-sm text-gray-400 mt-2">
        该目录下没有文件
      </div>
    </div>
  </div>

  <!-- 目录选择弹窗 -->
  <el-dialog
    v-model="directoryDialogVisible"
    title="选择目录"
    width="600"
    :before-close="handleCloseDirectoryDialog">
    <div class="m-4">
      <div class="flex items-center gap-2 mb-2">
        <el-input v-model="currentPath" placeholder="当前路径" readonly> </el-input>
        <el-button type="primary" @click="handleRefreshDirectory" :loading="directoryLoading">
          刷新
        </el-button>
      </div>
      <div class="flex items-center gap-2">
        <el-button size="small" @click="handleNavigateUp" :disabled="!canNavigateUp">
          上一级
        </el-button>
        <el-button size="small" @click="handleGoToHome"> 首页 </el-button>
      </div>
    </div>
    <el-table
      :data="directoryList"
      stripe
      class="w-full"
      v-loading="directoryLoading"
      :height="300"
      @row-click="handleDirectoryRowClick">
      <el-table-column prop="name" label="名称" min-width="200">
        <template #default="{ row }">
          <div class="flex items-center gap-2">
            <span v-if="row.isDirectory">📁</span>
            <span v-else>📄</span>
            <span>{{ row.name }}</span>
          </div>
        </template>
      </el-table-column>
      <el-table-column prop="size" label="大小" width="100">
        <template #default="{ row }">
          <span v-if="!row.isDirectory">{{ formatSize(row.size) }}</span>
          <span v-else>-</span>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="100">
        <template #default="{ row }">
          <el-button
            v-if="row.isDirectory"
            size="small"
            type="primary"
            @click.stop="handleSelectDirectory(row)">
            选择
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </el-dialog>

  <!-- 扫描设备弹窗 -->
  <el-dialog
    v-model="scanDialogVisible"
    title="扫描到的设备"
    width="800"
    :before-close="handleCloseScanDialog">
    <div class="mb-4">
      <el-button type="primary" @click="handleUpdateDeviceList" :loading="loading">
        刷新扫描
      </el-button>
    </div>
    <el-table :data="deviceList" stripe class="w-full" v-loading="loading" :height="400">
      <el-table-column prop="name" label="设备名称" min-width="150" />
      <el-table-column prop="address" label="地址" min-width="120" />
      <el-table-column prop="rssi" label="信号强度" width="100">
        <template #default="{ row }">
          <span>{{ row.rssi }} dBm</span>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="100">
        <template #default="{ row }">
          <el-button
            size="small"
            type="primary"
            @click="handleConnectDevice(row)"
            :loading="row.connecting"
            :disabled="row.connecting">
            连接
          </el-button>
        </template>
      </el-table-column>
    </el-table>
    <div v-if="deviceList.length === 0 && !loading" class="text-center text-gray-400 mt-4 py-8">
      暂无扫描到的设备，点击"刷新扫描"按钮开始扫描
    </div>
  </el-dialog>
</div>
