<div class="p-4">
  <!-- 已连接的设备列表 -->
  <div>
    <div class="flex items-center gap-2 mb-2">
      <h3 class="text-lg font-semibold">已配对的设备</h3>
      <el-button type="primary" @click="handleOpenScanDialog" size="small"> 扫描设备 </el-button>
    </div>
    <el-table :data="connectedDeviceList" stripe class="w-full" v-loading="loading" :height="200">
      <el-table-column prop="name" label="设备名称" min-width="150" />
      <el-table-column prop="address" label="地址" min-width="120" />
      <el-table-column label="状态" width="100">
        <template #default="{ row }">
          <el-tag type="success" v-if="row.connected">已连接</el-tag>
          <el-tag type="info" v-else>未连接</el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="100">
        <template #default="{ row }">
          <el-button
            size="small"
            type="danger"
            @click="handleDisconnectDevice(row)"
            :loading="row.disconnecting"
            :disabled="row.disconnecting || !row.connected">
            断开
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>

  <!-- 播放列表管理 -->
  <div class="mt-4">
    <div class="flex flex-col lg:flex-row gap-4">
      <div class="w-full lg:w-64 border rounded p-3">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-base font-semibold">播放列表</h3>
          <div class="flex items-center gap-1">
            <el-button 
              type="primary" 
              size="small" 
              plain
              @click="refreshPlaylistStatus" 
              :loading="playlistRefreshing">
              刷新
            </el-button>
            <el-button 
              type="success" 
              size="small" 
              @click="handleCreatePlaylist">
              新建
            </el-button>
          </div>
        </div>
        <div v-if="playlistCollection && playlistCollection.length > 0" class="space-y-2 max-h-80 overflow-y-auto pr-1">
          <div 
            v-for="playlist in playlistCollection" 
            :key="playlist.id"
            class="border rounded px-3 py-2 cursor-pointer flex items-center gap-2"
            :class="{ 'border-blue-500 bg-blue-50': playlist.id === activePlaylistId }"
            @click="handleSelectPlaylist(playlist.id)">
            <div class="flex-1 min-w-0">
              <div class="text-sm font-medium truncate">{{ playlist.name }}</div>
              <div class="text-xs text-gray-500">
                曲目: {{ (playlist.playlist && playlist.playlist.length) || 0 }}
              </div>
            </div>
            <el-button
              v-if="playlistCollection.length > 1"
              type="danger"
              size="small"
              circle
              @click.stop="handleDeletePlaylistGroup(playlist.id)">
              ×
            </el-button>
          </div>
        </div>
        <div v-else class="text-sm text-gray-400 text-center py-6">
          暂无播放列表，请点击“新建”创建
        </div>
      </div>

      <div class="flex-1 border rounded p-3 min-h-[220px]">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
          <div>
            <h3 class="text-lg font-semibold">
              {{ playlistStatus ? playlistStatus.name : "播放列表详情" }}
            </h3>
            <div class="text-sm text-gray-500" v-if="playlistStatus">
              共 {{ playlistStatus.total || 0 }} 首，
              当前索引: 
              {{ playlistStatus.current_index !== undefined ? playlistStatus.current_index + 1 : '-' }} / {{ playlistStatus.total || 0 }}
            </div>
            <div class="text-sm text-blue-600" v-if="getCurrentPlaylistFile()">
              正在播放: {{ getCurrentPlaylistFile() }}
            </div>
          </div>
          <div class="flex flex-wrap gap-2">
            <el-button 
              type="primary" 
              size="small" 
              @click="handleOpenFileBrowser"
              :disabled="!playlistStatus">
              添加文件
            </el-button>
            <el-button 
              type="success" 
              size="small" 
              @click="handlePlayPlaylist" 
              :loading="playing"
              :disabled="!playlistStatus || !playlistStatus.playlist || playlistStatus.playlist.length === 0">
              播放
            </el-button>
            <el-button 
              type="info" 
              size="small" 
              @click="handlePlayNext" 
              :loading="playing"
              :disabled="!playlistStatus || !playlistStatus.playlist || playlistStatus.playlist.length === 0">
              下一首
            </el-button>
            <el-button 
              type="danger" 
              size="small" 
              @click="handleStopPlaylist" 
              :loading="stopping">
              停止
            </el-button>
          </div>
        </div>

        <div v-if="playlistStatus">
          <div v-if="playlistStatus.playlist && playlistStatus.playlist.length > 0" class="max-h-60 overflow-y-auto border rounded p-2">
            <div 
              v-for="(file, index) in playlistStatus.playlist" 
              :key="index"
              class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded"
              :class="{ 'bg-blue-50': index === playlistStatus.current_index }">
              <span class="text-xs text-gray-500 w-8">{{ index + 1 }}</span>
              <span 
                class="flex-1 text-sm truncate"
                :class="{ 'font-semibold text-blue-600': index === playlistStatus.current_index }"
                :title="file">
                {{ file.split('/').pop() || file }}
              </span>
              <el-tag v-if="index === playlistStatus.current_index" type="success" size="small">
                当前
              </el-tag>
              <div class="flex items-center gap-1">
                <el-button
                  type="primary"
                  size="small"
                  circle
                  @click="handleMovePlaylistItemUp(index)"
                  :disabled="index === 0 || playlistLoading"
                  title="上移">
                  ↑
                </el-button>
                <el-button
                  type="primary"
                  size="small"
                  circle
                  @click="handleMovePlaylistItemDown(index)"
                  :disabled="index === playlistStatus.playlist.length - 1 || playlistLoading"
                  title="下移">
                  ↓
                </el-button>
                <el-button
                  type="danger"
                  size="small"
                  circle
                  @click="handleDeletePlaylistItem(index)"
                  :disabled="playlistLoading"
                  title="删除">
                  ×
                </el-button>
              </div>
            </div>
          </div>
          <div v-else class="text-sm text-gray-400">
            当前播放列表为空，点击“添加文件”开始构建播放列表
          </div>
        </div>
        <div v-else class="text-sm text-gray-400">
          请先在左侧选择一个播放列表查看详情
        </div>
      </div>
    </div>
  </div>

  <!-- Cron 表达式配置 -->
  <div class="mt-4">
    <div class="flex items-center justify-between mb-2">
      <div class="text-sm text-gray-600">重复时间配置 (Cron 表达式)</div>
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600">启用定时任务</span>
        <el-switch
          v-model="cronEnabled"
          @change="handleToggleCronEnabled"
          active-text="开启"
          inactive-text="关闭">
        </el-switch>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <el-input
        v-model="cronExpression"
        placeholder="例如: 0 0 * * * (每天0点执行)"
        class="!w-[280px]"
        :disabled="!cronEnabled"
        @input="updateNextRunTime">
        <template #prepend>Cron</template>
      </el-input>
      <el-button type="info" size="small" @click="handleOpenCronBuilder" :disabled="!cronEnabled"> 帮助 </el-button>
      <el-button type="success" size="small" @click="handlePreviewCron" :disabled="!cronExpression || !cronEnabled">
        预览
      </el-button>
      <el-button type="primary" size="small" @click="saveBluetoothConfig" :disabled="!cronEnabled">
        保存
      </el-button>
      <span v-if="nextRunTime && cronEnabled" class="text-sm text-gray-500 ml-2">
        下次运行: {{ nextRunTime }}
      </span>
    </div>
    <div class="flex items-center gap-2 mt-2">
      <span class="text-sm text-gray-600 w-20">持续时间:</span>
      <el-input-number
        v-model="cronDuration"
        :min="0"
        :max="1440"
        :step="1"
        :disabled="!cronEnabled"
        class="!w-[200px]">
      </el-input-number>
      <span class="text-sm text-gray-500">分钟（0表示不自动停止）</span>
      <span v-if="cronDuration > 0" class="text-sm text-blue-600">
        ({{ formatDurationMinutes(cronDuration) }})
      </span>
      <el-button type="primary" size="small" @click="saveBluetoothConfig" :disabled="!cronEnabled">
        保存
      </el-button>
    </div>
  </div>

  <!-- Cron 可视化生成弹窗 -->
  <el-dialog
    v-model="cronBuilderVisible"
    title="Cron 表达式生成器"
    width="700"
    :before-close="handleCloseCronBuilder">
    <div class="space-y-4 m-4">
      <!-- 秒 -->
      <div>
        <div class="text-sm font-medium mb-2">秒 (0-59)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.second"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每秒钟</el-radio>
            <el-radio label="0" class="!w-[80px]">第0秒</el-radio>
            <el-radio label="30" class="!w-[80px]">第30秒</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.secondCustom"
            placeholder="例如: 0,30 或 */10"
            :disabled="cronBuilder.second !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 分 -->
      <div>
        <div class="text-sm font-medium mb-2">分 (0-59)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.minute"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每分钟</el-radio>
            <el-radio label="0" class="!w-[80px]">第0分</el-radio>
            <el-radio label="30" class="!w-[80px]">第30分</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.minuteCustom"
            placeholder="例如: 0,30 或 */15"
            :disabled="cronBuilder.minute !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 时 -->
      <div>
        <div class="text-sm font-medium mb-2">时 (0-23)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.hour"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每小时</el-radio>
            <el-radio label="0" class="!w-[80px]">0点</el-radio>
            <el-radio label="9" class="!w-[80px]">9点</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.hourCustom"
            placeholder="例如: 9,12,18 或 */2"
            :disabled="cronBuilder.hour !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 日 -->
      <div>
        <div class="text-sm font-medium mb-2">日 (1-31)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.day"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每天</el-radio>
            <el-radio label="1" class="!w-[80px]">每月1号</el-radio>
            <el-radio label="15" class="!w-[80px]">每月15号</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.dayCustom"
            placeholder="例如: 1,15 或 */5"
            :disabled="cronBuilder.day !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 月 -->
      <div>
        <div class="text-sm font-medium mb-2">月 (1-12)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.month"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每月</el-radio>
            <el-radio label="1" class="!w-[80px]">1月</el-radio>
            <el-radio label="6" class="!w-[80px]">6月</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.monthCustom"
            placeholder="例如: 1,6,12 或 */3"
            :disabled="cronBuilder.month !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 周 -->
      <div>
        <div class="text-sm font-medium mb-2">周 (0-7, 0和7表示周日)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.weekday"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每天</el-radio>
            <el-radio label="1-5" class="!w-[80px]">工作日</el-radio>
            <el-radio label="0,6" class="!w-[80px]">周末</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.weekdayCustom"
            placeholder="例如: 1,3,5 或 1-5"
            :disabled="cronBuilder.weekday !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 生成的 Cron 表达式 -->
      <div class="border-t pt-4">
        <div class="text-sm font-medium mb-2">生成的 Cron 表达式：</div>
        <el-input v-model="cronBuilder.generated" readonly class="mb-2"> </el-input>
        <div class="flex gap-2">
          <el-button type="primary" size="small" @click="handleApplyCronExpression">
            应用
          </el-button>
          <el-button type="info" size="small" @click="handlePreviewGeneratedCron">
            预览执行时间
          </el-button>
        </div>
      </div>

      <!-- 常用示例 -->
      <div class="border-t pt-4">
        <div class="text-sm font-medium mb-2">常用示例：</div>
        <div class="space-y-2">
          <div class="flex items-center gap-2 flex-wrap">
            <el-button size="small" @click="applyExample('0 0 * * *')"> 每天0点 </el-button>
            <el-button size="small" @click="applyExample('0 */30 * * *')"> 每30分钟 </el-button>
            <el-button size="small" @click="applyExample('0 0 9 * * 1-5')"> 工作日9点 </el-button>
            <el-button size="small" @click="applyExample('0 0 0 1 * *')"> 每月1号0点 </el-button>
          </div>
        </div>
      </div>
    </div>
  </el-dialog>

  <!-- Cron 预览弹窗 -->
  <el-dialog v-model="cronPreviewVisible" title="Cron 执行时间预览" width="500">
    <div v-if="cronPreviewTimes.length > 0">
      <div class="text-sm text-gray-600 mb-3">下5次执行时间：</div>
      <el-timeline>
        <el-timeline-item
          v-for="(time, index) in cronPreviewTimes"
          :key="index"
          :timestamp="time"
          placement="top">
          <div class="font-medium">第 {{ index + 1 }} 次执行</div>
        </el-timeline-item>
      </el-timeline>
    </div>
    <div v-else class="text-center text-gray-400 py-4">
      无法解析 Cron 表达式，请检查格式是否正确
    </div>
  </el-dialog>

  <!-- 扫描设备弹窗 -->
  <el-dialog
    v-model="scanDialogVisible"
    title="扫描到的设备"
    width="800"
    :before-close="handleCloseScanDialog">
    <div class="mb-4">
      <el-button type="primary" @click="handleUpdateDeviceList" :loading="loading">
        刷新扫描
      </el-button>
    </div>
    <el-table :data="deviceList" stripe class="w-full" v-loading="loading" :height="400">
      <el-table-column prop="name" label="设备名称" min-width="150" />
      <el-table-column prop="address" label="地址" min-width="120" />
      <el-table-column prop="rssi" label="信号强度" width="100">
        <template #default="{ row }">
          <span>{{ row.rssi }} dBm</span>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="100">
        <template #default="{ row }">
          <el-button
            size="small"
            type="primary"
            @click="handleConnectDevice(row)"
            :loading="row.connecting"
            :disabled="row.connecting">
            连接
          </el-button>
        </template>
      </el-table-column>
    </el-table>
    <div v-if="deviceList.length === 0 && !loading" class="text-center text-gray-400 mt-4 py-8">
      暂无扫描到的设备，点击"刷新扫描"按钮开始扫描
    </div>
  </el-dialog>

  <!-- 文件浏览对话框 -->
  <el-dialog
    v-model="fileBrowserDialogVisible"
    title="选择文件添加到播放列表"
    width="800"
    :before-close="handleCloseFileBrowser">
    <div class="m-4">
      <div class="flex items-center gap-2 mb-2">
        <el-input v-model="fileBrowserPath" placeholder="当前路径" readonly> </el-input>
        <el-button type="primary" @click="handleRefreshFileBrowser" :loading="fileBrowserLoading">
          刷新
        </el-button>
      </div>
      <div class="flex items-center gap-2 mb-2">
        <el-button size="small" @click="handleFileBrowserNavigateUp" :disabled="!fileBrowserCanNavigateUp">
          上一级
        </el-button>
        <el-button size="small" @click="handleFileBrowserGoToHome"> 首页 </el-button>
        <span v-if="selectedFiles.length > 0" class="text-sm text-blue-600 ml-2">
          已选择 {{ selectedFiles.length }} 个文件
        </span>
      </div>
    </div>
    <el-table
      :data="fileBrowserList"
      stripe
      class="w-full"
      v-loading="fileBrowserLoading"
      :height="400"
      @row-click="handleFileBrowserRowClick">
      <el-table-column type="selection" width="55" :selectable="(row) => !row.isDirectory">
        <template #default="{ row }">
          <el-checkbox 
            v-if="!row.isDirectory"
            :model-value="isFileSelected(row)"
            @change="handleToggleFileSelection(row)"
            @click.stop>
          </el-checkbox>
        </template>
      </el-table-column>
      <el-table-column prop="name" label="名称" min-width="200">
        <template #default="{ row }">
          <div class="flex items-center gap-2">
            <span v-if="row.isDirectory">📁</span>
            <span v-else>📄</span>
            <span>{{ row.name }}</span>
          </div>
        </template>
      </el-table-column>
      <el-table-column prop="size" label="大小" width="100">
        <template #default="{ row }">
          <span v-if="!row.isDirectory">{{ formatSize(row.size) }}</span>
          <span v-else>-</span>
        </template>
      </el-table-column>
      <el-table-column label="状态" width="100">
        <template #default="{ row }">
          <el-tag v-if="!row.isDirectory && isFileSelected(row)" type="success" size="small">
            已选择
          </el-tag>
        </template>
      </el-table-column>
    </el-table>
    <template #footer>
      <div class="flex items-center justify-between">
        <span class="text-sm text-gray-500">
          提示：点击文件可切换选择状态，双击目录可进入
        </span>
        <div class="flex gap-2">
          <el-button @click="handleCloseFileBrowser">取消</el-button>
          <el-button 
            type="primary" 
            @click="handleAddFilesToPlaylist" 
            :loading="playlistLoading"
            :disabled="selectedFiles.length === 0">
            添加到播放列表 ({{ selectedFiles.length }})
          </el-button>
        </div>
      </div>
    </template>
  </el-dialog>
</div>
