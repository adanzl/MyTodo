<div class="p-4">
  <!-- 3列布局：播放列表 | 文件列表 | 配置详情 -->
  <div class="flex gap-4 h-[calc(100vh-150px)]">
    <!-- 第一列：播放列表列表 -->
    <div class="w-64 border rounded p-3 flex flex-col">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-semibold">播放列表</h3>
        <div class="flex items-center gap-1">
          <el-button
            type="primary"
            size="small"
            plain
            @click="refreshPlaylistStatus"
            :loading="playlistRefreshing">
            刷新
          </el-button>
          <el-button type="success" size="small" @click="handleCreatePlaylist"> 新建 </el-button>
        </div>
      </div>
      <div
        v-if="playlistCollection && playlistCollection.length > 0"
        class="flex-1 overflow-y-auto space-y-2 pr-1">
        <div
          v-for="playlist in playlistCollection"
          :key="playlist.id"
          class="border rounded px-3 py-2 cursor-pointer hover:bg-gray-50 group min-h-[60px] flex flex-col justify-between"
          :class="{ 'border-blue-500 bg-blue-50': playlist.id === activePlaylistId }"
          @click="handleSelectPlaylist(playlist.id)">
          <!-- 第一行：名称、曲目数量、功能按钮 -->
          <div class="flex items-center justify-between gap-2">
            <div class="text-sm font-medium truncate flex-1 min-w-0">{{ playlist.name }}</div>
            <div class="flex items-center gap-2 flex-shrink-0">
              <span class="text-xs text-gray-500 whitespace-nowrap">
                曲目: {{ (playlist.playlist && playlist.playlist.length) || 0 }}
              </span>
              <div
                class="flex items-center justify-center">
                <el-dropdown
                  trigger="click"
                  @command="(command) => handlePlaylistMenuCommand(command, playlist.id)"
                  @click.stop>
                  <el-button
                    type="default"
                    size="small"
                    plain
                    circle
                    class="!w-5 !h-5 !min-w-5 !p-0 text-xs"
                    title="更多">
                    <span style="font-size: 16px; line-height: 1;" class="mb-1">»</span>
                  </el-button>
                  <template #dropdown>
                    <el-dropdown-menu>
                      <el-dropdown-item command="copy">
                        <span>复制</span>
                      </el-dropdown-item>
                      <el-dropdown-item
                        v-if="playlistCollection.length > 1"
                        command="delete"
                        divided>
                        <span style="color: #f56c6c">删除</span>
                      </el-dropdown-item>
                    </el-dropdown-menu>
                  </template>
                </el-dropdown>
              </div>
            </div>
          </div>
          <!-- 第二行：下次运行时间（始终存在，保持固定高度） -->
          <div class="text-[10px] text-blue-600 min-h-[14px]">
            <span v-if="getPlaylistNextCronTime(playlist)">
              下次运行: {{ getPlaylistNextCronTime(playlist) }}
            </span>
            <span v-else class="invisible">占位</span>
          </div>
        </div>
      </div>
      <div v-else class="flex-1 flex items-center justify-center text-sm text-gray-400">
        暂无播放列表，请点击"新建"创建
      </div>
    </div>

    <!-- 第二列：文件列表 -->
    <div class="flex-1 border rounded p-3 flex flex-col">
      <div class="flex items-center justify-between mb-3">
        <div class="flex-1 min-w-0">
          <div v-if="playlistStatus" class="flex items-center gap-2 mb-1">
            <div
              v-if="editingPlaylistId !== activePlaylistId"
              class="flex items-center gap-2 flex-1 min-w-0">
              <h3 class="text-lg font-semibold truncate">{{ playlistStatus.name }}</h3>
              <el-button
                type="primary"
                size="small"
                circle
                @click="handleStartEditPlaylistName(activePlaylistId)"
                title="编辑名称">
                ✎
              </el-button>
            </div>
            <div v-else class="flex items-center gap-2 flex-1 min-w-0">
              <el-input
                :model-value="editingPlaylistName"
                @input="(val) => editingPlaylistName = val"
                @blur="handleSavePlaylistName(activePlaylistId)"
                @keyup.enter="handleSavePlaylistName(activePlaylistId)"
                @keyup.esc="handleCancelEditPlaylistName"
                size="small"
                class="flex-1"
                :data-playlist-id="activePlaylistId"
                ref="editPlaylistNameInput">
              </el-input>
            </div>
          </div>
          <div v-else>
            <h3 class="text-lg font-semibold">播放列表文件</h3>
          </div>
          <div class="text-sm text-gray-500" v-if="playlistStatus">
            共 {{ playlistStatus.total || 0 }} 首， 当前: {{ playlistStatus.current_index !==
            undefined ? playlistStatus.current_index + 1 : '-' }} / {{ playlistStatus.total || 0
            }}
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <el-button
            type="primary"
            size="small"
            @click="handleOpenFileBrowser"
            :disabled="!playlistStatus">
            添加文件
          </el-button>
          <el-button
            type="success"
            size="small"
            circle
            @click="handlePlayPlaylist"
            :loading="playing"
            :disabled="!playlistStatus || !playlistStatus.playlist || playlistStatus.playlist.length === 0 || !!playlistStatus.isPlaying"
            title="播放">
            <span v-if="!playing">▶</span>
          </el-button>
          <el-button
            type="info"
            size="small"
            circle
            @click="handlePlayNext"
            :loading="playing"
            :disabled="!playlistStatus || !playlistStatus.playlist || playlistStatus.playlist.length === 0"
            title="下一首">
            <span v-if="!playing">⏭</span>
          </el-button>
          <el-button
            type="danger"
            size="small"
            circle
            @click="handleStopPlaylist"
            :loading="stopping"
            title="停止">
            <span v-if="!stopping">⏹</span>
          </el-button>
          <el-button
            type="plain"
            size="small"
            circle
            @click="handleClearPlaylist"
            :disabled="!playlistStatus || !playlistStatus.playlist || playlistStatus.playlist.length === 0 || playlistLoading"
            title="清空列表">
            🗑️
          </el-button>
        </div>
      </div>

      <div v-if="playlistStatus" class="flex-1 overflow-y-auto">
        <!-- pre_files 列表 -->
        <div class="border rounded p-2 mb-2">
          <div class="flex items-center justify-between mb-2">
            <div class="text-xs font-semibold text-gray-600">前置文件（播放时优先播放）</div>
            <el-button
              type="primary"
              size="small"
              @click="handleOpenFileBrowserForPreFiles"
              :disabled="!playlistStatus">
              +
            </el-button>
          </div>
          <div
            v-if="playlistStatus.pre_files && playlistStatus.pre_files.length > 0">
            <div
              v-for="(file, index) in playlistStatus.pre_files"
              :key="'pre-' + index"
              class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded">
              <span class="text-xs text-gray-500 w-8">{{ index + 1 }}</span>
              <span
                class="flex-1 text-sm truncate"
                :title="file.uri">
                {{ file.uri.split('/').pop() }} 
              </span>
              <div class="flex items-center gap-1">
                <el-button
                  type="primary"
                  size="small"
                  circle
                  @click="handleMovePreFileUp(index)"
                  :disabled="index === 0 || playlistLoading"
                  title="上移">
                  ↑
                </el-button>
                <el-button
                  type="primary"
                  size="small"
                  circle
                  @click="handleMovePreFileDown(index)"
                  :disabled="index === playlistStatus.pre_files.length - 1 || playlistLoading"
                  title="下移">
                  ↓
                </el-button>
                <el-button
                  type="danger"
                  size="small"
                  circle
                  @click="handleDeletePreFile(index)"
                  :disabled="playlistLoading"
                  title="删除">
                  ×
                </el-button>
              </div>
            </div>
          </div>
          <div v-else class="text-sm text-gray-400 text-center py-1">
            前置文件列表为空
          </div>
        </div>
        
        <!-- files 列表 -->
        <div
          v-if="playlistStatus.playlist && playlistStatus.playlist.length > 0"
          class="border rounded p-2">
          <div
            v-for="(file, index) in playlistStatus.playlist"
            :key="index"
            class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded"
            :class="{ 'bg-blue-50': index === playlistStatus.current_index }">
            <span class="text-xs text-gray-500 w-8">{{ index + 1 }}</span>
            <span
              class="flex-1 text-sm truncate"
              :class="{ 'text-blue-600': index === playlistStatus.current_index }"
              :title="file.uri">
              {{ file.uri.split('/').pop() }} 
            </span>
            <el-tag v-if="index === playlistStatus.current_index" type="success" size="small">
              当前
            </el-tag>
            <div class="flex items-center gap-1">
              <el-button
                type="primary"
                size="small"
                circle
                @click="handleMovePlaylistItemUp(index)"
                :disabled="index === 0 || playlistLoading"
                title="上移">
                ↑
              </el-button>
              <el-button
                type="primary"
                size="small"
                circle
                @click="handleMovePlaylistItemDown(index)"
                :disabled="index === playlistStatus.playlist.length - 1 || playlistLoading"
                title="下移">
                ↓
              </el-button>
              <el-button
                type="danger"
                size="small"
                circle
                @click="handleDeletePlaylistItem(index)"
                :disabled="playlistLoading"
                title="删除">
                ×
              </el-button>
              <el-button
                type="success"
                size="small"
                circle
                @click="handleCopyPlaylistItem(index)"
                :disabled="playlistLoading"
                title="复制到末尾">
                📋
              </el-button>
            </div>
          </div>
        </div>
        <div v-else-if="(!playlistStatus.pre_files || playlistStatus.pre_files.length === 0)" class="text-sm text-gray-400 text-center py-8">
          当前播放列表为空，点击"添加文件"开始构建播放列表
        </div>
      </div>
      <div v-else class="flex-1 flex items-center justify-center text-sm text-gray-400">
        请先在左侧选择一个播放列表查看详情
      </div>
    </div>

    <!-- 第三列：配置详情（Cron + 设备） -->
    <div class="w-80 border rounded p-3 flex flex-col">
      <h3 class="text-lg font-semibold mb-3">配置详情</h3>

      <div v-if="playlistStatus" class="flex-1 overflow-y-auto space-y-4">
        <!-- Cron 定时任务配置 -->
        <div class="border rounded p-3">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-semibold">定时任务 (Cron)</h4>
            <el-switch
              :model-value="playlistStatus.schedule?.enabled === 1"
              @change="(val) => handleTogglePlaylistCronEnabled(val)"
              active-text="开启"
              inactive-text="关闭">
            </el-switch>
          </div>

          <div class="space-y-2">
            <div>
              <div class="text-xs text-gray-600 mb-1">Cron 表达式</div>
              <div class="flex items-center gap-2">
                <el-input
                  :model-value="playlistStatus.schedule?.cron || ''"
                  @input="(val) => handleUpdatePlaylistCron(val)"
                  placeholder="例如: 0 0 * * *"
                  size="small"
                  :disabled="playlistStatus.schedule?.enabled !== 1">
                </el-input>
                <el-button
                  type="info"
                  size="small"
                  @click="handleOpenCronBuilder"
                  :disabled="playlistStatus.schedule?.enabled !== 1"
                  >助手</el-button
                >
              </div>
            </div>
            
            <div>
              <div class="text-xs text-gray-600 mb-1">持续时间（分钟）</div>
              <el-input-number
                :model-value="playlistStatus.schedule?.duration || 0"
                @change="handleUpdatePlaylistDuration"
                :min="0"
                :max="1440"
                :step="1"
                size="small"
                :disabled="playlistStatus.schedule?.enabled !== 1"
                class="w-full">
              </el-input-number>
              <div class="text-xs text-gray-500 mt-1">
                0表示不自动停止
                <span v-if="playlistStatus.schedule?.duration > 0">
                  ({{ formatDurationMinutes(playlistStatus.schedule.duration) }})
                </span>
              </div>
            </div>
            
            <div v-if="playlistStatus.schedule?.cron && playlistStatus.schedule?.enabled === 1">
              <el-button
                type="success"
                size="small"
                @click="handlePreviewPlaylistCron"
                class="w-full">
                预览执行时间
              </el-button>
            </div>
          </div>
        </div>

        <!-- 设备配置 -->
        <div class="border rounded p-3">
          <h4 class="text-sm font-semibold mb-2">设备配置</h4>

          <div class="space-y-2">
            <div>
              <div class="text-xs text-gray-600 mb-1">设备类型</div>
              <el-select
                :model-value="playlistStatus.device?.type || playlistStatus.device_type || ''"
                @change="handleUpdatePlaylistDeviceType"
                placeholder="选择设备类型"
                size="small"
                class="w-full">
                <el-option label="蓝牙" value="bluetooth" />
                <el-option label="DLNA" value="dlna" />
                <el-option label="设备代理" value="agent" />
                <el-option label="小米设备" value="mi" />
              </el-select>
            </div>

            <div>
              <div class="text-xs text-gray-600 mb-1 flex items-center gap-2">
                <span>设备地址</span>
                <span v-if="playlistStatus.device?.name" class="text-xs text-gray-500">
                  {{ playlistStatus.device.name }}
                </span>
              </div>
              <div class="flex items-center gap-2">
                <el-input
                  :model-value="playlistStatus.device?.address || playlistStatus.device_address || ''"
                  @input="(val) => handleUpdatePlaylistDeviceAddress(val)"
                  placeholder="设备地址"
                  size="small"
                  class="flex-1">
                </el-input>
                <el-button
                  size="small"
                  type="danger"
                  plain
                  @click="handleUpdatePlaylistDeviceAddress('')"
                  :disabled="!playlistStatus.device?.address && !playlistStatus.device_address"
                  title="清空设备地址">
                  清空
                </el-button>
              </div>
            </div>
          </div>

          <!-- 设备列表 -->
          <div class="mt-3">
            <div class="flex items-center justify-between mb-2">
              <h5 class="text-xs font-semibold text-gray-700">
                <span
                  v-if="playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent' || playlistStatus.device?.type === 'bluetooth' || playlistStatus.device_type === 'bluetooth'">
                  已配对的设备
                </span>
                <span
                  v-else-if="playlistStatus.device?.type === 'dlna' || playlistStatus.device_type === 'dlna'">
                  DLNA 设备
                </span>
                <span
                  v-else-if="playlistStatus.device?.type === 'mi' || playlistStatus.device_type === 'mi'">
                  小米设备
                </span>
                <span v-else>设备列表</span>
              </h5>
              <el-button
                v-if="playlistStatus.device?.type === 'dlna' || playlistStatus.device_type === 'dlna'"
                type="primary"
                size="small"
                @click="scanDlnaDevices"
                :loading="dlnaScanning">
                扫描设备
              </el-button>
              <el-button
                v-if="playlistStatus.device?.type === 'mi' || playlistStatus.device_type === 'mi'"
                type="primary"
                size="small"
                @click="scanMiDevices"
                :loading="miScanning">
                扫描设备
              </el-button>
              <el-button
                v-if="playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent' || playlistStatus.device?.type === 'bluetooth' || playlistStatus.device_type === 'bluetooth'"
                type="primary"
                size="small"
                @click="handleOpenScanDialog">
                扫描设备
              </el-button>
            </div>

            <!-- 设备代理类型：显示已配对设备 -->
            <div
              v-if="playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent' || playlistStatus.device?.type === 'bluetooth' || playlistStatus.device_type === 'bluetooth'">
              <div class="space-y-2 max-h-[200px] overflow-y-auto" v-loading="loading">
                <div
                  v-for="device in connectedDeviceList"
                  :key="device.address"
                  class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50">
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">{{ device.name }}</div>
                    <div class="text-xs text-gray-500 truncate">{{ device.address }}</div>
                  </div>
                  <div class="flex-shrink-0">
                    <el-button
                      size="small"
                      type="primary"
                      @click="(playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent') ? handleSelectAgentDevice(device) : handleSelectBluetoothDevice(device.address)"
                      :disabled="device.address === (playlistStatus.device?.address || playlistStatus.device_address)">
                      选择
                    </el-button>
                  </div>
                </div>
                <div
                  v-if="connectedDeviceList.length === 0"
                  class="text-xs text-gray-400 text-center py-4">
                  暂无设备
                </div>
              </div>
            </div>

            <!-- DLNA 类型：显示 DLNA 设备 -->
            <div
              v-else-if="playlistStatus.device?.type === 'dlna' || playlistStatus.device_type === 'dlna'">
              <div class="space-y-2 max-h-[200px] overflow-y-auto" v-loading="dlnaScanning">
                <div
                  v-for="device in dlnaDeviceList"
                  :key="device.location"
                  class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50">
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">{{ device.name }}</div>
                    <div class="text-xs text-gray-500 truncate" :title="device.location">
                      {{ device.location }}
                    </div>
                  </div>
                  <div class="flex-shrink-0">
                    <el-button
                      size="small"
                      type="primary"
                      @click="handleUpdatePlaylistDeviceAddress(device.location, device.name)"
                      :disabled="device.location === (playlistStatus.device?.address || playlistStatus.device_address)">
                      选择
                    </el-button>
                  </div>
                </div>
                <div
                  v-if="dlnaDeviceList.length === 0 && !dlnaScanning"
                  class="text-xs text-gray-400 text-center py-4">
                  暂无设备，点击"扫描设备"开始扫描
                </div>
              </div>
            </div>

            <!-- 小米设备类型：显示小米设备 -->
            <div
              v-else-if="playlistStatus.device?.type === 'mi' || playlistStatus.device_type === 'mi'">
              <div class="space-y-2 max-h-[200px] overflow-y-auto" v-loading="miScanning">
                <div
                  v-for="device in miDeviceList"
                  :key="device.deviceID || device.address"
                  class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50">
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">{{ device.name }}</div>
                    <div class="text-xs text-gray-500 truncate" :title="device.deviceID || device.address">
                      {{ device.deviceID || device.address }}
                    </div>
                  </div>
                  <div class="flex-shrink-0">
                    <el-button
                      size="small"
                      type="primary"
                      @click="handleSelectMiDevice(device)"
                      :disabled="(device.deviceID || device.address) === (playlistStatus.device?.address || playlistStatus.device_address)">
                      选择
                    </el-button>
                  </div>
                </div>
                <div
                  v-if="miDeviceList.length === 0 && !miScanning"
                  class="text-xs text-gray-400 text-center py-4">
                  暂无设备，点击"扫描设备"开始扫描
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div v-else class="flex-1 flex items-center justify-center text-sm text-gray-400">
        请先选择一个播放列表
      </div>
    </div>
  </div>

  <!-- Cron 可视化生成弹窗 -->
  <el-dialog
    v-model="cronBuilderVisible"
    title="Cron 表达式生成器"
    width="700"
    :before-close="handleCloseCronBuilder">
    <div class="space-y-4 m-4">
      <!-- 秒 -->
      <div>
        <div class="text-sm font-medium mb-2">秒 (0-59)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.second"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每秒钟</el-radio>
            <el-radio label="0" class="!w-[80px]">第0秒</el-radio>
            <el-radio label="30" class="!w-[80px]">第30秒</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.secondCustom"
            placeholder="例如: 0,30 或 */10"
            :disabled="cronBuilder.second !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 分 -->
      <div>
        <div class="text-sm font-medium mb-2">分 (0-59)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.minute"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每分钟</el-radio>
            <el-radio label="0" class="!w-[80px]">第0分</el-radio>
            <el-radio label="30" class="!w-[80px]">第30分</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.minuteCustom"
            placeholder="例如: 0,30 或 */15"
            :disabled="cronBuilder.minute !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 时 -->
      <div>
        <div class="text-sm font-medium mb-2">时 (0-23)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.hour"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每小时</el-radio>
            <el-radio label="0" class="!w-[80px]">0点</el-radio>
            <el-radio label="9" class="!w-[80px]">9点</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.hourCustom"
            placeholder="例如: 9,12,18 或 */2"
            :disabled="cronBuilder.hour !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 日 -->
      <div>
        <div class="text-sm font-medium mb-2">日 (1-31)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.day"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每天</el-radio>
            <el-radio label="1" class="!w-[80px]">每月1号</el-radio>
            <el-radio label="15" class="!w-[80px]">每月15号</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.dayCustom"
            placeholder="例如: 1,15 或 */5"
            :disabled="cronBuilder.day !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 月 -->
      <div>
        <div class="text-sm font-medium mb-2">月 (1-12)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.month"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每月</el-radio>
            <el-radio label="1" class="!w-[80px]">1月</el-radio>
            <el-radio label="6" class="!w-[80px]">6月</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.monthCustom"
            placeholder="例如: 1,6,12 或 */3"
            :disabled="cronBuilder.month !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 周 -->
      <div>
        <div class="text-sm font-medium mb-2">周 (0-7, 0和7表示周日)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.weekday"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每天</el-radio>
            <el-radio label="1-5" class="!w-[80px]">工作日</el-radio>
            <el-radio label="0,6" class="!w-[80px]">周末</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.weekdayCustom"
            placeholder="例如: 1,3,5 或 1-5"
            :disabled="cronBuilder.weekday !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 生成的 Cron 表达式 -->
      <div class="border-t pt-4">
        <div class="text-sm font-medium mb-2">生成的 Cron 表达式：</div>
        <el-input v-model="cronBuilder.generated" readonly class="mb-2"> </el-input>
        <div class="flex gap-2">
          <el-button type="primary" size="small" @click="handleApplyCronExpression">
            应用
          </el-button>
          <el-button type="info" size="small" @click="handlePreviewGeneratedCron">
            预览执行时间
          </el-button>
        </div>
      </div>

      <!-- 常用示例 -->
      <div class="border-t pt-4">
        <div class="text-sm font-medium mb-2">常用示例：</div>
        <div class="space-y-2">
          <div class="flex items-center gap-2 flex-wrap">
            <el-button size="small" @click="applyExample('0 0 * * *')"> 每天0点 </el-button>
            <el-button size="small" @click="applyExample('0 */30 * * *')"> 每30分钟 </el-button>
            <el-button size="small" @click="applyExample('0 0 9 * * 1-5')"> 工作日9点 </el-button>
            <el-button size="small" @click="applyExample('0 0 0 1 * *')"> 每月1号0点 </el-button>
          </div>
        </div>
      </div>
    </div>
  </el-dialog>

  <!-- Cron 预览弹窗 -->
  <el-dialog v-model="cronPreviewVisible" title="Cron 执行时间预览" width="500">
    <div v-if="cronPreviewTimes.length > 0">
      <div class="text-sm text-gray-600 mb-3">下5次执行时间：</div>
      <el-timeline>
        <el-timeline-item
          v-for="(time, index) in cronPreviewTimes"
          :key="index"
          :timestamp="time"
          placement="top">
          <div class="font-medium">第 {{ index + 1 }} 次执行</div>
        </el-timeline-item>
      </el-timeline>
    </div>
    <div v-else class="text-center text-gray-400 py-4">
      无法解析 Cron 表达式，请检查格式是否正确
    </div>
  </el-dialog>

  <!-- 扫描设备弹窗 -->
  <el-dialog
    v-model="scanDialogVisible"
    title="扫描到的设备"
    width="800"
    :before-close="handleCloseScanDialog">
    <div class="mb-4">
      <el-button type="primary" @click="handleUpdateDeviceList" :loading="loading">
        刷新扫描
      </el-button>
    </div>
    <el-table :data="deviceList" stripe class="w-full" v-loading="loading" :height="400">
      <el-table-column prop="name" label="设备名称" min-width="150" />
      <el-table-column prop="address" label="地址" min-width="120" />
      <el-table-column prop="rssi" label="信号强度" width="100">
        <template #default="{ row }">
          <span>{{ row.rssi }} dBm</span>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="100">
        <template #default="{ row }">
          <el-button
            size="small"
            type="primary"
            @click="handleConnectDevice(row)"
            :loading="row.connecting"
            :disabled="row.connecting">
            连接
          </el-button>
        </template>
      </el-table-column>
    </el-table>
    <div v-if="deviceList.length === 0 && !loading" class="text-center text-gray-400 mt-4 py-8">
      暂无扫描到的设备，点击"刷新扫描"按钮开始扫描
    </div>
  </el-dialog>

  <!-- 文件浏览对话框 -->
  <el-dialog
    v-model="fileBrowserDialogVisible"
    title="选择文件添加到播放列表"
    width="800"
    :before-close="handleCloseFileBrowser">
    <div class="m-4">
      <div class="flex items-center gap-2 mb-2">
        <el-input v-model="fileBrowserPath" placeholder="当前路径" readonly> </el-input>
        <el-button type="primary" @click="handleRefreshFileBrowser" :loading="fileBrowserLoading">
          刷新
        </el-button>
      </div>
      <div class="flex items-center gap-2 mb-2">
        <el-button
          size="small"
          @click="handleFileBrowserNavigateUp"
          :disabled="!fileBrowserCanNavigateUp">
          上一级
        </el-button>
        <el-button size="small" @click="handleFileBrowserGoToHome"> 首页 </el-button>
        <el-button size="small" @click="handleSelectAllFiles"> 全选 </el-button>
        <el-button size="small" @click="handleDeselectAllFiles"> 取消全选 </el-button>
        <span v-if="selectedFiles.length > 0" class="text-sm text-blue-600 ml-2">
          已选择 {{ selectedFiles.length }} 个文件
        </span>
      </div>
    </div>
    <el-table
      :data="fileBrowserList"
      stripe
      class="w-full"
      v-loading="fileBrowserLoading"
      :height="400"
      @row-click="handleFileBrowserRowClick">
      <el-table-column width="55">
        <template #default="{ row }">
          <el-checkbox
            v-if="!row.isDirectory"
            :model-value="isFileSelected(row)"
            @change="handleToggleFileSelection(row)"
            @click.stop>
          </el-checkbox>
        </template>
      </el-table-column>
      <el-table-column prop="name" label="名称" min-width="200">
        <template #default="{ row }">
          <div class="flex items-center gap-2">
            <span v-if="row.isDirectory">📁</span>
            <span v-else>📄</span>
            <span>{{ row.name }}</span>
          </div>
        </template>
      </el-table-column>
      <el-table-column prop="size" label="大小" width="100">
        <template #default="{ row }">
          <span v-if="!row.isDirectory">{{ formatSize(row.size) }}</span>
          <span v-else>-</span>
        </template>
      </el-table-column>

      <el-table-column label="状态" width="100">
        <template #default="{ row }">
          <el-tag v-if="!row.isDirectory && isFileSelected(row)" type="success" size="small">
            已选择
          </el-tag>
        </template>
      </el-table-column>
    </el-table>
    <template #footer>
      <div class="flex items-center justify-between">
        <span class="text-sm text-gray-500"> 提示：点击文件可切换选择状态，双击目录可进入 </span>
        <div class="flex gap-2 items-center">
          <el-select v-model="fileBrowserTarget" size="small" style="width: 150px">
            <el-option label="添加到主列表" value="files"></el-option>
            <el-option label="添加到前置列表" value="pre_files"></el-option>
          </el-select>
          <el-button @click="handleCloseFileBrowser">取消</el-button>
          <el-button
            type="primary"
            @click="handleAddFilesToPlaylist"
            :loading="playlistLoading"
            :disabled="selectedFiles.length === 0">
            添加 ({{ selectedFiles.length }})
          </el-button>
        </div>
      </div>
    </template>
  </el-dialog>
</div>
