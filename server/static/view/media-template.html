<div class="p-1">
  <!-- 3åˆ—å¸ƒå±€ï¼šæ’­æ”¾åˆ—è¡¨ | æ–‡ä»¶åˆ—è¡¨ | é…ç½®è¯¦æƒ… -->
  <div class="flex gap-4 h-[calc(100vh-150px)]">
    <!-- ç¬¬ä¸€åˆ—ï¼šæ’­æ”¾åˆ—è¡¨åˆ—è¡¨ -->
    <div class="w-64 border rounded p-3 flex flex-col">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-semibold">æ’­æ”¾åˆ—è¡¨</h3>
        <div class="flex items-center gap-1">
          <el-button
            type="info"
            size="small"
            plain
            @click="handleOpenAgentListDialog"
            class="!w-8 !h-6 !p-0">
            <el-icon><Monitor /></el-icon>
          </el-button>
          <el-button
            type="primary"
            size="small"
            plain
            @click="refreshPlaylistStatus"
            :loading="playlistRefreshing"
            class="!w-8 !h-6 !p-0">
            <el-icon v-if="!playlistRefreshing"><Refresh /></el-icon>
          </el-button>
          <el-button
            type="success"
            size="small"
            @click="handleCreatePlaylist"
            class="!w-8 !h-6 !p-0">
            <el-icon><Plus /></el-icon>
          </el-button>
        </div>
      </div>
      <div
        v-if="playlistCollection && playlistCollection.length > 0"
        class="flex-1 overflow-y-auto space-y-2 pr-1">
        <div
          v-for="playlist in playlistCollection"
          :key="playlist.id"
          class="border rounded px-3 py-2 cursor-pointer hover:bg-gray-50 group min-h-[60px] flex flex-col justify-between"
          :class="{ 'border-blue-500 bg-blue-50': playlist.id === activePlaylistId }"
          @click="handleSelectPlaylist(playlist.id)">
          <!-- ç¬¬ä¸€è¡Œï¼šåç§°ã€æ›²ç›®æ•°é‡ã€åŠŸèƒ½æŒ‰é’® -->
          <div class="flex items-center justify-between gap-2">
            <div class="text-sm font-medium truncate flex-1 min-w-0">{{ playlist.name }}</div>
            <div class="flex items-center gap-2 flex-shrink-0">
              <span class="text-xs text-gray-500 whitespace-nowrap flex items-center gap-1">
                <el-icon><Headset class="!w-3 !h-3" /></el-icon>
                <span class="whitespace-nowrap w-5 flex items-center justify-center">{{ ((playlist.pre_files && playlist.pre_files.length) || 0) + ((playlist.playlist && playlist.playlist.length) || 0) }}</span>
              </span>
              <div class="flex items-center justify-center">
                <el-dropdown
                  trigger="click"
                  @command="(command) => handlePlaylistMenuCommand(command, playlist.id)"
                  @click.stop>
                  <el-button
                    type="default"
                    size="small"
                    plain
                    circle
                    class="!w-5 !h-5 !min-w-5 !p-0 text-xs"
                    title="æ›´å¤š">
                    <span style="font-size: 16px; line-height: 1" class="mb-1">Â»</span>
                  </el-button>
                  <template #dropdown>
                    <el-dropdown-menu>
                      <el-dropdown-item command="copy">
                        <span>å¤åˆ¶</span>
                      </el-dropdown-item>
                      <el-dropdown-item
                        v-if="playlistCollection.length > 1"
                        command="delete"
                        divided>
                        <span style="color: #f56c6c">åˆ é™¤</span>
                      </el-dropdown-item>
                    </el-dropdown-menu>
                  </template>
                </el-dropdown>
              </div>
            </div>
          </div>
          <!-- ç¬¬äºŒè¡Œï¼šä¸‹æ¬¡è¿è¡Œæ—¶é—´ï¼ˆå§‹ç»ˆå­˜åœ¨ï¼Œä¿æŒå›ºå®šé«˜åº¦ï¼‰ -->
          <div class="text-[10px] text-blue-600 min-h-[14px] flex items-center justify-between">
            <span v-if="getPlaylistNextCronTime(playlist)" class="flex items-center gap-1">
              <el-icon class="!w-3 !h-4"><VideoPlay /></el-icon> {{
              getPlaylistNextCronTime(playlist) }}
            </span>
            <span v-else class="invisible">å ä½</span>
            <span v-if="playlist.trigger_button" class="text-gray-500 flex items-center gap-1">
              <el-icon class="!w-3 !h-4"><Cpu /></el-icon> {{ playlist.trigger_button }}
            </span>
          </div>
        </div>
      </div>
      <div v-else class="flex-1 flex items-center justify-center text-sm text-gray-400">
        æš‚æ— æ’­æ”¾åˆ—è¡¨ï¼Œè¯·ç‚¹å‡»"æ–°å»º"åˆ›å»º
      </div>
    </div>

    <!-- ç¬¬äºŒåˆ—ï¼šæ–‡ä»¶åˆ—è¡¨ -->
    <div class="flex-1 border rounded p-3 flex flex-col">
      <div class="flex items-center justify-between mb-3">
        <div class="flex-1 min-w-0">
          <div v-if="playlistStatus" class="flex items-center gap-2 mb-1">
            <div
              v-if="editingPlaylistId !== activePlaylistId"
              class="flex items-center gap-2 flex-1 min-w-0">
              <h3 class="text-lg font-semibold truncate">{{ playlistStatus.name }}</h3>
              <el-button
                type="plain"
                size="small"
                circle
                @click="handleStartEditPlaylistName(activePlaylistId)"
                title="ç¼–è¾‘åç§°">
                <el-icon><Edit /></el-icon>
              </el-button>
            </div>
            <div v-else class="flex items-center gap-2 flex-1 min-w-0">
              <el-input
                :model-value="editingPlaylistName"
                @input="(val) => editingPlaylistName = val"
                @blur="handleSavePlaylistName(activePlaylistId)"
                @keyup.enter="handleSavePlaylistName(activePlaylistId)"
                @keyup.esc="handleCancelEditPlaylistName"
                size="small"
                class="flex-1"
                :data-playlist-id="activePlaylistId"
                ref="editPlaylistNameInput">
              </el-input>
            </div>
          </div>
          <div v-else>
            <h3 class="text-lg font-semibold">æ’­æ”¾åˆ—è¡¨æ–‡ä»¶</h3>
          </div>
          <div class="text-sm text-gray-500" v-if="playlistStatus">
            <span v-if="getPlaylistTotalDuration() > 0" class="mr-2">
              æ€»æ—¶é•¿ï¼š{{ formatDuration(getPlaylistTotalDuration()) }}
            </span>
            <template v-if="playlistStatus">
              <template
                v-if="(playlistStatus.pre_files?.length || 0) + (playlistStatus.playlist?.length || 0) > 0">
                å…± {{ (playlistStatus.pre_files?.length || 0) + (playlistStatus.playlist?.length ||
                0) }} é¦–ï¼Œ å½“å‰:
                <template
                  v-if="playlistStatus.pre_index !== undefined && playlistStatus.pre_index !== null && playlistStatus.pre_index >= 0">
                  {{ playlistStatus.pre_index + 1 }}
                </template>
                <template
                  v-else-if="playlistStatus.current_index !== undefined && playlistStatus.current_index !== null && playlistStatus.current_index >= 0">
                  {{ (playlistStatus.pre_files?.length || 0) + playlistStatus.current_index + 1 }}
                </template>
                <template v-else> - </template>
                / {{ (playlistStatus.pre_files?.length || 0) + (playlistStatus.playlist?.length ||
                0) }}
              </template>
              <template v-else> å…± 0 é¦–ï¼Œ å½“å‰: - / 0 </template>
            </template>
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <el-button
            type="plain"
            size="small"
            circle
            @click="showMoreActions = !showMoreActions"
            title="æ›´å¤š">
            <el-icon><el-icon-menu /></el-icon>
          </el-button>
          <el-button
            type="plain"
            size="small"
            circle
            @click="handlePlayPlaylist"
            class="items-center justify-center"
            :disabled="!playlistStatus || !playlistStatus.playlist || playlistStatus.playlist.length === 0 || !!playlistStatus.isPlaying"
            title="æ’­æ”¾">
            <el-icon v-if="playing" size="12" class="animate-spin"><Loading /></el-icon>
            <span v-else>â–¶</span>
          </el-button>
          <el-button
            type="plain"
            size="small"
            circle
            @click="handlePlayPre"
            :disabled="!playlistStatus || ((!playlistStatus.pre_files || playlistStatus.pre_files.length === 0) && (!playlistStatus.playlist || playlistStatus.playlist.length === 0))"
            title="ä¸Šä¸€é¦–">
            <el-icon v-if="playing" size="12" class="animate-spin"><Loading /></el-icon>
            <span v-else>â®</span>
          </el-button>
          <el-button
            type="plain"
            size="small"
            circle
            @click="handlePlayNext"
            :disabled="!playlistStatus || ((!playlistStatus.pre_files || playlistStatus.pre_files.length === 0) && (!playlistStatus.playlist || playlistStatus.playlist.length === 0))"
            title="ä¸‹ä¸€é¦–">
            <el-icon v-if="playing" size="12" class="animate-spin"><Loading /></el-icon>
            <span v-else>â­</span>
          </el-button>
          <el-button type="plain" size="small" circle @click="handleStopPlaylist" title="åœæ­¢">
            <el-icon v-if="stopping" size="12" class="animate-spin"><Loading /></el-icon>
            <span v-else>â¹</span>
          </el-button>
          <el-button
            v-show="showMoreActions"
            type="plain"
            size="small"
            circle
            @click="handleClearPlaylist"
            :disabled="!playlistStatus || ((!playlistStatus.pre_files || playlistStatus.pre_files.length === 0) && (!playlistStatus.playlist || playlistStatus.playlist.length === 0)) || playlistLoading"
            title="æ¸…ç©ºåˆ—è¡¨ï¼ˆåŒ…æ‹¬å‰ç½®æ–‡ä»¶å’Œæ­£å¼æ–‡ä»¶ï¼‰">
            <el-icon><Delete /></el-icon>
          </el-button>
        </div>
      </div>

      <div v-if="playlistStatus" class="flex-1 overflow-y-auto">
        <!-- pre_files åˆ—è¡¨ -->
        <div class="border rounded p-2 mb-2">
          <div class="flex items-center justify-between mb-2">
            <div class="text-xs font-semibold text-gray-600">
              å‰ç½®æ–‡ä»¶ï¼ˆæ’­æ”¾æ—¶ä¼˜å…ˆæ’­æ”¾ï¼‰
              <span v-if="getPreFilesTotalDuration() > 0" class="ml-2 text-gray-500">
                {{ formatDuration(getPreFilesTotalDuration()) }}
              </span>
              <span
                v-if="playlistStatus.pre_files && playlistStatus.pre_files.length > 0"
                class="ml-2 text-gray-500">
                å…± {{ playlistStatus.pre_files.length }} é¦–ï¼Œ å½“å‰: {{ playlistStatus.pre_index !==
                undefined && playlistStatus.pre_index !== null && playlistStatus.pre_index >= 0 ?
                playlistStatus.pre_index + 1 : '-' }} / {{ playlistStatus.pre_files.length }}
              </span>
              <el-tag
                v-if="playlistStatus.isPlaying && playlistStatus.in_pre_files === true"
                type="success"
                size="small"
                class="ml-2">
                æ’­æ”¾ä¸­
              </el-tag>
            </div>
            <div class="flex items-center gap-1 pr-1">
              <el-button
                type="primary"
                size="small"
                plain
                @click="handleOpenFileBrowserForPreFiles"
                :disabled="!playlistStatus || preFilesDragMode">
                +
              </el-button>
              <el-button
                :type="preFilesDragMode ? 'success' : 'default'"
                size="small"
                plain
                class="!w-8 !h-6"
                @click="handleTogglePreFilesDragMode"
                :disabled="!playlistStatus || !playlistStatus.pre_files || playlistStatus.pre_files.length === 0"
                :title="preFilesDragMode ? 'ç‚¹å‡»é€€å‡ºæ‹–æ‹½æ’åºæ¨¡å¼' : 'ç‚¹å‡»è¿›å…¥æ‹–æ‹½æ’åºæ¨¡å¼'">
                <el-icon v-if="preFilesDragMode"><Check /></el-icon>
                <ion-icon v-else class="!w-3.5 !h-3.5" name="chevron-expand-sharp"></ion-icon>
              </el-button>
              <el-button
                type="danger"
                size="small"
                circle
                plain
                @click="handleClearPreFiles"
                :disabled="!playlistStatus || !playlistStatus.pre_files || playlistStatus.pre_files.length === 0 || playlistLoading || preFilesDragMode"
                title="æ¸…ç©ºåˆ—è¡¨">
                <el-icon><Delete /></el-icon>
              </el-button>
            </div>
          </div>
          <div v-if="playlistStatus.pre_files && playlistStatus.pre_files.length > 0">
            <div
              v-for="(file, index) in playlistStatus.pre_files"
              :key="'pre-' + index"
              class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded"
              :class="{ 
                'bg-blue-50': playlistStatus.pre_index !== undefined && playlistStatus.pre_index !== null && index === playlistStatus.pre_index
              }"
              :style="{ cursor: preFilesDragMode ? 'move' : 'default', userSelect: 'none' }"
              :draggable="preFilesDragMode"
              @dragstart="handlePreFileDragStart($event, index)"
              @dragend="handlePreFileDragEnd($event)"
              @dragover.prevent="handlePreFileDragOver($event)"
              @dragleave="(e) => { if (e.currentTarget) { e.currentTarget.style.backgroundColor = ''; e.currentTarget.style.borderTop = ''; e.currentTarget.style.borderBottom = ''; } }"
              @drop.prevent="handlePreFileDrop($event, index)">
              <span class="text-xs text-gray-500 w-8">{{ index + 1 }}</span>
              <span
                class="flex-1 text-sm truncate"
                :class="{ 'text-blue-600': playlistStatus.pre_index !== undefined && playlistStatus.pre_index !== null && index === playlistStatus.pre_index }"
                :title="file.uri">
                {{ file.uri.split('/').pop() }}
              </span>
              <el-tag
                v-if="file.duration"
                type="info"
                size="small"
                class="whitespace-nowrap w-16 text-center">
                {{ formatDuration(file.duration) }}
              </el-tag>
              <div v-else class="w-16"></div>
              <div class="flex items-center gap-1" @mousedown.stop @click.stop>
                <el-button
                  v-show="showMoreActions && !preFilesDragMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleMovePreFileUp(index)"
                  :disabled="index === 0 || playlistLoading"
                  title="ä¸Šç§»">
                  â†‘
                </el-button>
                <el-button
                  v-show="showMoreActions && !preFilesDragMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleMovePreFileDown(index)"
                  :disabled="index === playlistStatus.pre_files.length - 1 || playlistLoading"
                  title="ä¸‹ç§»">
                  â†“
                </el-button>
                <el-button
                  v-show="showMoreActions && !preFilesDragMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleCopyPreFile(index)"
                  :disabled="playlistLoading"
                  title="å¤åˆ¶åˆ°æœ«å°¾">
                  <el-icon><DocumentCopy /></el-icon>
                </el-button>
                <el-button
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleDeletePreFile(index)"
                  :disabled="playlistLoading || preFilesDragMode"
                  title="åˆ é™¤">
                  <el-icon><Minus /></el-icon>
                </el-button>
              </div>
            </div>
          </div>
          <div v-else class="text-sm text-gray-400 text-center py-1">å‰ç½®æ–‡ä»¶åˆ—è¡¨ä¸ºç©º</div>
        </div>

        <!-- files åˆ—è¡¨ -->
        <div
          v-if="playlistStatus.playlist"
          class="border rounded p-2">
          <div class="flex items-center justify-between mb-2 pr-1">
            <div class="text-xs font-semibold text-gray-600">
              æ­£å¼æ–‡ä»¶ï¼ˆæ’­æ”¾æ—¶è®°å½•è¿›åº¦ï¼‰
              <span v-if="getFilesTotalDuration() > 0" class="ml-2 text-gray-500">
                {{ formatDuration(getFilesTotalDuration()) }}
              </span>
              <span
                v-if="playlistStatus.playlist && playlistStatus.playlist.length > 0"
                class="ml-2 text-gray-500">
                å…± {{ playlistStatus.playlist.length }} é¦–ï¼Œ å½“å‰: {{ playlistStatus.current_index
                !== undefined ? playlistStatus.current_index + 1 : '-' }} / {{
                playlistStatus.playlist.length }}
              </span>
              <el-tag
                v-if="playlistStatus.isPlaying && playlistStatus.in_pre_files === false"
                type="success"
                size="small"
                class="ml-2">
                æ’­æ”¾ä¸­
              </el-tag>
            </div>
            <div class="flex items-center gap-1">
              <el-button
                type="primary"
                plain
                size="small"
                class="!w-8 !h-6"
                @click="handleOpenFileBrowser"
                :disabled="!playlistStatus || filesDragMode">
                +
              </el-button>
              <el-button
                :type="filesDragMode ? 'success' : 'default'"
                plain
                size="small"
                class="!w-8 !h-6"
                @click="handleToggleFilesDragMode"
                :disabled="!playlistStatus || !playlistStatus.playlist || playlistStatus.playlist.length === 0"
                :title="filesDragMode ? 'ç‚¹å‡»é€€å‡ºæ‹–æ‹½æ’åºæ¨¡å¼' : 'ç‚¹å‡»è¿›å…¥æ‹–æ‹½æ’åºæ¨¡å¼'">
                <el-icon v-if="filesDragMode"><Check /></el-icon>
                <ion-icon v-else class="!w-3.5 !h-3.5" name="chevron-expand-sharp"></ion-icon>
              </el-button>
              <el-button
                type="danger"
                plain
                size="small"
                circle
                @click="handleClearFiles"
                :disabled="!playlistStatus || !playlistStatus.playlist || playlistStatus.playlist.length === 0 || playlistLoading || filesDragMode"
                title="æ¸…ç©ºæ­£å¼æ–‡ä»¶åˆ—è¡¨">
                <el-icon><Delete /></el-icon>
              </el-button>
            </div>
          </div>
          <div v-if="playlistStatus.playlist && playlistStatus.playlist.length > 0">
            <div
              v-for="(file, index) in playlistStatus.playlist"
              :key="index"
              class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded"
              :class="{ 
                'bg-blue-50': index === playlistStatus.current_index
              }"
              :style="{ cursor: filesDragMode ? 'move' : 'default', userSelect: 'none' }"
              :draggable="filesDragMode"
              @dragstart="handleFileDragStart($event, index)"
              @dragend="handleFileDragEnd($event)"
              @dragover.prevent="handleFileDragOver($event)"
              @dragleave="(e) => { if (e.currentTarget) { e.currentTarget.style.backgroundColor = ''; e.currentTarget.style.borderTop = ''; e.currentTarget.style.borderBottom = ''; } }"
              @drop.prevent="handleFileDrop($event, index)">
              <span class="text-xs text-gray-500 w-8">{{ index + 1 }}</span>
              <span
                class="flex-1 text-sm truncate"
                :class="{ 'text-blue-600': index === playlistStatus.current_index }"
                :title="file.uri">
                {{ file.uri.split('/').pop() }}
              </span>
              <el-tag
                v-if="file.duration"
                type="info"
                size="small"
                class="whitespace-nowrap w-16 text-center">
                {{ formatDuration(file.duration) }}
              </el-tag>
              <div v-else class="w-16"></div>
              <!-- <el-tag v-if="index === playlistStatus.current_index" type="success" size="small">
                å½“å‰
              </el-tag> -->
              <div class="flex items-center gap-1" @mousedown.stop @click.stop>
                <el-button
                  v-show="showMoreActions && !filesDragMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleMovePlaylistItemUp(index)"
                  :disabled="index === 0 || playlistLoading"
                  title="ä¸Šç§»">
                  â†‘
                </el-button>
                <el-button
                  v-show="showMoreActions && !filesDragMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleMovePlaylistItemDown(index)"
                  :disabled="index === playlistStatus.playlist.length - 1 || playlistLoading"
                  title="ä¸‹ç§»">
                  â†“
                </el-button>
                <el-button
                  v-show="showMoreActions && !filesDragMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleCopyPlaylistItem(index)"
                  :disabled="playlistLoading"
                  title="å¤åˆ¶åˆ°æœ«å°¾">
                  <el-icon><DocumentCopy /></el-icon>
                </el-button>
                <el-button
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleDeletePlaylistItem(index)"
                  :disabled="playlistLoading || filesDragMode"
                  title="åˆ é™¤">
                  <el-icon><Minus /></el-icon>
                </el-button>
              </div>
            </div>
          </div>
          <div v-else class="text-sm text-gray-400 text-center py-1">æ­£å¼æ–‡ä»¶åˆ—è¡¨ä¸ºç©º</div>
        </div>
        <div
          v-else-if="(!playlistStatus.pre_files || playlistStatus.pre_files.length === 0)"
          class="text-sm text-gray-400 text-center py-8">
          å½“å‰æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œç‚¹å‡»"æ·»åŠ æ–‡ä»¶"å¼€å§‹æ„å»ºæ’­æ”¾åˆ—è¡¨
        </div>
      </div>
      <div v-else class="flex-1 flex items-center justify-center text-sm text-gray-400">
        è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ’­æ”¾åˆ—è¡¨æŸ¥çœ‹è¯¦æƒ…
      </div>
    </div>

    <!-- ç¬¬ä¸‰åˆ—ï¼šé…ç½®è¯¦æƒ…ï¼ˆCron + è®¾å¤‡ï¼‰ -->
    <div class="w-80 border rounded p-3 flex flex-col">
      <h3 class="text-lg font-semibold mb-3">é…ç½®è¯¦æƒ…</h3>

      <div v-if="playlistStatus" class="flex-1 overflow-y-auto space-y-4">
        <!-- Cron å®šæ—¶ä»»åŠ¡é…ç½® -->
        <div class="border rounded p-3">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-semibold">å®šæ—¶ä»»åŠ¡ (Cron)</h4>
            <el-switch
              :model-value="playlistStatus.schedule?.enabled === 1"
              @change="(val) => handleTogglePlaylistCronEnabled(val)"
              active-text="å¼€å¯"
              inactive-text="å…³é—­">
            </el-switch>
          </div>

          <div class="space-y-2">
            <div>
              <div class="text-xs text-gray-600 mb-1">Cron è¡¨è¾¾å¼</div>
              <div class="flex items-center gap-2">
                <el-input
                  :model-value="playlistStatus.schedule?.cron || ''"
                  @input="(val) => handleUpdatePlaylistCron(val)"
                  placeholder="ä¾‹å¦‚: 0 0 * * *"
                  size="small"
                  :disabled="playlistStatus.schedule?.enabled !== 1">
                </el-input>
                <el-button
                  type="info"
                  size="small"
                  @click="handleOpenCronBuilder"
                  :disabled="playlistStatus.schedule?.enabled !== 1"
                  >åŠ©æ‰‹</el-button
                >
              </div>
            </div>

            <div class="flex items-start gap-4">
              <div class="flex-1">
                <div class="text-xs text-gray-600 mb-1">æŒç»­æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</div>
                <el-input-number
                  :model-value="playlistStatus.schedule?.duration || 0"
                  @change="handleUpdatePlaylistDuration"
                  :min="0"
                  :max="1440"
                  :step="1"
                  size="small"
                  :disabled="playlistStatus.schedule?.enabled !== 1"
                  class="w-full">
                </el-input-number>
                <div class="text-xs text-gray-500 mt-1">0è¡¨ç¤ºä¸è‡ªåŠ¨åœæ­¢</div>
              </div>
              <div class="flex-1">
                <div class="text-xs text-gray-600 mb-1">è§¦å‘æŒ‰é’®</div>
                <el-select
                  :model-value="playlistStatus.trigger_button || ''"
                  @change="handleUpdateTriggerButton"
                  placeholder="é€‰æ‹©è§¦å‘æŒ‰é’®"
                  size="small"
                  class="w-full"
                  clearable>
                  <el-option label="ç©º" value="" />
                  <el-option label="æŒ‰é’®å¯¹-1" value="B1" />
                  <el-option label="æŒ‰é’®å¯¹-2" value="B2" />
                  <el-option label="æŒ‰é’®å¯¹-3" value="B3" />
                </el-select>
              </div>
            </div>

            <div v-if="playlistStatus.schedule?.cron && playlistStatus.schedule?.enabled === 1">
              <el-button
                type="success"
                size="small"
                @click="handlePreviewPlaylistCron"
                class="w-full">
                é¢„è§ˆæ‰§è¡Œæ—¶é—´
              </el-button>
            </div>
          </div>
        </div>

        <!-- è®¾å¤‡é…ç½® -->
        <div class="border rounded p-3">
          <h4 class="text-sm font-semibold mb-2">è®¾å¤‡é…ç½®</h4>

          <div class="space-y-2">
            <div>
              <div class="text-xs text-gray-600 mb-1">è®¾å¤‡ç±»å‹</div>
              <el-select
                :model-value="playlistStatus.device?.type || playlistStatus.device_type || ''"
                @change="handleUpdatePlaylistDeviceType"
                placeholder="é€‰æ‹©è®¾å¤‡ç±»å‹"
                size="small"
                class="w-full">
                <el-option label="è“ç‰™" value="bluetooth" />
                <el-option label="DLNA" value="dlna" />
                <el-option label="è®¾å¤‡ä»£ç†" value="agent" />
                <el-option label="å°ç±³è®¾å¤‡" value="mi" />
              </el-select>
            </div>

            <div>
              <div class="text-xs text-gray-600 mb-1 flex items-center gap-2">
                <span>è®¾å¤‡åœ°å€</span>
                <span v-if="playlistStatus.device?.name" class="text-xs text-gray-500">
                  {{ playlistStatus.device.name }}
                </span>
              </div>
              <div class="flex items-center gap-2">
                <el-input
                  :model-value="playlistStatus.device?.address || playlistStatus.device_address || ''"
                  @input="(val) => handleUpdatePlaylistDeviceAddress(val)"
                  placeholder="è®¾å¤‡åœ°å€"
                  size="small"
                  class="flex-1">
                </el-input>
                <el-button
                  size="small"
                  type="danger"
                  plain
                  @click="handleUpdatePlaylistDeviceAddress('')"
                  :disabled="!playlistStatus.device?.address && !playlistStatus.device_address"
                  title="æ¸…ç©ºè®¾å¤‡åœ°å€">
                  æ¸…ç©º
                </el-button>
              </div>
            </div>
          </div>

          <!-- è®¾å¤‡åˆ—è¡¨ -->
          <div class="mt-3">
            <div class="flex items-center justify-between mb-2">
              <h5 class="text-xs font-semibold text-gray-700">
                <span
                  v-if="playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent' || playlistStatus.device?.type === 'bluetooth' || playlistStatus.device_type === 'bluetooth'">
                  å·²é…å¯¹çš„è®¾å¤‡
                </span>
                <span
                  v-else-if="playlistStatus.device?.type === 'dlna' || playlistStatus.device_type === 'dlna'">
                  DLNA è®¾å¤‡
                </span>
                <span
                  v-else-if="playlistStatus.device?.type === 'mi' || playlistStatus.device_type === 'mi'">
                  å°ç±³è®¾å¤‡
                </span>
                <span v-else>è®¾å¤‡åˆ—è¡¨</span>
              </h5>
              <el-button
                v-if="playlistStatus.device?.type === 'dlna' || playlistStatus.device_type === 'dlna'"
                type="primary"
                size="small"
                @click="scanDlnaDevices"
                :loading="dlnaScanning">
                æ‰«æè®¾å¤‡
              </el-button>
              <el-button
                v-if="playlistStatus.device?.type === 'mi' || playlistStatus.device_type === 'mi'"
                type="primary"
                size="small"
                @click="scanMiDevices"
                :loading="miScanning">
                æ‰«æè®¾å¤‡
              </el-button>
              <el-button
                v-if="playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent' || playlistStatus.device?.type === 'bluetooth' || playlistStatus.device_type === 'bluetooth'"
                type="primary"
                size="small"
                @click="handleOpenScanDialog">
                æ‰«æè®¾å¤‡
              </el-button>
            </div>

            <!-- è®¾å¤‡ä»£ç†ç±»å‹ï¼šæ˜¾ç¤ºå·²é…å¯¹è®¾å¤‡ -->
            <div
              v-if="playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent' || playlistStatus.device?.type === 'bluetooth' || playlistStatus.device_type === 'bluetooth'">
              <div class="space-y-2 max-h-[200px] overflow-y-auto" v-loading="loading">
                <div
                  v-for="device in connectedDeviceList"
                  :key="device.address"
                  class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50">
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">{{ device.name }}</div>
                    <div class="text-xs text-gray-500 truncate">{{ device.address }}</div>
                  </div>
                  <div class="flex-shrink-0">
                    <el-button
                      size="small"
                      type="primary"
                      @click="(playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent') ? handleSelectAgentDevice(device) : handleSelectBluetoothDevice(device.address)"
                      :disabled="device.address === (playlistStatus.device?.address || playlistStatus.device_address)">
                      é€‰æ‹©
                    </el-button>
                  </div>
                </div>
                <div
                  v-if="connectedDeviceList.length === 0"
                  class="text-xs text-gray-400 text-center py-4">
                  æš‚æ— è®¾å¤‡
                </div>
              </div>
            </div>

            <!-- DLNA ç±»å‹ï¼šæ˜¾ç¤º DLNA è®¾å¤‡ -->
            <div
              v-else-if="playlistStatus.device?.type === 'dlna' || playlistStatus.device_type === 'dlna'">
              <div class="space-y-2 max-h-[200px] overflow-y-auto" v-loading="dlnaScanning">
                <div
                  v-for="device in dlnaDeviceList"
                  :key="device.location"
                  class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50">
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">{{ device.name }}</div>
                    <div class="text-xs text-gray-500 truncate" :title="device.location">
                      {{ device.location }}
                    </div>
                  </div>
                  <div class="flex-shrink-0">
                    <el-button
                      size="small"
                      type="primary"
                      @click="handleUpdatePlaylistDeviceAddress(device.location, device.name)"
                      :disabled="device.location === (playlistStatus.device?.address || playlistStatus.device_address)">
                      é€‰æ‹©
                    </el-button>
                  </div>
                </div>
                <div
                  v-if="dlnaDeviceList.length === 0 && !dlnaScanning"
                  class="text-xs text-gray-400 text-center py-4">
                  æš‚æ— è®¾å¤‡ï¼Œç‚¹å‡»"æ‰«æè®¾å¤‡"å¼€å§‹æ‰«æ
                </div>
              </div>
            </div>

            <!-- å°ç±³è®¾å¤‡ç±»å‹ï¼šæ˜¾ç¤ºå°ç±³è®¾å¤‡ -->
            <div
              v-else-if="playlistStatus.device?.type === 'mi' || playlistStatus.device_type === 'mi'">
              <div class="space-y-2 max-h-[200px] overflow-y-auto" v-loading="miScanning">
                <div
                  v-for="device in miDeviceList"
                  :key="device.deviceID || device.address"
                  class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50">
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">{{ device.name }}</div>
                    <div
                      class="text-xs text-gray-500 truncate"
                      :title="device.deviceID || device.address">
                      {{ device.deviceID || device.address }}
                    </div>
                  </div>
                  <div class="flex-shrink-0">
                    <el-button
                      size="small"
                      type="primary"
                      @click="handleSelectMiDevice(device)"
                      :disabled="(device.deviceID || device.address) === (playlistStatus.device?.address || playlistStatus.device_address)">
                      é€‰æ‹©
                    </el-button>
                  </div>
                </div>
                <div
                  v-if="miDeviceList.length === 0 && !miScanning"
                  class="text-xs text-gray-400 text-center py-4">
                  æš‚æ— è®¾å¤‡ï¼Œç‚¹å‡»"æ‰«æè®¾å¤‡"å¼€å§‹æ‰«æ
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div v-else class="flex-1 flex items-center justify-center text-sm text-gray-400">
        è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ’­æ”¾åˆ—è¡¨
      </div>
    </div>
  </div>

  <!-- Cron å¯è§†åŒ–ç”Ÿæˆå¼¹çª— -->
  <el-dialog
    v-model="cronBuilderVisible"
    title="Cron è¡¨è¾¾å¼ç”Ÿæˆå™¨"
    width="700"
    :before-close="handleCloseCronBuilder">
    <div class="space-y-4 m-4">
      <!-- ç§’ -->
      <div>
        <div class="text-sm font-medium mb-2">ç§’ (0-59)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.second"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">æ¯ç§’é’Ÿ</el-radio>
            <el-radio label="0" class="!w-[80px]">ç¬¬0ç§’</el-radio>
            <el-radio label="30" class="!w-[80px]">ç¬¬30ç§’</el-radio>
            <el-radio label="custom" class="!w-[80px]">è‡ªå®šä¹‰</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.secondCustom"
            placeholder="ä¾‹å¦‚: 0,30 æˆ– */10"
            :disabled="cronBuilder.second !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- åˆ† -->
      <div>
        <div class="text-sm font-medium mb-2">åˆ† (0-59)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.minute"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">æ¯åˆ†é’Ÿ</el-radio>
            <el-radio label="0" class="!w-[80px]">ç¬¬0åˆ†</el-radio>
            <el-radio label="30" class="!w-[80px]">ç¬¬30åˆ†</el-radio>
            <el-radio label="custom" class="!w-[80px]">è‡ªå®šä¹‰</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.minuteCustom"
            placeholder="ä¾‹å¦‚: 0,30 æˆ– */15"
            :disabled="cronBuilder.minute !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- æ—¶ -->
      <div>
        <div class="text-sm font-medium mb-2">æ—¶ (0-23)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.hour"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">æ¯å°æ—¶</el-radio>
            <el-radio label="0" class="!w-[80px]">0ç‚¹</el-radio>
            <el-radio label="9" class="!w-[80px]">9ç‚¹</el-radio>
            <el-radio label="custom" class="!w-[80px]">è‡ªå®šä¹‰</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.hourCustom"
            placeholder="ä¾‹å¦‚: 9,12,18 æˆ– */2"
            :disabled="cronBuilder.hour !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- æ—¥ -->
      <div>
        <div class="text-sm font-medium mb-2">æ—¥ (1-31)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.day"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">æ¯å¤©</el-radio>
            <el-radio label="1" class="!w-[80px]">æ¯æœˆ1å·</el-radio>
            <el-radio label="15" class="!w-[80px]">æ¯æœˆ15å·</el-radio>
            <el-radio label="custom" class="!w-[80px]">è‡ªå®šä¹‰</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.dayCustom"
            placeholder="ä¾‹å¦‚: 1,15 æˆ– */5"
            :disabled="cronBuilder.day !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- æœˆ -->
      <div>
        <div class="text-sm font-medium mb-2">æœˆ (1-12)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.month"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">æ¯æœˆ</el-radio>
            <el-radio label="1" class="!w-[80px]">1æœˆ</el-radio>
            <el-radio label="6" class="!w-[80px]">6æœˆ</el-radio>
            <el-radio label="custom" class="!w-[80px]">è‡ªå®šä¹‰</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.monthCustom"
            placeholder="ä¾‹å¦‚: 1,6,12 æˆ– */3"
            :disabled="cronBuilder.month !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- å‘¨ -->
      <div>
        <div class="text-sm font-medium mb-2">å‘¨ (0-7, 0å’Œ7è¡¨ç¤ºå‘¨æ—¥)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.weekday"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">æ¯å¤©</el-radio>
            <el-radio label="1-5" class="!w-[80px]">å·¥ä½œæ—¥</el-radio>
            <el-radio label="0,6" class="!w-[80px]">å‘¨æœ«</el-radio>
            <el-radio label="custom" class="!w-[80px]">è‡ªå®šä¹‰</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.weekdayCustom"
            placeholder="ä¾‹å¦‚: 1,3,5 æˆ– 1-5"
            :disabled="cronBuilder.weekday !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- ç”Ÿæˆçš„ Cron è¡¨è¾¾å¼ -->
      <div class="border-t pt-4">
        <div class="text-sm font-medium mb-2">ç”Ÿæˆçš„ Cron è¡¨è¾¾å¼ï¼š</div>
        <el-input v-model="cronBuilder.generated" readonly class="mb-2"> </el-input>
        <div class="flex gap-2">
          <el-button type="primary" size="small" @click="handleApplyCronExpression">
            åº”ç”¨
          </el-button>
          <el-button type="info" size="small" @click="handlePreviewGeneratedCron">
            é¢„è§ˆæ‰§è¡Œæ—¶é—´
          </el-button>
        </div>
      </div>

      <!-- å¸¸ç”¨ç¤ºä¾‹ -->
      <div class="border-t pt-4">
        <div class="text-sm font-medium mb-2">å¸¸ç”¨ç¤ºä¾‹ï¼š</div>
        <div class="space-y-2">
          <div class="flex items-center gap-2 flex-wrap">
            <el-button size="small" @click="applyExample('0 0 * * *')"> æ¯å¤©0ç‚¹ </el-button>
            <el-button size="small" @click="applyExample('0 */30 * * *')"> æ¯30åˆ†é’Ÿ </el-button>
            <el-button size="small" @click="applyExample('0 0 9 * * 1-5')"> å·¥ä½œæ—¥9ç‚¹ </el-button>
            <el-button size="small" @click="applyExample('0 0 0 1 * *')"> æ¯æœˆ1å·0ç‚¹ </el-button>
          </div>
        </div>
      </div>
    </div>
  </el-dialog>

  <!-- Cron é¢„è§ˆå¼¹çª— -->
  <el-dialog v-model="cronPreviewVisible" title="Cron æ‰§è¡Œæ—¶é—´é¢„è§ˆ" width="500">
    <div v-if="cronPreviewTimes.length > 0">
      <div class="text-sm text-gray-600 mb-3">ä¸‹5æ¬¡æ‰§è¡Œæ—¶é—´ï¼š</div>
      <el-timeline>
        <el-timeline-item
          v-for="(time, index) in cronPreviewTimes"
          :key="index"
          :timestamp="time"
          placement="top">
          <div class="font-medium">ç¬¬ {{ index + 1 }} æ¬¡æ‰§è¡Œ</div>
        </el-timeline-item>
      </el-timeline>
    </div>
    <div v-else class="text-center text-gray-400 py-4">
      æ— æ³•è§£æ Cron è¡¨è¾¾å¼ï¼Œè¯·æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®
    </div>
  </el-dialog>

  <!-- æ‰«æè®¾å¤‡å¼¹çª— -->
  <el-dialog
    v-model="scanDialogVisible"
    title="æ‰«æåˆ°çš„è®¾å¤‡"
    width="800"
    :before-close="handleCloseScanDialog">
    <div class="mb-4">
      <el-button type="primary" @click="handleUpdateDeviceList" :loading="loading">
        åˆ·æ–°æ‰«æ
      </el-button>
    </div>
    <el-table :data="deviceList" stripe class="w-full" v-loading="loading" :height="400">
      <el-table-column prop="name" label="è®¾å¤‡åç§°" min-width="150" />
      <el-table-column prop="address" label="åœ°å€" min-width="120" />
      <el-table-column prop="rssi" label="ä¿¡å·å¼ºåº¦" width="100">
        <template #default="{ row }">
          <span>{{ row.rssi }} dBm</span>
        </template>
      </el-table-column>
      <el-table-column label="æ“ä½œ" width="100">
        <template #default="{ row }">
          <el-button
            size="small"
            type="primary"
            @click="handleConnectDevice(row)"
            :loading="row.connecting"
            :disabled="row.connecting">
            è¿æ¥
          </el-button>
        </template>
      </el-table-column>
    </el-table>
    <div v-if="deviceList.length === 0 && !loading" class="text-center text-gray-400 mt-4 py-8">
      æš‚æ— æ‰«æåˆ°çš„è®¾å¤‡ï¼Œç‚¹å‡»"åˆ·æ–°æ‰«æ"æŒ‰é’®å¼€å§‹æ‰«æ
    </div>
  </el-dialog>

  <!-- æ–‡ä»¶æµè§ˆå¯¹è¯æ¡† -->
  <el-dialog
    v-model="fileBrowserDialogVisible"
    title="é€‰æ‹©æ–‡ä»¶æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨"
    width="800"
    :before-close="handleCloseFileBrowser">
    <div class="m-4">
      <div class="flex items-center gap-2 mb-2">
        <el-input v-model="fileBrowserPath" placeholder="å½“å‰è·¯å¾„" readonly> </el-input>
        <el-button type="primary" @click="handleRefreshFileBrowser" :loading="fileBrowserLoading">
          åˆ·æ–°
        </el-button>
      </div>
      <div class="flex items-center gap-2 mb-2">
        <el-button
          size="small"
          @click="handleFileBrowserNavigateUp"
          :disabled="!fileBrowserCanNavigateUp">
          ä¸Šä¸€çº§
        </el-button>
        <el-button size="small" @click="handleFileBrowserGoToHome"> é¦–é¡µ </el-button>
        <el-button size="small" @click="handleSelectAllFiles"> å…¨é€‰ </el-button>
        <el-button size="small" @click="handleDeselectAllFiles"> å–æ¶ˆå…¨é€‰ </el-button>
        <span v-if="selectedFiles.length > 0" class="text-sm text-blue-600 ml-2">
          å·²é€‰æ‹© {{ selectedFiles.length }} ä¸ªæ–‡ä»¶
        </span>
      </div>
    </div>
    <el-table
      :data="fileBrowserList"
      stripe
      class="w-full"
      v-loading="fileBrowserLoading"
      :height="400"
      @row-click="handleFileBrowserRowClick">
      <el-table-column width="55">
        <template #default="{ row }">
          <el-checkbox
            v-if="!row.isDirectory"
            :model-value="isFileSelected(row)"
            @change="handleToggleFileSelection(row)"
            @click.stop>
          </el-checkbox>
        </template>
      </el-table-column>
      <el-table-column prop="name" label="åç§°" min-width="200">
        <template #default="{ row }">
          <div class="flex items-center gap-2">
            <span v-if="row.isDirectory">ğŸ“</span>
            <span v-else>ğŸ“„</span>
            <span>{{ row.name }}</span>
          </div>
        </template>
      </el-table-column>
      <el-table-column prop="size" label="å¤§å°" width="100">
        <template #default="{ row }">
          <span v-if="!row.isDirectory">{{ formatSize(row.size) }}</span>
          <span v-else>-</span>
        </template>
      </el-table-column>

      <el-table-column label="çŠ¶æ€" width="100">
        <template #default="{ row }">
          <el-tag v-if="!row.isDirectory && isFileSelected(row)" type="success" size="small">
            å·²é€‰æ‹©
          </el-tag>
        </template>
      </el-table-column>
    </el-table>
    <template #footer>
      <div class="flex items-center justify-between">
        <span class="text-sm text-gray-500"> æç¤ºï¼šç‚¹å‡»æ–‡ä»¶å¯åˆ‡æ¢é€‰æ‹©çŠ¶æ€ï¼ŒåŒå‡»ç›®å½•å¯è¿›å…¥ </span>
        <div class="flex gap-2 items-center">
          <el-select v-model="fileBrowserTarget" size="small" style="width: 150px">
            <el-option label="æ·»åŠ åˆ°ä¸»åˆ—è¡¨" value="files"></el-option>
            <el-option label="æ·»åŠ åˆ°å‰ç½®åˆ—è¡¨" value="pre_files"></el-option>
          </el-select>
          <el-button @click="handleCloseFileBrowser">å–æ¶ˆ</el-button>
          <el-button
            type="primary"
            @click="handleAddFilesToPlaylist"
            :loading="playlistLoading"
            :disabled="selectedFiles.length === 0">
            æ·»åŠ  ({{ selectedFiles.length }})
          </el-button>
        </div>
      </div>
    </template>
  </el-dialog>

  <!-- è®¾å¤‡åˆ—è¡¨å¼¹çª— -->
  <el-dialog
    v-model="agentListDialogVisible"
    width="810"
    :before-close="handleCloseAgentListDialog">
    <template #header>
      <div></div>
    </template>
    <div class="flex flex-col gap-4">
      <div>
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <h4 class="text-base font-semibold w-24">Agentè®¾å¤‡</h4>
            <el-button
              type="primary"
              plain
              size="small"
              @click="handleRefreshAgentList"
              :loading="agentListLoading">
              <el-icon v-if="!agentListLoading"><Refresh /></el-icon>
              <span class="ml-1">åˆ·æ–°</span>
            </el-button>
          </div>
        </div>
        <el-table
          :data="agentList"
          stripe
          class="w-full"
          v-loading="agentListLoading"
          :height="200">
          <el-table-column prop="name" label="è®¾å¤‡åç§°" min-width="150" />
          <el-table-column label="è¯¦æƒ…" min-width="250">
            <template #default="{ row }">
              <div class="flex flex-col gap-1">
                <div class="text-sm flex items-start">
                  <span class="text-gray-600 inline-block w-12 flex-shrink-0">åœ°å€ï¼š</span>
                  <span class="text-gray-800">{{ row.address }}</span>
                </div>
                <div class="text-sm flex items-start">
                  <span class="text-gray-600 inline-block w-12 flex-shrink-0">IDï¼š</span>
                  <span class="text-gray-800">{{ row.agent_id }}</span>
                </div>
              </div>
            </template>
          </el-table-column>
          <el-table-column label="æ”¯æŒçš„æ“ä½œ" min-width="100">
            <template #default="{ row }">
              <el-tag
                v-for="action in row.actions"
                :key="action"
                size="small"
                type="info"
                class="mr-1">
                {{ action }}
              </el-tag>
              <span v-if="!row.actions || row.actions.length === 0" class="text-xs text-gray-400"
                >æ— </span
              >
            </template>
          </el-table-column>
          <el-table-column label="çŠ¶æ€/å¿ƒè·³" width="90">
            <template #default="{ row }">
              <div class="flex flex-col items-center gap-1">
                <el-tag :type="row.is_online ? 'success' : 'danger'" size="small">
                  {{ row.is_online ? 'åœ¨çº¿' : 'ç¦»çº¿' }}
                </el-tag>
                <span class="text-xs text-gray-500"> {{ row.last_heartbeat_ago }}ç§’å‰ </span>
              </div>
            </template>
          </el-table-column>
          <el-table-column label="æµ‹è¯•æŒ‰é’®" width="180">
            <template #default="{ row }">
              <div class="flex flex-col gap-1">
                <div class="flex gap-1 items-center">
                  <el-icon class="!w-4 !h-5"><Cpu /></el-icon>
                  <span class="text-[12px] mr-1 !w-4">B1</span>
                  <el-button
                    v-for="i in 2"
                    :key="i"
                    size="small"
                    type="primary"
                    plain
                    @click="handleTestAgentButton(row.agent_id, `F${12 + i}`)"
                    :loading="row[`testing_F${12 + i}`]"
                    class="flex-1">
                    F{{ 12 + i }}
                  </el-button>
                </div>
                <div class="flex gap-1 items-center">
                  <el-icon class="!w-4 !h-5"><Cpu /></el-icon>
                  <span class="text-[12px] mr-1 !w-4">B2</span>
                  <el-button
                    v-for="i in 2"
                    :key="i + 2"
                    size="small"
                    type="primary"
                    plain
                    @click="handleTestAgentButton(row.agent_id, `F${12 + i + 2}`)"
                    :loading="row[`testing_F${12 + i + 2}`]"
                    class="flex-1">
                    F{{ 12 + i + 2 }}
                  </el-button>
                </div>
                <div class="flex gap-1 items-center">
                  <el-icon class="!w-4 !h-5"><Cpu /></el-icon>
                  <span class="text-[12px] mr-1 !w-4">B3</span>
                  <el-button
                    v-for="i in 2"
                    :key="i + 4"
                    size="small"
                    type="primary"
                    plain
                    @click="handleTestAgentButton(row.agent_id, `F${12 + i + 4}`)"
                    :loading="row[`testing_F${12 + i + 4}`]"
                    class="flex-1">
                    F{{ 12 + i + 4 }}
                  </el-button>
                </div>
              </div>
            </template>
          </el-table-column>
          <template #empty>
            <div class="text-center text-gray-400 py-8">æš‚æ— è®¾å¤‡ï¼Œè¯·ç­‰å¾…è®¾å¤‡æ³¨å†Œ</div>
          </template>
        </el-table>
      </div>
      <div>
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <h4 class="text-base font-semibold w-24">å°ç±³è®¾å¤‡</h4>
            <el-button
              type="primary"
              plain
              size="small"
              @click="scanMiDevices"
              :loading="miScanning">
              <el-icon v-if="!miScanning"><Refresh /></el-icon>
              <span class="ml-1">æ‰«æ</span>
            </el-button>
          </div>
        </div>
        <el-table :data="miDeviceList" stripe class="w-full" v-loading="miScanning" :height="280">
          <el-table-column prop="name" label="è®¾å¤‡åç§°" min-width="150" />
          <el-table-column label="è¯¦æƒ…" min-width="400">
            <template #default="{ row }">
              <div class="flex flex-col gap-1">
                <div class="text-sm flex items-start">
                  <span class="text-gray-600 inline-block w-12 flex-shrink-0">IDï¼š</span>
                  <span class="text-gray-800">{{ row.deviceID || '-' }}</span>
                </div>
                <div class="text-sm flex items-start">
                  <span class="text-gray-600 inline-block w-12 flex-shrink-0">åœ°å€ï¼š</span>
                  <span class="text-gray-800 w-40">{{ row.mac || '-' }}</span>
                  <span class="text-gray-600 inline-block w-12 flex-shrink-0">DTDï¼š</span>
                  <span class="text-gray-800 w-40">{{ row.miotDID || '-' }}</span>
                </div>
              </div>
            </template>
          </el-table-column>
          <el-table-column label="åŠŸèƒ½" min-width="200">
            <template #default="{ row }">
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-2">
                  <span class="text-gray-600 inline-block w-12 flex-shrink-0">éŸ³é‡ï¼š</span>
                  <span class="text-gray-800 w-5">
                    {{ row.volume !== undefined ? row.volume : '-' }}
                  </span>
                  <el-button
                    size="small"
                    type="info"
                    plain
                    circle
                    @click="getMiDeviceVolume(row)"
                    :loading="row._volumeRefreshing"
                    :disabled="row._volumeRefreshing || row._volumeChanging"
                    title="åˆ·æ–°éŸ³é‡"
                    class="p-0.5 !w-[17px] !h-[17px]">
                    <el-icon v-if="!row._volumeRefreshing" ><Refresh /></el-icon>
                  </el-button>
                </div>
                <div class="flex items-center gap-2">
                  <el-slider
                    :model-value="row.volume ?? 0"
                    @input="(val) => { row.volume = val; }"
                    @change="(val) => { setMiDeviceVolume(row, val); }"
                    :min="5"
                    :max="100"
                    :step="1"
                    :disabled="row._volumeChanging || row._volumeRefreshing || row.volume === undefined"
                    size ="small"
                    style="flex: 1; max-width: 200px;">
                  </el-slider>
                </div>
              </div>
            </template>
          </el-table-column>
          <template #empty>
            <div class="text-center text-gray-400 py-8">æš‚æ— è®¾å¤‡ï¼Œç‚¹å‡»"æ‰«æè®¾å¤‡"å¼€å§‹æ‰«æ</div>
          </template>
        </el-table>
      </div>
    </div>
  </el-dialog>
</div>
