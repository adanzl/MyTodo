<div class="p-1">
  <!-- 3列布局：播放列表 | 文件列表 | 配置详情 -->
  <div class="flex gap-4 h-[calc(100vh-150px)]">
    <!-- 第一列：播放列表列表 -->
    <div class="w-64 border rounded p-3 flex flex-col">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-semibold">播放列表</h3>
        <div class="flex items-center gap-1">
          <el-button
            type="info"
            size="small"
            plain
            @click="handleOpenAgentListDialog"
            title="设备列表"
            class="!w-8 !h-6 !p-0">
            <el-icon><Monitor /></el-icon>
          </el-button>
          <el-button
            type="primary"
            size="small"
            plain
            @click="refreshPlaylistStatus"
            :loading="playlistRefreshing"
            title="刷新播放列表"
            class="!w-8 !h-6 !p-0">
            <el-icon v-if="!playlistRefreshing"><Refresh /></el-icon>
          </el-button>
          <el-button
            type="success"
            size="small"
            @click="handleCreatePlaylist"
            title="新建播放列表"
            class="!w-8 !h-6 !p-0">
            <el-icon><Plus /></el-icon>
          </el-button>
        </div>
      </div>
      <div
        v-if="playlistCollection && playlistCollection.length > 0"
        class="flex-1 overflow-y-auto space-y-2 pr-1">
        <div
          v-for="playlist in playlistCollection"
          :key="playlist.id"
          class="border rounded px-3 py-2 cursor-pointer hover:bg-gray-50 group min-h-[60px] flex flex-col justify-between"
          :class="{ 'border-blue-500 bg-blue-50': playlist.id === activePlaylistId }"
          @click="handleSelectPlaylist(playlist.id)">
          <!-- 第一行：名称、曲目数量、功能按钮 -->
          <div class="flex items-center justify-between gap-2">
            <div class="text-sm font-medium truncate flex-1 min-w-0">{{ playlist.name }}</div>
            <div class="flex items-center gap-2 flex-shrink-0">
              <span class="text-xs text-gray-500 whitespace-nowrap flex items-center gap-1">
                <el-icon><Headset class="!w-3 !h-3" /></el-icon>
                <span class="whitespace-nowrap w-5 flex items-center justify-center">
                  {{ ((playlist.pre_lists && playlist.pre_lists[getWeekdayIndex()] &&
                  playlist.pre_lists[getWeekdayIndex()].length) || 0) + ((playlist.playlist &&
                  playlist.playlist.length) || 0) }}
                </span>
              </span>
              <div class="flex items-center justify-center">
                <el-dropdown
                  trigger="click"
                  @command="(command) => handlePlaylistMenuCommand(command, playlist.id)"
                  @click.stop>
                  <el-button
                    type="default"
                    size="small"
                    plain
                    circle
                    class="!w-5 !h-5 !min-w-5 !p-0 text-xs"
                    title="更多">
                    <span class="text-base leading-none mb-1">»</span>
                  </el-button>
                  <template #dropdown>
                    <el-dropdown-menu>
                      <el-dropdown-item command="copy">
                        <span>复制</span>
                      </el-dropdown-item>
                      <el-dropdown-item
                        v-if="playlistCollection.length > 1"
                        command="delete"
                        divided>
                        <span class="text-[#f56c6c]">删除</span>
                      </el-dropdown-item>
                    </el-dropdown-menu>
                  </template>
                </el-dropdown>
              </div>
            </div>
          </div>
          <!-- 第二行：下次运行时间（始终存在，保持固定高度） -->
          <div class="text-[10px] text-blue-600 min-h-[14px] flex items-center justify-between">
            <span v-if="getPlaylistNextCronTime(playlist)" class="flex items-center gap-1">
              <el-icon class="!w-3 !h-4"><el-icon-video-play /></el-icon> {{
              getPlaylistNextCronTime(playlist) }}
            </span>
            <span v-else class="invisible">占位</span>
            <span v-if="playlist.trigger_button" class="text-gray-500 flex items-center gap-1">
              <el-icon class="!w-3 !h-4"><Cpu /></el-icon> {{ playlist.trigger_button }}
            </span>
          </div>
        </div>
      </div>
      <div v-else class="flex-1 flex items-center justify-center text-sm text-gray-400">
        暂无播放列表，请点击"新建"创建
      </div>
    </div>

    <!-- 第二列：文件列表 -->
    <div class="flex-1 border rounded p-3 flex flex-col">
      <div class="flex items-center justify-between mb-3">
        <div class="flex-1 min-w-0">
          <div v-if="playlistStatus" class="flex items-center gap-2 mb-1">
            <div
              v-if="editingPlaylistId !== activePlaylistId"
              class="flex items-center gap-2 flex-1 min-w-0">
              <h3 class="text-lg font-semibold truncate">{{ playlistStatus.name }}</h3>
              <el-button
                type="plain"
                size="small"
                circle
                @click="handleStartEditPlaylistName(activePlaylistId)"
                title="编辑名称">
                <el-icon><Edit /></el-icon>
              </el-button>
            </div>
            <div v-else class="flex items-center gap-2 flex-1 min-w-0">
              <el-input
                :model-value="editingPlaylistName"
                @input="(val) => editingPlaylistName = val"
                @blur="handleSavePlaylistName(activePlaylistId)"
                @keyup.enter="handleSavePlaylistName(activePlaylistId)"
                @keyup.esc="handleCancelEditPlaylistName"
                size="small"
                class="flex-1"
                :data-playlist-id="activePlaylistId"
                ref="editPlaylistNameInput">
              </el-input>
            </div>
          </div>
          <div v-else>
            <h3 class="text-lg font-semibold">播放列表文件</h3>
          </div>
          <div class="text-sm text-gray-500" v-if="playlistStatus">
            <span v-if="getPlaylistTotalDuration() > 0" class="mr-2">
              总时长：{{ formatDuration(getPlaylistTotalDuration()) }}
            </span>
            <template v-if="playlistStatus">
              <template
                v-if="(getCurrentPreFiles()?.length || 0) + (playlistStatus.playlist?.length || 0) > 0">
                共 {{ (getCurrentPreFiles()?.length || 0) + (playlistStatus.playlist?.length || 0)
                }} 首， 当前:
                <template
                  v-if="playlistStatus.pre_index !== undefined && playlistStatus.pre_index !== null && playlistStatus.pre_index >= 0">
                  {{ playlistStatus.pre_index + 1 }}
                </template>
                <template
                  v-else-if="playlistStatus.current_index !== undefined && playlistStatus.current_index !== null && playlistStatus.current_index >= 0">
                  {{ (getCurrentPreFiles()?.length || 0) + playlistStatus.current_index + 1 }}
                </template>
                <template v-else> - </template>
                / {{ (getCurrentPreFiles()?.length || 0) + (playlistStatus.playlist?.length || 0) }}
              </template>
              <template v-else> 共 0 首， 当前: - / 0 </template>
            </template>
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <el-button
            type="default"
            size="small"
            plain
            circle
            @click="handleOpenBatchDrawer"
            title="批量模式">
            <el-icon><Collection /></el-icon>
          </el-button>
          <el-button
            type="plain"
            size="small"
            circle
            @click="handlePlayPlaylist"
            class="items-center justify-center"
            :disabled="!playlistStatus || !playlistStatus.playlist || playlistStatus.playlist.length === 0 || !!playlistStatus.isPlaying"
            title="播放">
            <el-icon v-if="playing" size="12" class="animate-spin"><Loading /></el-icon>
            <span v-else>▶</span>
          </el-button>
          <el-button
            type="plain"
            size="small"
            circle
            @click="handlePlayPre"
            :disabled="!playlistStatus || ((!getCurrentPreFiles() || getCurrentPreFiles().length === 0) && (!playlistStatus.playlist || playlistStatus.playlist.length === 0))"
            title="上一首">
            <el-icon v-if="playing" size="12" class="animate-spin"><Loading /></el-icon>
            <span v-else>⏮</span>
          </el-button>
          <el-button
            type="plain"
            size="small"
            circle
            @click="handlePlayNext"
            :disabled="!playlistStatus || ((!getCurrentPreFiles() || getCurrentPreFiles().length === 0) && (!playlistStatus.playlist || playlistStatus.playlist.length === 0))"
            title="下一首">
            <el-icon v-if="playing" size="12" class="animate-spin"><Loading /></el-icon>
            <span v-else>⏭</span>
          </el-button>
          <el-button type="plain" size="small" circle @click="handleStopPlaylist" title="停止">
            <el-icon v-if="stopping" size="12" class="animate-spin"><Loading /></el-icon>
            <span v-else>⏹</span>
          </el-button>
          <el-button
            v-show="showMoreActions"
            type="plain"
            size="small"
            circle
            @click="handleClearPlaylist"
            :disabled="!playlistStatus || ((!playlistStatus.pre_files || playlistStatus.pre_files.length === 0) && (!playlistStatus.playlist || playlistStatus.playlist.length === 0)) || playlistLoading"
            title="清空列表（包括前置文件和正式文件）">
            <el-icon><Delete /></el-icon>
          </el-button>
          <el-button
            type="plain"
            size="small"
            circle
            @click="showMoreActions = !showMoreActions"
            title="更多">
            <el-icon><el-icon-menu /></el-icon>
          </el-button>
        </div>
      </div>

      <div v-if="playlistStatus" class="flex-1 overflow-y-auto">
        <!-- pre_files 列表 -->
        <div class="border rounded p-2 mb-2">
          <!-- 第一行：标题和星期选择按钮 -->
          <div class="flex items-center justify-between mb-2">
            <div class="text-xs font-semibold text-gray-600 w-39">前置文件（播放时优先播放）</div>
            <div class="flex items-center gap-1">
              <!-- 星期选择按钮 -->
              <div class="flex items-center gap-1">
                <el-button
                  v-for="(day, index) in ['周一', '周二', '周三', '周四', '周五', '周六', '周日']"
                  :key="index"
                  :type="selectedWeekdayIndex === index || (selectedWeekdayIndex === null && getWeekdayIndex() === index) ? 'primary' : 'default'"
                  size="small"
                  plain
                  @click="handleSelectWeekday(index)"
                  :title="day"
                  class="!w-16 !h-6 !p-0 text-xs">
                  {{ day }}<span class="text-[10px]"
                    >[{{ getPreFilesCountForWeekday(index) }}]</span
                  >
                </el-button>
              </div>
            </div>
          </div>
          <!-- 第二行：统计信息和操作按钮 -->
          <div class="flex items-center justify-between text-xs text-gray-500 mb-2 pr-2.5">
            <div class="flex items-center">
              <span v-if="getPreFilesTotalDuration() > 0">
                总时长：{{ formatDuration(getPreFilesTotalDuration()) }}
              </span>
              <span
                v-if="getCurrentPreFiles() && getCurrentPreFiles().length > 0"
                :class="getPreFilesTotalDuration() > 0 ? 'ml-2' : ''">
                共 {{ getCurrentPreFiles().length }} 首， 当前: {{ playlistStatus.pre_index !==
                undefined && playlistStatus.pre_index !== null && playlistStatus.pre_index >= 0 ?
                playlistStatus.pre_index + 1 : '-' }} / {{ getCurrentPreFiles().length }}
              </span>
              <el-tag
                v-if="playlistStatus.isPlaying && playlistStatus.in_pre_files === true"
                type="success"
                size="small"
                class="ml-2">
                播放中
              </el-tag>
            </div>
            <div class="flex items-center gap-1">
              <el-button
                type="primary"
                size="small"
                plain
                @click="handleOpenFileBrowserForPreFiles"
                :disabled="!playlistStatus || preFilesDragMode || preFilesBatchDeleteMode">
                +
              </el-button>
              <el-button
                :type="preFilesDragMode ? 'success' : 'default'"
                size="small"
                plain
                class="!w-8 !h-6"
                @click="handleTogglePreFilesDragMode"
                :disabled="!playlistStatus || !getCurrentPreFiles() || getCurrentPreFiles().length === 0 || preFilesBatchDeleteMode"
                :title="preFilesDragMode ? '点击退出拖拽排序模式' : '点击进入拖拽排序模式'">
                <el-icon v-if="preFilesDragMode"><Check /></el-icon>
                <ion-icon v-else class="!w-3.5 !h-3.5" name="chevron-expand-sharp"></ion-icon>
              </el-button>
              <el-button
                :type="preFilesBatchDeleteMode ? 'success' : 'default'"
                size="small"
                plain
                class="!w-8 !h-6"
                @click="handleTogglePreFilesBatchDeleteMode"
                :disabled="!playlistStatus || !getCurrentPreFiles() || getCurrentPreFiles().length === 0 || preFilesDragMode"
                :title="preFilesBatchDeleteMode ? '点击退出批量删除模式' : '点击进入批量删除模式'">
                <el-icon v-if="preFilesBatchDeleteMode"><Check /></el-icon>
                <el-icon v-else><Delete /></el-icon>
              </el-button>
              <el-button
                v-show="preFilesBatchDeleteMode"
                type="danger"
                size="small"
                plain
                class="!w-8 !h-6"
                @click="handleBatchDeletePreFiles"
                :disabled="playlistLoading || selectedPreFileIndices.length === 0"
                :title="`删除选中的 ${selectedPreFileIndices.length} 项`">
                <el-icon><Delete /></el-icon>
              </el-button>
              <el-button
                type="default"
                size="small"
                plain
                class="!w-8 !h-6"
                v-show="showMoreActions && !preFilesBatchDeleteMode"
                @click="handleClearPreFiles"
                :disabled="!playlistStatus || !getCurrentPreFiles() || getCurrentPreFiles().length === 0 || playlistLoading || preFilesDragMode"
                title="清空列表">
                <el-icon><CircleClose /></el-icon>
              </el-button>
            </div>
          </div>
          <!-- 前置文件列表 -->
          <div
            v-if="getCurrentPreFiles() && getCurrentPreFiles().length > 0"
            class="overflow-y-scroll scrollbar-overlay"
            :class="{ 'max-h-[192px]': !preFilesExpanded }">
            <div
              v-for="(file, index) in getCurrentPreFiles()"
              :key="'pre-' + index"
              class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded"
              :class="{ 
                'bg-blue-50': playlistStatus.pre_index === index,
                'bg-blue-100': preFilesBatchDeleteMode && selectedPreFileIndices.includes(index)
              }"
              :class="{ 'cursor-move': preFilesDragMode, 'cursor-pointer': preFilesBatchDeleteMode && !preFilesDragMode, 'cursor-default': !preFilesDragMode && !preFilesBatchDeleteMode, 'select-none': true }"
              :draggable="preFilesDragMode"
              @click="preFilesBatchDeleteMode && !preFilesDragMode ? handleTogglePreFileSelection(index) : null"
              @dragstart="handlePreFileDragStart($event, index)"
              @dragend="handlePreFileDragEnd($event)"
              @dragover.prevent="handlePreFileDragOver($event)"
              @dragleave="(e) => { if (e.currentTarget) { e.currentTarget.classList.remove('bg-gray-100', 'border-t-2', 'border-b-2', 'border-blue-500'); } }"
              @drop.prevent="handlePreFileDrop($event, index)">
              <span class="text-xs text-gray-500 w-8">{{ index + 1 }}</span>
              <span
                id="pre-file-name"
                class="flex-1 text-sm truncate"
                :class="{ 'text-blue-600': playlistStatus.pre_index === index }"
                :title="file.uri">
                {{ file.uri.split('/').pop() }}
              </span>
              <div class="flex items-center gap-1 flex-shrink-0" @mousedown.stop @click.stop>
                <media-component
                  v-show="!preFilesBatchDeleteMode"
                  :file="file"
                  :is-playing="isFilePlaying(file)"
                  :progress="getFilePlayProgress(file)"
                  :duration="getFileDuration(file)"
                  :disabled="playlistLoading"
                  @play="handlePlayFileInBrowser(file)"
                  @seek="(file, val) => handleSeekFile(file, val)">
                </media-component>
                <el-checkbox
                  v-show="preFilesBatchDeleteMode"
                  class="!h-6"
                  :model-value="selectedPreFileIndices.includes(index)"
                  @change="handleTogglePreFileSelection(index)"
                  @click.stop>
                </el-checkbox>
                <el-button
                  v-show="showMoreActions && !preFilesDragMode && !preFilesBatchDeleteMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleMovePreFileUp(index)"
                  :disabled="index === 0 || playlistLoading"
                  title="上移">
                  ↑
                </el-button>
                <el-button
                  v-show="showMoreActions && !preFilesDragMode && !preFilesBatchDeleteMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleMovePreFileDown(index)"
                  :disabled="index === getCurrentPreFiles().length - 1 || playlistLoading"
                  title="下移">
                  ↓
                </el-button>
                <el-button
                  v-show="showMoreActions && !preFilesDragMode && !preFilesBatchDeleteMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleReplacePreFile(index)"
                  :disabled="playlistLoading"
                  title="替换">
                  <el-icon><Refresh /></el-icon>
                </el-button>
                <el-button
                  v-show="!preFilesBatchDeleteMode && !preFilesDragMode"
                  type="info"
                  size="small"
                  plain
                  circle
                  @click.stop="handleOpenPlaylistSelectorForPreFile(file)"
                  :disabled="playlistLoading"
                  title="应用到列表">
                  <el-icon><DocumentCopy /></el-icon>
                </el-button>
                <el-button
                  v-show="!preFilesBatchDeleteMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleDeletePreFile(index)"
                  :disabled="playlistLoading || preFilesDragMode"
                  title="删除">
                  <el-icon><Minus /></el-icon>
                </el-button>
              </div>
            </div>
          </div>
          <div
            v-if="getCurrentPreFiles() && getCurrentPreFiles().length > 0"
            class="w-full border-t border-gray-200">
            <el-button
              type="plain"
              size="small"
              class="!w-full !h-4 !p-0 !text-xs"
              @click="handleTogglePreFilesExpand"
              :title="preFilesExpanded ? '折叠' : '展开'">
              <el-icon v-if="preFilesExpanded"><ArrowUp /></el-icon>
              <el-icon v-else><ArrowDown /></el-icon>
            </el-button>
          </div>
          <div v-else class="text-sm text-gray-400 text-center py-1">前置文件列表为空</div>
        </div>

        <!-- files 列表 -->
        <div v-if="playlistStatus.playlist" class="border rounded p-2">
          <div class="flex items-center justify-between mb-2 pr-2.5">
            <div class="text-xs font-semibold text-gray-600">
              正式文件（播放时记录进度）
              <span v-if="getFilesTotalDuration() > 0" class="ml-2 text-gray-500">
                总时长：{{ formatDuration(getFilesTotalDuration()) }}
              </span>
              <span
                v-if="playlistStatus.playlist && playlistStatus.playlist.length > 0"
                class="ml-2 text-gray-500">
                共 {{ playlistStatus.playlist.length }} 首， 当前: {{ playlistStatus.current_index
                !== undefined ? playlistStatus.current_index + 1 : '-' }} / {{
                playlistStatus.playlist.length }}
              </span>
              <el-tag
                v-if="playlistStatus.isPlaying && playlistStatus.in_pre_files === false"
                type="success"
                size="small"
                class="ml-2">
                播放中
              </el-tag>
            </div>
            <div class="flex items-center gap-1">
              <el-button
                type="primary"
                plain
                size="small"
                class="!w-8 !h-6"
                @click="handleOpenFileBrowser"
                :disabled="!playlistStatus || filesDragMode || filesBatchDeleteMode">
                +
              </el-button>
              <el-button
                :type="filesDragMode ? 'success' : 'default'"
                plain
                size="small"
                class="!w-8 !h-6"
                @click="handleToggleFilesDragMode"
                :disabled="!playlistStatus || !playlistStatus.playlist || playlistStatus.playlist.length === 0 || filesBatchDeleteMode"
                :title="filesDragMode ? '点击退出拖拽排序模式' : '点击进入拖拽排序模式'">
                <el-icon v-if="filesDragMode"><Check /></el-icon>
                <ion-icon v-else class="!w-3.5 !h-3.5" name="chevron-expand-sharp"></ion-icon>
              </el-button>
              <el-button
                :type="filesBatchDeleteMode ? 'success' : 'default'"
                plain
                size="small"
                class="!w-8 !h-6"
                @click="handleToggleFilesBatchDeleteMode"
                :disabled="!playlistStatus || !playlistStatus.playlist || playlistStatus.playlist.length === 0 || filesDragMode"
                :title="filesBatchDeleteMode ? '点击退出批量删除模式' : '点击进入批量删除模式'">
                <el-icon v-if="filesBatchDeleteMode"><Check /></el-icon>
                <el-icon v-else><Delete /></el-icon>
              </el-button>
              <el-button
                v-show="filesBatchDeleteMode"
                type="danger"
                plain
                size="small"
                class="!w-8 !h-6"
                @click="handleBatchDeleteFiles"
                :disabled="playlistLoading || selectedFileIndices.length === 0"
                :title="`删除选中的 ${selectedFileIndices.length} 项`">
                <el-icon><Delete /></el-icon>
              </el-button>
              <el-button
                type="default"
                plain
                size="small"
                class="!w-8 !h-6"
                v-show="showMoreActions && !filesBatchDeleteMode"
                @click="handleClearFiles"
                :disabled="!playlistStatus || !playlistStatus.playlist || playlistStatus.playlist.length === 0 || playlistLoading || filesDragMode"
                title="清空正式文件列表">
                <el-icon><CircleClose /></el-icon>
              </el-button>
            </div>
          </div>
          <div
            v-if="playlistStatus.playlist && playlistStatus.playlist.length > 0"
            class="overflow-y-scroll scrollbar-overlay">
            <div
              v-for="(file, index) in playlistStatus.playlist"
              :key="index"
              class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded"
              :class="{ 
                'bg-blue-50': index === playlistStatus.current_index,
                'bg-blue-100': filesBatchDeleteMode && selectedFileIndices.includes(index)
              }"
              :class="{ 'cursor-move': filesDragMode, 'cursor-pointer': filesBatchDeleteMode && !filesDragMode, 'cursor-default': !filesDragMode && !filesBatchDeleteMode, 'select-none': true }"
              :draggable="filesDragMode"
              @click="filesBatchDeleteMode && !filesDragMode ? handleToggleFileSelection(index) : null"
              @dragstart="handleFileDragStart($event, index)"
              @dragend="handleFileDragEnd($event)"
              @dragover.prevent="handleFileDragOver($event)"
              @dragleave="(e) => { if (e.currentTarget) { e.currentTarget.classList.remove('bg-gray-100', 'border-t-2', 'border-b-2', 'border-blue-500'); } }"
              @drop.prevent="handleFileDrop($event, index)">
              <span class="text-xs text-gray-500 w-8">{{ index + 1 }}</span>
              <span
                class="flex-1 text-sm truncate"
                :class="{ 'text-blue-600': index === playlistStatus.current_index }"
                :title="file.uri">
                {{ file.uri.split('/').pop() }}
              </span>
              <div class="flex items-center gap-1 flex-shrink-0" @mousedown.stop @click.stop>
                <media-component
                  v-show="!filesBatchDeleteMode"
                  :file="file"
                  :is-playing="isFilePlaying(file)"
                  :progress="getFilePlayProgress(file)"
                  :duration="getFileDuration(file)"
                  :disabled="playlistLoading"
                  @play="handlePlayFileInBrowser(file)"
                  @seek="(file, val) => handleSeekFile(file, val)">
                </media-component>
                <el-checkbox
                  v-show="filesBatchDeleteMode"
                  class="!h-6"
                  :model-value="selectedFileIndices.includes(index)"
                  @change="handleToggleFileSelection(index)"
                  @click.stop>
                </el-checkbox>
                <el-button
                  v-show="showMoreActions && !filesDragMode && !filesBatchDeleteMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleMovePlaylistItemUp(index)"
                  :disabled="index === 0 || playlistLoading"
                  title="上移">
                  ↑
                </el-button>
                <el-button
                  v-show="showMoreActions && !filesDragMode && !filesBatchDeleteMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleMovePlaylistItemDown(index)"
                  :disabled="index === playlistStatus.playlist.length - 1 || playlistLoading"
                  title="下移">
                  ↓
                </el-button>
                <el-button
                  v-show="showMoreActions && !filesDragMode && !filesBatchDeleteMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleReplacePlaylistItem(index)"
                  :disabled="playlistLoading"
                  title="替换">
                  <el-icon><Refresh /></el-icon>
                </el-button>
                <el-button
                  v-show="!filesBatchDeleteMode && !filesDragMode"
                  type="info"
                  size="small"
                  plain
                  circle
                  @click.stop="handleOpenPlaylistSelectorForFile(file)"
                  :disabled="playlistLoading"
                  title="应用到列表">
                  <el-icon><DocumentCopy /></el-icon>
                </el-button>
                <el-button
                  v-show="!filesBatchDeleteMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleDeletePlaylistItem(index)"
                  :disabled="playlistLoading || filesDragMode"
                  title="删除">
                  <el-icon><Minus /></el-icon>
                </el-button>
              </div>
            </div>
          </div>
          <div v-else class="text-sm text-gray-400 text-center py-1">正式文件列表为空</div>
        </div>
        <div
          v-else-if="(!getCurrentPreFiles() || getCurrentPreFiles().length === 0)"
          class="text-sm text-gray-400 text-center py-8">
          当前播放列表为空，点击"添加文件"开始构建播放列表
        </div>
      </div>
      <div v-else class="flex-1 flex items-center justify-center text-sm text-gray-400">
        请先在左侧选择一个播放列表查看详情
      </div>
    </div>

    <!-- 第三列：配置详情（Cron + 设备） -->
    <div class="w-80 min-w-75 border rounded p-3 flex flex-col">
      <h3 class="text-lg font-semibold mb-3">配置详情</h3>

      <div v-if="playlistStatus" class="flex-1 overflow-y-auto space-y-4">
        <!-- Cron 定时任务配置 -->
        <div class="border rounded p-3">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-semibold">定时任务 (Cron)</h4>
            <el-switch
              :model-value="playlistStatus.schedule?.enabled === 1"
              @change="(val) => handleTogglePlaylistCronEnabled(val)"
              active-text="开启"
              inactive-text="关闭">
            </el-switch>
          </div>

          <div class="space-y-2">
            <div>
              <div class="text-xs text-gray-600 mb-1">Cron 表达式</div>
              <div class="flex items-center gap-2">
                <el-input
                  :model-value="playlistStatus.schedule?.cron || ''"
                  @input="(val) => handleUpdatePlaylistCron(val)"
                  placeholder="例如: 0 0 * * *"
                  size="small"
                  :disabled="playlistStatus.schedule?.enabled !== 1">
                </el-input>
                <el-button
                  type="info"
                  size="small"
                  @click="handleOpenCronBuilder"
                  :disabled="playlistStatus.schedule?.enabled !== 1">
                  助手
                </el-button>
              </div>
            </div>

            <div class="flex items-start gap-4">
              <div class="flex-1">
                <div class="text-xs text-gray-600 mb-1">持续时间（分钟）</div>
                <el-input-number
                  :model-value="playlistStatus.schedule?.duration || 0"
                  @change="handleUpdatePlaylistDuration"
                  :min="0"
                  :max="1440"
                  :step="1"
                  size="small"
                  :disabled="playlistStatus.schedule?.enabled !== 1"
                  class="w-full">
                </el-input-number>
                <div class="text-xs text-gray-500 mt-1">0表示不自动停止</div>
              </div>
              <div class="flex-1">
                <div class="text-xs text-gray-600 mb-1">触发按钮</div>
                <el-select
                  :model-value="playlistStatus.trigger_button || ''"
                  @change="handleUpdateTriggerButton"
                  placeholder="选择触发按钮"
                  size="small"
                  class="w-full"
                  clearable>
                  <el-option label="空" value="" />
                  <el-option label="按钮对-1" value="B1" />
                  <el-option label="按钮对-2" value="B2" />
                  <el-option label="按钮对-3" value="B3" />
                </el-select>
              </div>
            </div>

            <div v-if="playlistStatus.schedule?.cron && playlistStatus.schedule?.enabled === 1">
              <el-button
                type="success"
                size="small"
                @click="handlePreviewPlaylistCron"
                class="w-full">
                预览执行时间
              </el-button>
            </div>
          </div>
        </div>

        <!-- 设备配置 -->
        <div class="border rounded p-3">
          <h4 class="text-sm font-semibold mb-2">设备配置</h4>

          <div class="space-y-2">
            <div>
              <div class="text-xs text-gray-600 mb-1">设备类型</div>
              <el-select
                :model-value="playlistStatus.device?.type || playlistStatus.device_type || null"
                @change="handleUpdatePlaylistDeviceType"
                placeholder="选择设备类型"
                size="small"
                class="w-full">
                <el-option label="蓝牙" value="bluetooth" />
                <el-option label="DLNA" value="dlna" />
                <el-option label="设备代理" value="agent" />
                <el-option label="小米设备" value="mi" />
              </el-select>
            </div>

            <div>
              <div class="text-xs text-gray-600 mb-1 flex items-center gap-2">
                <span>设备地址</span>
                <span v-if="playlistStatus.device?.name" class="text-xs text-gray-500">
                  {{ playlistStatus.device.name }}
                </span>
              </div>
              <div class="flex items-center gap-2">
                <el-input
                  :model-value="playlistStatus.device?.address || playlistStatus.device_address || ''"
                  @input="(val) => handleUpdatePlaylistDeviceAddress(val)"
                  placeholder="设备地址"
                  size="small"
                  class="flex-1">
                </el-input>
                <el-button
                  size="small"
                  type="danger"
                  plain
                  @click="handleUpdatePlaylistDeviceAddress('')"
                  :disabled="!playlistStatus.device?.address && !playlistStatus.device_address"
                  title="清空设备地址">
                  清空
                </el-button>
              </div>
            </div>
          </div>

          <!-- 设备列表 -->
          <div class="mt-3">
            <div class="flex items-center justify-between mb-2">
              <h5 class="text-xs font-semibold text-gray-700">
                <span
                  v-if="playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent' || playlistStatus.device?.type === 'bluetooth' || playlistStatus.device_type === 'bluetooth'">
                  已配对的设备
                </span>
                <span
                  v-else-if="playlistStatus.device?.type === 'dlna' || playlistStatus.device_type === 'dlna'">
                  DLNA 设备
                </span>
                <span
                  v-else-if="playlistStatus.device?.type === 'mi' || playlistStatus.device_type === 'mi'">
                  小米设备
                </span>
                <span v-else>设备列表</span>
              </h5>
              <el-button
                v-if="playlistStatus.device?.type === 'dlna' || playlistStatus.device_type === 'dlna'"
                type="primary"
                size="small"
                @click="scanDlnaDevices"
                :loading="dlnaScanning">
                扫描设备
              </el-button>
              <el-button
                v-if="playlistStatus.device?.type === 'mi' || playlistStatus.device_type === 'mi'"
                type="primary"
                size="small"
                @click="scanMiDevices"
                :loading="miScanning">
                扫描设备
              </el-button>
              <el-button
                v-if="playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent' || playlistStatus.device?.type === 'bluetooth' || playlistStatus.device_type === 'bluetooth'"
                type="primary"
                size="small"
                @click="handleOpenScanDialog">
                扫描设备
              </el-button>
            </div>

            <!-- 设备代理类型：显示已配对设备 -->
            <div
              v-if="playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent' || playlistStatus.device?.type === 'bluetooth' || playlistStatus.device_type === 'bluetooth'">
              <div class="space-y-2 max-h-[200px] overflow-y-auto" v-loading="loading">
                <div
                  v-for="device in connectedDeviceList"
                  :key="device.address"
                  class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50">
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">{{ device.name }}</div>
                    <div class="text-xs text-gray-500 truncate">{{ device.address }}</div>
                  </div>
                  <div class="flex-shrink-0">
                    <el-button
                      size="small"
                      type="primary"
                      @click="(playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent') ? handleSelectAgentDevice(device) : handleSelectBluetoothDevice(device.address)"
                      :disabled="device.address === (playlistStatus.device?.address || playlistStatus.device_address)">
                      选择
                    </el-button>
                  </div>
                </div>
                <div
                  v-if="connectedDeviceList.length === 0"
                  class="text-xs text-gray-400 text-center py-4">
                  暂无设备
                </div>
              </div>
            </div>

            <!-- DLNA 类型：显示 DLNA 设备 -->
            <div
              v-else-if="playlistStatus.device?.type === 'dlna' || playlistStatus.device_type === 'dlna'">
              <div class="space-y-2 max-h-[200px] overflow-y-auto" v-loading="dlnaScanning">
                <div
                  v-for="device in dlnaDeviceList"
                  :key="device.location"
                  class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50">
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">{{ device.name }}</div>
                    <div class="text-xs text-gray-500 truncate" :title="device.location">
                      {{ device.location }}
                    </div>
                  </div>
                  <div class="flex-shrink-0">
                    <el-button
                      size="small"
                      type="primary"
                      @click="handleUpdatePlaylistDeviceAddress(device.location, device.name)"
                      :disabled="device.location === (playlistStatus.device?.address || playlistStatus.device_address)">
                      选择
                    </el-button>
                  </div>
                </div>
                <div
                  v-if="dlnaDeviceList.length === 0 && !dlnaScanning"
                  class="text-xs text-gray-400 text-center py-4">
                  暂无设备，点击"扫描设备"开始扫描
                </div>
              </div>
            </div>

            <!-- 小米设备类型：显示小米设备 -->
            <div
              v-else-if="playlistStatus.device?.type === 'mi' || playlistStatus.device_type === 'mi'">
              <div class="space-y-2 max-h-[200px] overflow-y-auto" v-loading="miScanning">
                <div
                  v-for="device in miDeviceList"
                  :key="device.deviceID || device.address"
                  class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50">
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">{{ device.name }}</div>
                    <div
                      class="text-xs text-gray-500 truncate"
                      :title="device.deviceID || device.address">
                      {{ device.deviceID || device.address }}
                    </div>
                  </div>
                  <div class="flex-shrink-0">
                    <el-button
                      size="small"
                      type="primary"
                      @click="handleSelectMiDevice(device)"
                      :disabled="(device.deviceID || device.address) === (playlistStatus.device?.address || playlistStatus.device_address)">
                      选择
                    </el-button>
                  </div>
                </div>
                <div
                  v-if="miDeviceList.length === 0 && !miScanning"
                  class="text-xs text-gray-400 text-center py-4">
                  暂无设备，点击"扫描设备"开始扫描
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div v-else class="flex-1 flex items-center justify-center text-sm text-gray-400">
        请先选择一个播放列表
      </div>
    </div>
  </div>

  <!-- Cron 可视化生成弹窗 -->
  <cron-dialog
    :visible="cronBuilderVisible"
    :initial-cron="initialCronExpr"
    @update:visible="cronBuilderVisible = $event"
    @apply="handleCronBuilderApply"
    @preview="handleCronBuilderPreview"
    @close="handleCloseCronBuilder">
  </cron-dialog>

  <!-- Cron 预览弹窗 -->
  <cron-preview-dialog
    :visible="cronPreviewVisible"
    :times="cronPreviewTimes"
    @update:visible="cronPreviewVisible = $event"
    @close="cronPreviewVisible = false">
  </cron-preview-dialog>

  <!-- 扫描设备弹窗 -->
  <el-dialog
    v-model="scanDialogVisible"
    title="扫描到的设备"
    width="800"
    :before-close="handleCloseScanDialog">
    <div class="mb-4">
      <el-button type="primary" @click="handleUpdateDeviceList" :loading="loading">
        刷新扫描
      </el-button>
    </div>
    <el-table :data="deviceList" stripe class="w-full" v-loading="loading" :height="400">
      <el-table-column prop="name" label="设备名称" min-width="150" />
      <el-table-column prop="address" label="地址" min-width="120" />
      <el-table-column prop="rssi" label="信号强度" width="100">
        <template #default="{ row }">
          <span>{{ row.rssi }} dBm</span>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="100">
        <template #default="{ row }">
          <el-button
            size="small"
            type="primary"
            @click="handleConnectDevice(row)"
            :loading="row.connecting"
            :disabled="row.connecting">
            连接
          </el-button>
        </template>
      </el-table-column>
    </el-table>
    <div v-if="deviceList.length === 0 && !loading" class="text-center text-gray-400 mt-4 py-8">
      暂无扫描到的设备，点击"刷新扫描"按钮开始扫描
    </div>
  </el-dialog>

  <!-- 文件浏览对话框 -->
  <!-- 文件对话框 -->
  <file-dialog
    :visible="fileBrowserDialogVisible"
    @update:visible="fileBrowserDialogVisible = $event"
    title="选择文件添加到播放列表"
    confirm-button-text="添加"
    :confirm-loading="playlistLoading"
    @confirm="handleFileBrowserConfirm"
    @close="handleCloseFileBrowser">
    <template #footer-prepend>
      <el-select v-model="fileBrowserTarget" size="small" class="w-[150px]">
        <el-option label="添加到主列表" value="files"></el-option>
        <el-option label="添加到前置列表" value="pre_files"></el-option>
      </el-select>
    </template>
  </file-dialog>

  <!-- 设备列表弹窗 -->
  <devices-dialog
    v-if="agentListDialogVisible && DevicesDialog"
    :visible="agentListDialogVisible"
    @update:visible="agentListDialogVisible = $event">
  </devices-dialog>

  <!-- 批量模式管理器 -->
  <batch-drawer
    v-if="batchDrawerVisible && BatchDrawer"
    :visible="batchDrawerVisible"
    :playlist-collection="playlistCollection"
    @update:visible="batchDrawerVisible = $event">
  </batch-drawer>

  <!-- 应用到列表选择器 -->
  <playlist-selector
    v-if="playlistSelectorVisible && PlaylistSelector"
    :visible="playlistSelectorVisible"
    :playlist-collection="playlistCollection"
    :selected-files="playlistSelectorSelectedFiles"
    @update:visible="playlistSelectorVisible = $event">
  </playlist-selector>
</div>
