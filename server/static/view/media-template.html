<div class="p-1">
  <!-- 3列布局：播放列表 | 文件列表 | 配置详情 -->
  <div class="flex gap-4 h-[calc(100vh-150px)]">
    <!-- 第一列：播放列表列表 -->
    <div class="w-64 border rounded p-3 flex flex-col">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-semibold">播放列表</h3>
        <div class="flex items-center gap-1">
          <el-button
            type="info"
            size="small"
            plain
            @click="handleOpenAgentListDialog"
            class="!w-8 !h-6 !p-0">
            <el-icon><Monitor /></el-icon>
          </el-button>
          <el-button
            type="primary"
            size="small"
            plain
            @click="refreshPlaylistStatus"
            :loading="playlistRefreshing"
            class="!w-8 !h-6 !p-0">
            <el-icon v-if="!playlistRefreshing"><Refresh /></el-icon>
          </el-button>
          <el-button
            type="success"
            size="small"
            @click="handleCreatePlaylist"
            class="!w-8 !h-6 !p-0">
            <el-icon><Plus /></el-icon>
          </el-button>
        </div>
      </div>
      <div
        v-if="playlistCollection && playlistCollection.length > 0"
        class="flex-1 overflow-y-auto space-y-2 pr-1">
        <div
          v-for="playlist in playlistCollection"
          :key="playlist.id"
          class="border rounded px-3 py-2 cursor-pointer hover:bg-gray-50 group min-h-[60px] flex flex-col justify-between"
          :class="{ 'border-blue-500 bg-blue-50': playlist.id === activePlaylistId }"
          @click="handleSelectPlaylist(playlist.id)">
          <!-- 第一行：名称、曲目数量、功能按钮 -->
          <div class="flex items-center justify-between gap-2">
            <div class="text-sm font-medium truncate flex-1 min-w-0">{{ playlist.name }}</div>
            <div class="flex items-center gap-2 flex-shrink-0">
              <span class="text-xs text-gray-500 whitespace-nowrap flex items-center gap-1">
                <el-icon><Headset class="!w-3 !h-3" /></el-icon>
                <span class="whitespace-nowrap w-5 flex items-center justify-center"
                  >{{ ((playlist.pre_files && playlist.pre_files.length) || 0) + ((playlist.playlist
                  && playlist.playlist.length) || 0) }}</span
                >
              </span>
              <div class="flex items-center justify-center">
                <el-dropdown
                  trigger="click"
                  @command="(command) => handlePlaylistMenuCommand(command, playlist.id)"
                  @click.stop>
                  <el-button
                    type="default"
                    size="small"
                    plain
                    circle
                    class="!w-5 !h-5 !min-w-5 !p-0 text-xs"
                    title="更多">
                    <span style="font-size: 16px; line-height: 1" class="mb-1">»</span>
                  </el-button>
                  <template #dropdown>
                    <el-dropdown-menu>
                      <el-dropdown-item command="copy">
                        <span>复制</span>
                      </el-dropdown-item>
                      <el-dropdown-item
                        v-if="playlistCollection.length > 1"
                        command="delete"
                        divided>
                        <span style="color: #f56c6c">删除</span>
                      </el-dropdown-item>
                    </el-dropdown-menu>
                  </template>
                </el-dropdown>
              </div>
            </div>
          </div>
          <!-- 第二行：下次运行时间（始终存在，保持固定高度） -->
          <div class="text-[10px] text-blue-600 min-h-[14px] flex items-center justify-between">
            <span v-if="getPlaylistNextCronTime(playlist)" class="flex items-center gap-1">
              <el-icon class="!w-3 !h-4"><VideoPlay /></el-icon> {{
              getPlaylistNextCronTime(playlist) }}
            </span>
            <span v-else class="invisible">占位</span>
            <span v-if="playlist.trigger_button" class="text-gray-500 flex items-center gap-1">
              <el-icon class="!w-3 !h-4"><Cpu /></el-icon> {{ playlist.trigger_button }}
            </span>
          </div>
        </div>
      </div>
      <div v-else class="flex-1 flex items-center justify-center text-sm text-gray-400">
        暂无播放列表，请点击"新建"创建
      </div>
    </div>

    <!-- 第二列：文件列表 -->
    <div class="flex-1 border rounded p-3 flex flex-col">
      <div class="flex items-center justify-between mb-3">
        <div class="flex-1 min-w-0">
          <div v-if="playlistStatus" class="flex items-center gap-2 mb-1">
            <div
              v-if="editingPlaylistId !== activePlaylistId"
              class="flex items-center gap-2 flex-1 min-w-0">
              <h3 class="text-lg font-semibold truncate">{{ playlistStatus.name }}</h3>
              <el-button
                type="plain"
                size="small"
                circle
                @click="handleStartEditPlaylistName(activePlaylistId)"
                title="编辑名称">
                <el-icon><Edit /></el-icon>
              </el-button>
            </div>
            <div v-else class="flex items-center gap-2 flex-1 min-w-0">
              <el-input
                :model-value="editingPlaylistName"
                @input="(val) => editingPlaylistName = val"
                @blur="handleSavePlaylistName(activePlaylistId)"
                @keyup.enter="handleSavePlaylistName(activePlaylistId)"
                @keyup.esc="handleCancelEditPlaylistName"
                size="small"
                class="flex-1"
                :data-playlist-id="activePlaylistId"
                ref="editPlaylistNameInput">
              </el-input>
            </div>
          </div>
          <div v-else>
            <h3 class="text-lg font-semibold">播放列表文件</h3>
          </div>
          <div class="text-sm text-gray-500" v-if="playlistStatus">
            <span v-if="getPlaylistTotalDuration() > 0" class="mr-2">
              总时长：{{ formatDuration(getPlaylistTotalDuration()) }}
            </span>
            <template v-if="playlistStatus">
              <template
                v-if="(playlistStatus.pre_files?.length || 0) + (playlistStatus.playlist?.length || 0) > 0">
                共 {{ (playlistStatus.pre_files?.length || 0) + (playlistStatus.playlist?.length ||
                0) }} 首， 当前:
                <template
                  v-if="playlistStatus.pre_index !== undefined && playlistStatus.pre_index !== null && playlistStatus.pre_index >= 0">
                  {{ playlistStatus.pre_index + 1 }}
                </template>
                <template
                  v-else-if="playlistStatus.current_index !== undefined && playlistStatus.current_index !== null && playlistStatus.current_index >= 0">
                  {{ (playlistStatus.pre_files?.length || 0) + playlistStatus.current_index + 1 }}
                </template>
                <template v-else> - </template>
                / {{ (playlistStatus.pre_files?.length || 0) + (playlistStatus.playlist?.length ||
                0) }}
              </template>
              <template v-else> 共 0 首， 当前: - / 0 </template>
            </template>
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <el-button
            type="plain"
            size="small"
            circle
            @click="showMoreActions = !showMoreActions"
            title="更多">
            <el-icon><el-icon-menu /></el-icon>
          </el-button>
          <el-button
            type="plain"
            size="small"
            circle
            @click="handlePlayPlaylist"
            class="items-center justify-center"
            :disabled="!playlistStatus || !playlistStatus.playlist || playlistStatus.playlist.length === 0 || !!playlistStatus.isPlaying"
            title="播放">
            <el-icon v-if="playing" size="12" class="animate-spin"><Loading /></el-icon>
            <span v-else>▶</span>
          </el-button>
          <el-button
            type="plain"
            size="small"
            circle
            @click="handlePlayPre"
            :disabled="!playlistStatus || ((!playlistStatus.pre_files || playlistStatus.pre_files.length === 0) && (!playlistStatus.playlist || playlistStatus.playlist.length === 0))"
            title="上一首">
            <el-icon v-if="playing" size="12" class="animate-spin"><Loading /></el-icon>
            <span v-else>⏮</span>
          </el-button>
          <el-button
            type="plain"
            size="small"
            circle
            @click="handlePlayNext"
            :disabled="!playlistStatus || ((!playlistStatus.pre_files || playlistStatus.pre_files.length === 0) && (!playlistStatus.playlist || playlistStatus.playlist.length === 0))"
            title="下一首">
            <el-icon v-if="playing" size="12" class="animate-spin"><Loading /></el-icon>
            <span v-else>⏭</span>
          </el-button>
          <el-button type="plain" size="small" circle @click="handleStopPlaylist" title="停止">
            <el-icon v-if="stopping" size="12" class="animate-spin"><Loading /></el-icon>
            <span v-else>⏹</span>
          </el-button>
          <el-button
            v-show="showMoreActions"
            type="plain"
            size="small"
            circle
            @click="handleClearPlaylist"
            :disabled="!playlistStatus || ((!playlistStatus.pre_files || playlistStatus.pre_files.length === 0) && (!playlistStatus.playlist || playlistStatus.playlist.length === 0)) || playlistLoading"
            title="清空列表（包括前置文件和正式文件）">
            <el-icon><Delete /></el-icon>
          </el-button>
        </div>
      </div>

      <div v-if="playlistStatus" class="flex-1 overflow-y-auto">
        <!-- pre_files 列表 -->
        <div class="border rounded p-2 mb-2">
          <div class="flex items-center justify-between mb-2">
            <div class="text-xs font-semibold text-gray-600">
              前置文件（播放时优先播放）
              <span v-if="getPreFilesTotalDuration() > 0" class="ml-2 text-gray-500">
                {{ formatDuration(getPreFilesTotalDuration()) }}
              </span>
              <span
                v-if="playlistStatus.pre_files && playlistStatus.pre_files.length > 0"
                class="ml-2 text-gray-500">
                共 {{ playlistStatus.pre_files.length }} 首， 当前: {{ playlistStatus.pre_index !==
                undefined && playlistStatus.pre_index !== null && playlistStatus.pre_index >= 0 ?
                playlistStatus.pre_index + 1 : '-' }} / {{ playlistStatus.pre_files.length }}
              </span>
              <el-tag
                v-if="playlistStatus.isPlaying && playlistStatus.in_pre_files === true"
                type="success"
                size="small"
                class="ml-2">
                播放中
              </el-tag>
            </div>
            <div class="flex items-center gap-1 pr-1">
              <el-button
                type="primary"
                size="small"
                plain
                @click="handleOpenFileBrowserForPreFiles"
                :disabled="!playlistStatus || preFilesDragMode">
                +
              </el-button>
              <el-button
                :type="preFilesDragMode ? 'success' : 'default'"
                size="small"
                plain
                class="!w-8 !h-6"
                @click="handleTogglePreFilesDragMode"
                :disabled="!playlistStatus || !playlistStatus.pre_files || playlistStatus.pre_files.length === 0"
                :title="preFilesDragMode ? '点击退出拖拽排序模式' : '点击进入拖拽排序模式'">
                <el-icon v-if="preFilesDragMode"><Check /></el-icon>
                <ion-icon v-else class="!w-3.5 !h-3.5" name="chevron-expand-sharp"></ion-icon>
              </el-button>
              <el-button
                type="danger"
                size="small"
                circle
                plain
                @click="handleClearPreFiles"
                :disabled="!playlistStatus || !playlistStatus.pre_files || playlistStatus.pre_files.length === 0 || playlistLoading || preFilesDragMode"
                title="清空列表">
                <el-icon><Delete /></el-icon>
              </el-button>
            </div>
          </div>
          <div v-if="playlistStatus.pre_files && playlistStatus.pre_files.length > 0">
            <div
              v-for="(file, index) in playlistStatus.pre_files"
              :key="'pre-' + index"
              class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded"
              :class="{ 
                'bg-blue-50': playlistStatus.pre_index !== undefined && playlistStatus.pre_index !== null && index === playlistStatus.pre_index
              }"
              :style="{ cursor: preFilesDragMode ? 'move' : 'default', userSelect: 'none' }"
              :draggable="preFilesDragMode"
              @dragstart="handlePreFileDragStart($event, index)"
              @dragend="handlePreFileDragEnd($event)"
              @dragover.prevent="handlePreFileDragOver($event)"
              @dragleave="(e) => { if (e.currentTarget) { e.currentTarget.style.backgroundColor = ''; e.currentTarget.style.borderTop = ''; e.currentTarget.style.borderBottom = ''; } }"
              @drop.prevent="handlePreFileDrop($event, index)">
              <span class="text-xs text-gray-500 w-8">{{ index + 1 }}</span>
              <span
                class="flex-1 text-sm truncate"
                :class="{ 'text-blue-600': playlistStatus.pre_index !== undefined && playlistStatus.pre_index !== null && index === playlistStatus.pre_index }"
                :title="file.uri">
                {{ file.uri.split('/').pop() }}
              </span>
              <el-tag
                v-if="file.duration"
                type="info"
                size="small"
                class="whitespace-nowrap w-16 text-center">
                {{ formatDuration(file.duration) }}
              </el-tag>
              <div v-else class="w-16"></div>
              <div class="flex items-center gap-1" @mousedown.stop @click.stop>
                <el-button
                  v-show="showMoreActions && !preFilesDragMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleMovePreFileUp(index)"
                  :disabled="index === 0 || playlistLoading"
                  title="上移">
                  ↑
                </el-button>
                <el-button
                  v-show="showMoreActions && !preFilesDragMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleMovePreFileDown(index)"
                  :disabled="index === playlistStatus.pre_files.length - 1 || playlistLoading"
                  title="下移">
                  ↓
                </el-button>
                <el-button
                  v-show="showMoreActions && !preFilesDragMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleCopyPreFile(index)"
                  :disabled="playlistLoading"
                  title="复制到末尾">
                  <el-icon><DocumentCopy /></el-icon>
                </el-button>
                <el-button
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleDeletePreFile(index)"
                  :disabled="playlistLoading || preFilesDragMode"
                  title="删除">
                  <el-icon><Minus /></el-icon>
                </el-button>
              </div>
            </div>
          </div>
          <div v-else class="text-sm text-gray-400 text-center py-1">前置文件列表为空</div>
        </div>

        <!-- files 列表 -->
        <div v-if="playlistStatus.playlist" class="border rounded p-2">
          <div class="flex items-center justify-between mb-2 pr-1">
            <div class="text-xs font-semibold text-gray-600">
              正式文件（播放时记录进度）
              <span v-if="getFilesTotalDuration() > 0" class="ml-2 text-gray-500">
                {{ formatDuration(getFilesTotalDuration()) }}
              </span>
              <span
                v-if="playlistStatus.playlist && playlistStatus.playlist.length > 0"
                class="ml-2 text-gray-500">
                共 {{ playlistStatus.playlist.length }} 首， 当前: {{ playlistStatus.current_index
                !== undefined ? playlistStatus.current_index + 1 : '-' }} / {{
                playlistStatus.playlist.length }}
              </span>
              <el-tag
                v-if="playlistStatus.isPlaying && playlistStatus.in_pre_files === false"
                type="success"
                size="small"
                class="ml-2">
                播放中
              </el-tag>
            </div>
            <div class="flex items-center gap-1">
              <el-button
                type="primary"
                plain
                size="small"
                class="!w-8 !h-6"
                @click="handleOpenFileBrowser"
                :disabled="!playlistStatus || filesDragMode">
                +
              </el-button>
              <el-button
                :type="filesDragMode ? 'success' : 'default'"
                plain
                size="small"
                class="!w-8 !h-6"
                @click="handleToggleFilesDragMode"
                :disabled="!playlistStatus || !playlistStatus.playlist || playlistStatus.playlist.length === 0"
                :title="filesDragMode ? '点击退出拖拽排序模式' : '点击进入拖拽排序模式'">
                <el-icon v-if="filesDragMode"><Check /></el-icon>
                <ion-icon v-else class="!w-3.5 !h-3.5" name="chevron-expand-sharp"></ion-icon>
              </el-button>
              <el-button
                type="danger"
                plain
                size="small"
                circle
                @click="handleClearFiles"
                :disabled="!playlistStatus || !playlistStatus.playlist || playlistStatus.playlist.length === 0 || playlistLoading || filesDragMode"
                title="清空正式文件列表">
                <el-icon><Delete /></el-icon>
              </el-button>
            </div>
          </div>
          <div v-if="playlistStatus.playlist && playlistStatus.playlist.length > 0">
            <div
              v-for="(file, index) in playlistStatus.playlist"
              :key="index"
              class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded"
              :class="{ 
                'bg-blue-50': index === playlistStatus.current_index
              }"
              :style="{ cursor: filesDragMode ? 'move' : 'default', userSelect: 'none' }"
              :draggable="filesDragMode"
              @dragstart="handleFileDragStart($event, index)"
              @dragend="handleFileDragEnd($event)"
              @dragover.prevent="handleFileDragOver($event)"
              @dragleave="(e) => { if (e.currentTarget) { e.currentTarget.style.backgroundColor = ''; e.currentTarget.style.borderTop = ''; e.currentTarget.style.borderBottom = ''; } }"
              @drop.prevent="handleFileDrop($event, index)">
              <span class="text-xs text-gray-500 w-8">{{ index + 1 }}</span>
              <span
                class="flex-1 text-sm truncate"
                :class="{ 'text-blue-600': index === playlistStatus.current_index }"
                :title="file.uri">
                {{ file.uri.split('/').pop() }}
              </span>
              <el-tag
                v-if="file.duration"
                type="info"
                size="small"
                class="whitespace-nowrap w-16 text-center">
                {{ formatDuration(file.duration) }}
              </el-tag>
              <div v-else class="w-16"></div>
              <!-- <el-tag v-if="index === playlistStatus.current_index" type="success" size="small">
                当前
              </el-tag> -->
              <div class="flex items-center gap-1" @mousedown.stop @click.stop>
                <el-button
                  v-show="showMoreActions && !filesDragMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleMovePlaylistItemUp(index)"
                  :disabled="index === 0 || playlistLoading"
                  title="上移">
                  ↑
                </el-button>
                <el-button
                  v-show="showMoreActions && !filesDragMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleMovePlaylistItemDown(index)"
                  :disabled="index === playlistStatus.playlist.length - 1 || playlistLoading"
                  title="下移">
                  ↓
                </el-button>
                <el-button
                  v-show="showMoreActions && !filesDragMode"
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleCopyPlaylistItem(index)"
                  :disabled="playlistLoading"
                  title="复制到末尾">
                  <el-icon><DocumentCopy /></el-icon>
                </el-button>
                <el-button
                  type="plain"
                  size="small"
                  circle
                  @click.stop="handleDeletePlaylistItem(index)"
                  :disabled="playlistLoading || filesDragMode"
                  title="删除">
                  <el-icon><Minus /></el-icon>
                </el-button>
              </div>
            </div>
          </div>
          <div v-else class="text-sm text-gray-400 text-center py-1">正式文件列表为空</div>
        </div>
        <div
          v-else-if="(!playlistStatus.pre_files || playlistStatus.pre_files.length === 0)"
          class="text-sm text-gray-400 text-center py-8">
          当前播放列表为空，点击"添加文件"开始构建播放列表
        </div>
      </div>
      <div v-else class="flex-1 flex items-center justify-center text-sm text-gray-400">
        请先在左侧选择一个播放列表查看详情
      </div>
    </div>

    <!-- 第三列：配置详情（Cron + 设备） -->
    <div class="w-80 border rounded p-3 flex flex-col">
      <h3 class="text-lg font-semibold mb-3">配置详情</h3>

      <div v-if="playlistStatus" class="flex-1 overflow-y-auto space-y-4">
        <!-- Cron 定时任务配置 -->
        <div class="border rounded p-3">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-semibold">定时任务 (Cron)</h4>
            <el-switch
              :model-value="playlistStatus.schedule?.enabled === 1"
              @change="(val) => handleTogglePlaylistCronEnabled(val)"
              active-text="开启"
              inactive-text="关闭">
            </el-switch>
          </div>

          <div class="space-y-2">
            <div>
              <div class="text-xs text-gray-600 mb-1">Cron 表达式</div>
              <div class="flex items-center gap-2">
                <el-input
                  :model-value="playlistStatus.schedule?.cron || ''"
                  @input="(val) => handleUpdatePlaylistCron(val)"
                  placeholder="例如: 0 0 * * *"
                  size="small"
                  :disabled="playlistStatus.schedule?.enabled !== 1">
                </el-input>
                <el-button
                  type="info"
                  size="small"
                  @click="handleOpenCronBuilder"
                  :disabled="playlistStatus.schedule?.enabled !== 1"
                  >助手</el-button
                >
              </div>
            </div>

            <div class="flex items-start gap-4">
              <div class="flex-1">
                <div class="text-xs text-gray-600 mb-1">持续时间（分钟）</div>
                <el-input-number
                  :model-value="playlistStatus.schedule?.duration || 0"
                  @change="handleUpdatePlaylistDuration"
                  :min="0"
                  :max="1440"
                  :step="1"
                  size="small"
                  :disabled="playlistStatus.schedule?.enabled !== 1"
                  class="w-full">
                </el-input-number>
                <div class="text-xs text-gray-500 mt-1">0表示不自动停止</div>
              </div>
              <div class="flex-1">
                <div class="text-xs text-gray-600 mb-1">触发按钮</div>
                <el-select
                  :model-value="playlistStatus.trigger_button || ''"
                  @change="handleUpdateTriggerButton"
                  placeholder="选择触发按钮"
                  size="small"
                  class="w-full"
                  clearable>
                  <el-option label="空" value="" />
                  <el-option label="按钮对-1" value="B1" />
                  <el-option label="按钮对-2" value="B2" />
                  <el-option label="按钮对-3" value="B3" />
                </el-select>
              </div>
            </div>

            <div v-if="playlistStatus.schedule?.cron && playlistStatus.schedule?.enabled === 1">
              <el-button
                type="success"
                size="small"
                @click="handlePreviewPlaylistCron"
                class="w-full">
                预览执行时间
              </el-button>
            </div>
          </div>
        </div>

        <!-- 设备配置 -->
        <div class="border rounded p-3">
          <h4 class="text-sm font-semibold mb-2">设备配置</h4>

          <div class="space-y-2">
            <div>
              <div class="text-xs text-gray-600 mb-1">设备类型</div>
              <el-select
                :model-value="playlistStatus.device?.type || playlistStatus.device_type || ''"
                @change="handleUpdatePlaylistDeviceType"
                placeholder="选择设备类型"
                size="small"
                class="w-full">
                <el-option label="蓝牙" value="bluetooth" />
                <el-option label="DLNA" value="dlna" />
                <el-option label="设备代理" value="agent" />
                <el-option label="小米设备" value="mi" />
              </el-select>
            </div>

            <div>
              <div class="text-xs text-gray-600 mb-1 flex items-center gap-2">
                <span>设备地址</span>
                <span v-if="playlistStatus.device?.name" class="text-xs text-gray-500">
                  {{ playlistStatus.device.name }}
                </span>
              </div>
              <div class="flex items-center gap-2">
                <el-input
                  :model-value="playlistStatus.device?.address || playlistStatus.device_address || ''"
                  @input="(val) => handleUpdatePlaylistDeviceAddress(val)"
                  placeholder="设备地址"
                  size="small"
                  class="flex-1">
                </el-input>
                <el-button
                  size="small"
                  type="danger"
                  plain
                  @click="handleUpdatePlaylistDeviceAddress('')"
                  :disabled="!playlistStatus.device?.address && !playlistStatus.device_address"
                  title="清空设备地址">
                  清空
                </el-button>
              </div>
            </div>
          </div>

          <!-- 设备列表 -->
          <div class="mt-3">
            <div class="flex items-center justify-between mb-2">
              <h5 class="text-xs font-semibold text-gray-700">
                <span
                  v-if="playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent' || playlistStatus.device?.type === 'bluetooth' || playlistStatus.device_type === 'bluetooth'">
                  已配对的设备
                </span>
                <span
                  v-else-if="playlistStatus.device?.type === 'dlna' || playlistStatus.device_type === 'dlna'">
                  DLNA 设备
                </span>
                <span
                  v-else-if="playlistStatus.device?.type === 'mi' || playlistStatus.device_type === 'mi'">
                  小米设备
                </span>
                <span v-else>设备列表</span>
              </h5>
              <el-button
                v-if="playlistStatus.device?.type === 'dlna' || playlistStatus.device_type === 'dlna'"
                type="primary"
                size="small"
                @click="scanDlnaDevices"
                :loading="dlnaScanning">
                扫描设备
              </el-button>
              <el-button
                v-if="playlistStatus.device?.type === 'mi' || playlistStatus.device_type === 'mi'"
                type="primary"
                size="small"
                @click="scanMiDevices"
                :loading="miScanning">
                扫描设备
              </el-button>
              <el-button
                v-if="playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent' || playlistStatus.device?.type === 'bluetooth' || playlistStatus.device_type === 'bluetooth'"
                type="primary"
                size="small"
                @click="handleOpenScanDialog">
                扫描设备
              </el-button>
            </div>

            <!-- 设备代理类型：显示已配对设备 -->
            <div
              v-if="playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent' || playlistStatus.device?.type === 'bluetooth' || playlistStatus.device_type === 'bluetooth'">
              <div class="space-y-2 max-h-[200px] overflow-y-auto" v-loading="loading">
                <div
                  v-for="device in connectedDeviceList"
                  :key="device.address"
                  class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50">
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">{{ device.name }}</div>
                    <div class="text-xs text-gray-500 truncate">{{ device.address }}</div>
                  </div>
                  <div class="flex-shrink-0">
                    <el-button
                      size="small"
                      type="primary"
                      @click="(playlistStatus.device?.type === 'agent' || playlistStatus.device_type === 'agent') ? handleSelectAgentDevice(device) : handleSelectBluetoothDevice(device.address)"
                      :disabled="device.address === (playlistStatus.device?.address || playlistStatus.device_address)">
                      选择
                    </el-button>
                  </div>
                </div>
                <div
                  v-if="connectedDeviceList.length === 0"
                  class="text-xs text-gray-400 text-center py-4">
                  暂无设备
                </div>
              </div>
            </div>

            <!-- DLNA 类型：显示 DLNA 设备 -->
            <div
              v-else-if="playlistStatus.device?.type === 'dlna' || playlistStatus.device_type === 'dlna'">
              <div class="space-y-2 max-h-[200px] overflow-y-auto" v-loading="dlnaScanning">
                <div
                  v-for="device in dlnaDeviceList"
                  :key="device.location"
                  class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50">
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">{{ device.name }}</div>
                    <div class="text-xs text-gray-500 truncate" :title="device.location">
                      {{ device.location }}
                    </div>
                  </div>
                  <div class="flex-shrink-0">
                    <el-button
                      size="small"
                      type="primary"
                      @click="handleUpdatePlaylistDeviceAddress(device.location, device.name)"
                      :disabled="device.location === (playlistStatus.device?.address || playlistStatus.device_address)">
                      选择
                    </el-button>
                  </div>
                </div>
                <div
                  v-if="dlnaDeviceList.length === 0 && !dlnaScanning"
                  class="text-xs text-gray-400 text-center py-4">
                  暂无设备，点击"扫描设备"开始扫描
                </div>
              </div>
            </div>

            <!-- 小米设备类型：显示小米设备 -->
            <div
              v-else-if="playlistStatus.device?.type === 'mi' || playlistStatus.device_type === 'mi'">
              <div class="space-y-2 max-h-[200px] overflow-y-auto" v-loading="miScanning">
                <div
                  v-for="device in miDeviceList"
                  :key="device.deviceID || device.address"
                  class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50">
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">{{ device.name }}</div>
                    <div
                      class="text-xs text-gray-500 truncate"
                      :title="device.deviceID || device.address">
                      {{ device.deviceID || device.address }}
                    </div>
                  </div>
                  <div class="flex-shrink-0">
                    <el-button
                      size="small"
                      type="primary"
                      @click="handleSelectMiDevice(device)"
                      :disabled="(device.deviceID || device.address) === (playlistStatus.device?.address || playlistStatus.device_address)">
                      选择
                    </el-button>
                  </div>
                </div>
                <div
                  v-if="miDeviceList.length === 0 && !miScanning"
                  class="text-xs text-gray-400 text-center py-4">
                  暂无设备，点击"扫描设备"开始扫描
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div v-else class="flex-1 flex items-center justify-center text-sm text-gray-400">
        请先选择一个播放列表
      </div>
    </div>
  </div>

  <!-- Cron 可视化生成弹窗 -->
  <el-dialog
    v-model="cronBuilderVisible"
    title="Cron 表达式生成器"
    width="700"
    :before-close="handleCloseCronBuilder">
    <div class="space-y-4 m-4">
      <!-- 秒 -->
      <div>
        <div class="text-sm font-medium mb-2">秒 (0-59)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.second"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每秒钟</el-radio>
            <el-radio label="0" class="!w-[80px]">第0秒</el-radio>
            <el-radio label="30" class="!w-[80px]">第30秒</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.secondCustom"
            placeholder="例如: 0,30 或 */10"
            :disabled="cronBuilder.second !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 分 -->
      <div>
        <div class="text-sm font-medium mb-2">分 (0-59)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.minute"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每分钟</el-radio>
            <el-radio label="0" class="!w-[80px]">第0分</el-radio>
            <el-radio label="30" class="!w-[80px]">第30分</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.minuteCustom"
            placeholder="例如: 0,30 或 */15"
            :disabled="cronBuilder.minute !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 时 -->
      <div>
        <div class="text-sm font-medium mb-2">时 (0-23)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.hour"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每小时</el-radio>
            <el-radio label="0" class="!w-[80px]">0点</el-radio>
            <el-radio label="9" class="!w-[80px]">9点</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.hourCustom"
            placeholder="例如: 9,12,18 或 */2"
            :disabled="cronBuilder.hour !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 日 -->
      <div>
        <div class="text-sm font-medium mb-2">日 (1-31)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.day"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每天</el-radio>
            <el-radio label="1" class="!w-[80px]">每月1号</el-radio>
            <el-radio label="15" class="!w-[80px]">每月15号</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.dayCustom"
            placeholder="例如: 1,15 或 */5"
            :disabled="cronBuilder.day !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 月 -->
      <div>
        <div class="text-sm font-medium mb-2">月 (1-12)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.month"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每月</el-radio>
            <el-radio label="1" class="!w-[80px]">1月</el-radio>
            <el-radio label="6" class="!w-[80px]">6月</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.monthCustom"
            placeholder="例如: 1,6,12 或 */3"
            :disabled="cronBuilder.month !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 周 -->
      <div>
        <div class="text-sm font-medium mb-2">周 (0-7, 0和7表示周日)</div>
        <div class="flex items-center gap-2">
          <el-radio-group
            v-model="cronBuilder.weekday"
            @change="updateCronExpression"
            class="flex items-center">
            <el-radio label="*" class="!w-[80px]">每天</el-radio>
            <el-radio label="1-5" class="!w-[80px]">工作日</el-radio>
            <el-radio label="0,6" class="!w-[80px]">周末</el-radio>
            <el-radio label="custom" class="!w-[80px]">自定义</el-radio>
          </el-radio-group>
          <el-input
            v-model="cronBuilder.weekdayCustom"
            placeholder="例如: 1,3,5 或 1-5"
            :disabled="cronBuilder.weekday !== 'custom'"
            class="!w-[200px]"
            @input="updateCronExpression">
          </el-input>
        </div>
      </div>

      <!-- 生成的 Cron 表达式 -->
      <div class="border-t pt-4">
        <div class="text-sm font-medium mb-2">生成的 Cron 表达式：</div>
        <el-input v-model="cronBuilder.generated" readonly class="mb-2"> </el-input>
        <div class="flex gap-2">
          <el-button type="primary" size="small" @click="handleApplyCronExpression">
            应用
          </el-button>
          <el-button type="info" size="small" @click="handlePreviewGeneratedCron">
            预览执行时间
          </el-button>
        </div>
      </div>

      <!-- 常用示例 -->
      <div class="border-t pt-4">
        <div class="text-sm font-medium mb-2">常用示例：</div>
        <div class="space-y-2">
          <div class="flex items-center gap-2 flex-wrap">
            <el-button size="small" @click="applyExample('0 0 * * *')"> 每天0点 </el-button>
            <el-button size="small" @click="applyExample('0 */30 * * *')"> 每30分钟 </el-button>
            <el-button size="small" @click="applyExample('0 0 9 * * 1-5')"> 工作日9点 </el-button>
            <el-button size="small" @click="applyExample('0 0 0 1 * *')"> 每月1号0点 </el-button>
          </div>
        </div>
      </div>
    </div>
  </el-dialog>

  <!-- Cron 预览弹窗 -->
  <el-dialog v-model="cronPreviewVisible" title="Cron 执行时间预览" width="500">
    <div v-if="cronPreviewTimes.length > 0">
      <div class="text-sm text-gray-600 mb-3">下5次执行时间：</div>
      <el-timeline>
        <el-timeline-item
          v-for="(time, index) in cronPreviewTimes"
          :key="index"
          :timestamp="time"
          placement="top">
          <div class="font-medium">第 {{ index + 1 }} 次执行</div>
        </el-timeline-item>
      </el-timeline>
    </div>
    <div v-else class="text-center text-gray-400 py-4">
      无法解析 Cron 表达式，请检查格式是否正确
    </div>
  </el-dialog>

  <!-- 扫描设备弹窗 -->
  <el-dialog
    v-model="scanDialogVisible"
    title="扫描到的设备"
    width="800"
    :before-close="handleCloseScanDialog">
    <div class="mb-4">
      <el-button type="primary" @click="handleUpdateDeviceList" :loading="loading">
        刷新扫描
      </el-button>
    </div>
    <el-table :data="deviceList" stripe class="w-full" v-loading="loading" :height="400">
      <el-table-column prop="name" label="设备名称" min-width="150" />
      <el-table-column prop="address" label="地址" min-width="120" />
      <el-table-column prop="rssi" label="信号强度" width="100">
        <template #default="{ row }">
          <span>{{ row.rssi }} dBm</span>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="100">
        <template #default="{ row }">
          <el-button
            size="small"
            type="primary"
            @click="handleConnectDevice(row)"
            :loading="row.connecting"
            :disabled="row.connecting">
            连接
          </el-button>
        </template>
      </el-table-column>
    </el-table>
    <div v-if="deviceList.length === 0 && !loading" class="text-center text-gray-400 mt-4 py-8">
      暂无扫描到的设备，点击"刷新扫描"按钮开始扫描
    </div>
  </el-dialog>

  <!-- 文件浏览对话框 -->
  <!-- 文件对话框 -->
  <file-dialog
    :visible="fileBrowserDialogVisible"
    @update:visible="fileBrowserDialogVisible = $event"
    title="选择文件添加到播放列表"
    confirm-button-text="添加"
    :confirm-loading="playlistLoading"
    @confirm="handleFileBrowserConfirm"
    @close="handleCloseFileBrowser">
    <template #footer-prepend>
      <el-select v-model="fileBrowserTarget" size="small" style="width: 150px">
        <el-option label="添加到主列表" value="files"></el-option>
        <el-option label="添加到前置列表" value="pre_files"></el-option>
      </el-select>
    </template>
  </file-dialog>

  <!-- 设备列表弹窗 -->
  <el-dialog
    v-model="agentListDialogVisible"
    width="810"
    :before-close="handleCloseAgentListDialog">
    <template #header>
      <div></div>
    </template>
    <div class="flex flex-col gap-4">
      <div>
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <h4 class="text-base font-semibold w-24">Agent设备</h4>
            <el-button
              type="primary"
              plain
              size="small"
              @click="handleRefreshAgentList"
              :loading="agentListLoading">
              <el-icon v-if="!agentListLoading"><Refresh /></el-icon>
              <span class="ml-1">刷新</span>
            </el-button>
          </div>
        </div>
        <el-table
          :data="agentList"
          stripe
          class="w-full"
          v-loading="agentListLoading"
          :height="200">
          <el-table-column prop="name" label="设备名称" min-width="150" />
          <el-table-column label="详情" min-width="250">
            <template #default="{ row }">
              <div class="flex flex-col gap-1">
                <div class="text-sm flex items-start">
                  <span class="text-gray-600 inline-block w-12 flex-shrink-0">地址：</span>
                  <span class="text-gray-800">{{ row.address }}</span>
                </div>
                <div class="text-sm flex items-start">
                  <span class="text-gray-600 inline-block w-12 flex-shrink-0">ID：</span>
                  <span class="text-gray-800">{{ row.agent_id }}</span>
                </div>
              </div>
            </template>
          </el-table-column>
          <el-table-column label="支持的操作" min-width="100">
            <template #default="{ row }">
              <el-tag
                v-for="action in row.actions"
                :key="action"
                size="small"
                type="info"
                class="mr-1">
                {{ action }}
              </el-tag>
              <span v-if="!row.actions || row.actions.length === 0" class="text-xs text-gray-400"
                >无</span
              >
            </template>
          </el-table-column>
          <el-table-column label="状态/心跳" width="90">
            <template #default="{ row }">
              <div class="flex flex-col items-center gap-1">
                <el-tag :type="row.is_online ? 'success' : 'danger'" size="small">
                  {{ row.is_online ? '在线' : '离线' }}
                </el-tag>
                <span class="text-xs text-gray-500"> {{ row.last_heartbeat_ago }}秒前 </span>
              </div>
            </template>
          </el-table-column>
          <el-table-column label="测试按钮" width="180">
            <template #default="{ row }">
              <div class="flex flex-col gap-1">
                <div class="flex gap-1 items-center">
                  <el-icon class="!w-4 !h-5"><Cpu /></el-icon>
                  <span class="text-[12px] mr-1 !w-4">B1</span>
                  <el-button
                    v-for="i in 2"
                    :key="i"
                    size="small"
                    type="primary"
                    plain
                    @click="handleTestAgentButton(row.agent_id, `F${12 + i}`)"
                    :loading="row[`testing_F${12 + i}`]"
                    class="flex-1">
                    F{{ 12 + i }}
                  </el-button>
                </div>
                <div class="flex gap-1 items-center">
                  <el-icon class="!w-4 !h-5"><Cpu /></el-icon>
                  <span class="text-[12px] mr-1 !w-4">B2</span>
                  <el-button
                    v-for="i in 2"
                    :key="i + 2"
                    size="small"
                    type="primary"
                    plain
                    @click="handleTestAgentButton(row.agent_id, `F${12 + i + 2}`)"
                    :loading="row[`testing_F${12 + i + 2}`]"
                    class="flex-1">
                    F{{ 12 + i + 2 }}
                  </el-button>
                </div>
                <div class="flex gap-1 items-center">
                  <el-icon class="!w-4 !h-5"><Cpu /></el-icon>
                  <span class="text-[12px] mr-1 !w-4">B3</span>
                  <el-button
                    v-for="i in 2"
                    :key="i + 4"
                    size="small"
                    type="primary"
                    plain
                    @click="handleTestAgentButton(row.agent_id, `F${12 + i + 4}`)"
                    :loading="row[`testing_F${12 + i + 4}`]"
                    class="flex-1">
                    F{{ 12 + i + 4 }}
                  </el-button>
                </div>
              </div>
            </template>
          </el-table-column>
          <template #empty>
            <div class="text-center text-gray-400 py-8">暂无设备，请等待设备注册</div>
          </template>
        </el-table>
      </div>
      <div>
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <h4 class="text-base font-semibold w-24">小米设备</h4>
            <el-button
              type="primary"
              plain
              size="small"
              @click="scanMiDevices"
              :loading="miScanning">
              <el-icon v-if="!miScanning"><Refresh /></el-icon>
              <span class="ml-1">扫描</span>
            </el-button>
          </div>
        </div>
        <el-table :data="miDeviceList" stripe class="w-full" v-loading="miScanning" :height="280">
          <el-table-column prop="name" label="设备名称" min-width="150" />
          <el-table-column label="详情" min-width="400">
            <template #default="{ row }">
              <div class="flex flex-col gap-1">
                <div class="text-sm flex items-start">
                  <span class="text-gray-600 inline-block w-12 flex-shrink-0">ID：</span>
                  <span class="text-gray-800">{{ row.deviceID || '-' }}</span>
                </div>
                <div class="text-sm flex items-start">
                  <span class="text-gray-600 inline-block w-12 flex-shrink-0">地址：</span>
                  <span class="text-gray-800 w-40">{{ row.mac || '-' }}</span>
                  <span class="text-gray-600 inline-block w-12 flex-shrink-0">DTD：</span>
                  <span class="text-gray-800 w-40">{{ row.miotDID || '-' }}</span>
                </div>
              </div>
            </template>
          </el-table-column>
          <el-table-column label="功能" min-width="200">
            <template #default="{ row }">
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-2">
                  <span class="text-gray-600 inline-block w-11 flex-shrink-0">音量：</span>
                  <span class="text-gray-800 w-5">
                    {{ row.volume !== undefined ? row.volume : '-' }}
                  </span>
                  <el-button
                    size="small"
                    type="info"
                    plain
                    circle
                    @click="getMiDeviceVolume(row)"
                    :loading="row._volumeRefreshing"
                    :disabled="row._volumeRefreshing || row._volumeChanging"
                    title="刷新音量"
                    class="p-0.5 !w-[17px] !h-[17px]">
                    <el-icon v-if="!row._volumeRefreshing"><Refresh /></el-icon>
                  </el-button>
                  <el-button
                    size="small"
                    class="!w-8 !h-6"
                    type="danger"
                    plain
                    @click="handleStopMiDevice(row)"
                    :disabled="row._stopping"
                    title="停止播放">
                    <el-icon v-if="row._stopping" class="animate-spin">
                      <Loading />
                    </el-icon>
                    <span v-else>⏹</span>
                  </el-button>
                </div>
                <div class="flex items-center gap-2">
                  <el-slider
                    :model-value="row.volume ?? 0"
                    @input="(val) => { row.volume = val; }"
                    @change="(val) => { setMiDeviceVolume(row, val); }"
                    :min="5"
                    :max="100"
                    :step="1"
                    :disabled="row._volumeChanging || row._volumeRefreshing || row.volume === undefined"
                    size="small"
                    style="flex: 1; max-width: 200px">
                  </el-slider>
                </div>
              </div>
            </template>
          </el-table-column>
          <template #empty>
            <div class="text-center text-gray-400 py-8">暂无设备，点击"扫描设备"开始扫描</div>
          </template>
        </el-table>
      </div>
    </div>
  </el-dialog>
</div>
