import{aS as p}from"./index.e2k-DlDj.js";import{d as c}from"./dayjs.min.DrTfEg_r.js";import{S as l}from"./date.g5OLmH5T.js";import{f as T}from"./forEach.ChlH2wlF.js";class u{static CmpScheduleData(t,s,e){const r=(e&&e[t.id]?.state)??0,i=(e&&e[s.id]?.state)??0;if(r!==i)return r-i;const a=t.order??99999,o=s.order??99999;return a!==o?a-o:(t.id??0)-(s.id??0)}static CmpScheduleSubtasks(t,s,e){const r=(e&&e.subtasks&&e.subtasks[t.id])??0,i=(e&&e.subtasks&&e.subtasks[s.id])??0;if(r!==i)return r-i;const a=t.order??99999,o=s.order??99999;return a!==o?a-o:(t.id??0)-(s.id??0)}static setScheduleSave(t,s,e,r){t in s.save||(s.save[t]={});const i=s.save[t];i[e.id]=r;const a=r.score??0;let o=0;if(r.state===1){let d=e.score??0;T(e.subtasks,f=>{d+=f.score??0,r.subtasks[f.id]=1}),d>a&&(o+=d-a,r.score=d)}else r.score&&(o-=e.score??0,r.score=(r.score||0)-(e.score??0));o!==0&&w(s.userId).then(d=>{d.score+=o,m(s.userId,d.score).then(()=>{})})}static updateSchedularData(t,s,e,r,i){const a=l(r);if(i==="all"){if(s.id===-1){const o=t.schedules.reduce((d,f)=>f.id>d?f.id:d,0)+1;s.id=o,t.schedules.push(s)}else{const o=t.schedules.findIndex(d=>d.id===s.id);o!==-1&&(t.schedules[o]=s)}u.setScheduleSave(a,t,s,e)}else if(i==="cur")u.setScheduleSave(a,t,s,e),e.scheduleOverride=s;else return!1;return!0}static parseScheduleData(t){const s=JSON.parse(t);return s.startTs=s.startTs?c(s.startTs):void 0,s.endTs=s.endTs?c(s.endTs):void 0,s.repeatEndTs=s.repeatEndTs?c(s.repeatEndTs):void 0,s}static parseUserData(t){const s=JSON.parse(t);s.schedules===void 0&&(s.schedules=[]),s.save===void 0&&(s.save={});for(let e=0;e<s.schedules.length;e++){const r=s.schedules[e];r.startTs=r.startTs?c(r.startTs):void 0,r.endTs=r.endTs?c(r.endTs):void 0,r.repeatEndTs=r.repeatEndTs?c(r.repeatEndTs):void 0,r.subtasks===void 0&&(r.subtasks=[])}return s}static CountScheduleReward(t){return(t.subtasks?.reduce((s,e)=>s+(e.score??0),0)||0)+(t.score??0)}}async function k(n){if(n===void 0)throw new Error("id is undefined");const t=await p.get("/getData",{params:{id:n,table:"t_schedule",fields:"data,user_id"}});if(t.data.code!==0)throw new Error(t.data.msg);const s=u.parseUserData(t.data.data.data);return s.userId=t.data.data.user_id,s}async function m(n,t){const s=await p.post("/setData",{table:"t_user",data:{id:n,score:t}});if(console.log("setUserInfo",s.data),s.data.code!==0)throw new Error(s.data.msg);return s.data.data}async function w(n){const t=await p.get("/getData",{params:{table:"t_user",id:n,fields:"id,score"}});if(t.data.code!==0)throw new Error(t.data.msg);return t.data.data}async function h(n,t,s,e){const r=await p.post("/addScore",{user:n,action:t,value:s,msg:e});if(console.log("addScore",r.data),r.data.code!==0)throw new Error(r.data.msg);return r.data.data}export{h as a,k as g,m as s};
