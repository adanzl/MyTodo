import{aJ as N,t as r,q as a,O as c,m as q,c as U,r as u,A as Q,G as V,D as Z,W as k,a1 as d,Q as y,aF as K,M as E,N as X,ao as Y,u as ee,aV as te,ae as oe,o as T}from"./vue-vendor-DIrWXCnL.js";import{l as se}from"./socket-DV2CFXI2.js";import{g as ne,a as ae}from"./rds-LutXD4hC.js";import{u as le,c as re,_ as ce}from"./index-D8BRhcwO.js";import{m as ie,d as ue,E as A,g as de,b as me}from"./element-plus-DKhpzu-P.js";import{v as he}from"./utils-C11zrYka.js";import"./vendor-DiwfJ622.js";import"./vant-CsaYtkgD.js";const ve={viewBox:"0 0 512 512",width:"1.2em",height:"1.2em"};function pe(x,s){return a(),r("svg",ve,[...s[0]||(s[0]=[c("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M157.65 192H88a8 8 0 0 0-8 8v112a8 8 0 0 0 8 8h69.65a16 16 0 0 1 10.14 3.63l91.47 75a8 8 0 0 0 12.74-6.46V119.83a8 8 0 0 0-12.74-6.44l-91.47 75a16 16 0 0 1-10.14 3.61M352 320c9.74-19.41 16-40.81 16-64c0-23.51-6-44.4-16-64m48 176c19.48-34 32-64 32-112s-12-77.7-32-112"},null,-1)])])}const _e=N({name:"ion-volume-medium-outline",render:pe}),fe={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function ge(x,s){return a(),r("svg",fe,[...s[0]||(s[0]=[c("path",{fill:"currentColor",d:"M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10a10 10 0 0 0 10-10A10 10 0 0 0 12 2m0 2c4.41 0 8 3.59 8 8s-3.59 8-8 8s-8-3.59-8-8s3.59-8 8-8M9 9v6h6V9"},null,-1)])])}const we=N({name:"mdi-stop-circle-outline",render:ge}),ke={class:"max-w-250 h-full bg-blue-100 flex flex-col"},ye={class:"text-center"},xe={class:"h-[300px]"},Ce={key:0,class:"flex"},be={class:"max-w-[70%] min-w-[40px] bg-green-500 text-white p-2 ml-auto rounded-lg shadow-md relative"},Se=["onClick"],Ie={key:1,class:"flex"},Re={class:"max-w-[70%] min-w-[40px] bg-pink-200 rounded-lg ml-2 p-2 shadow-md mr-auto relative"},Ue={class:"flex bg-green-500"},B=3,Ve=q({__name:"Chat",setup(x){const s=le(),M=U(()=>s.userList),L=U(()=>s.curUser.id),p=u(!1),m=u(""),l=u(null),h=u([]),C=u(!1),_=u({open:!1,ttsSpeed:1.1,ttsRole:"",aiConversationId:"",chatRoomId:"v_chat_room_001"}),o=u(null),D=re().replace("api","");function J(){o.value&&o.value.disconnect(),o.value=se(D,{transports:["websocket"],timeout:2e4,autoConnect:!1,forceNew:!0}),o.value.on("connect",()=>{const e={key:"123456",ttsAuto:!1,chatRoomId:_.value.chatRoomId,user:s.curUser.name||""};console.log("Connected to the server. Send handshake...",e),o.value?.emit("handshake",e)}),o.value.on("handshakeResponse",e=>{console.log("handshakeResponse:",e)}),o.value.on("connect_error",e=>{console.error("Connection error:",e)}),o.value.on("disconnect",()=>console.log("Disconnected from the server.")),o.value.on("error",e=>console.error("msg error:",e)),o.value.on("close",()=>console.log("WebSocket connection closed.")),o.value.on("endChat",e=>{console.log("endChat",e)}),o.value.on("msgChat",e=>{e.chat_type==="chat_room"?h.value.push({id:"_",content:e.content,role:e.user_id,ts:e.ts,type:e.type}):A.error(JSON.stringify(e))}),o.value.connect()}const O=async()=>{await s.refreshUserList()},$=async()=>{try{const e=s.curUser.id;if(e==null)return;const t=await ne("chatSetting",e);if(t){const i=typeof t=="string"?JSON.parse(t):t;_.value=i.data||i}}catch(e){console.error("获取聊天设置失败:",e)}},b=()=>{V(()=>{setTimeout(()=>{const e=l.value;e&&(e.scrollTop=e.scrollHeight)},10)})},S=async(e,t,i)=>{p.value=!0;try{const g=(await ae("chat:"+_.value.chatRoomId,e,t)).data||[];he(g,w=>{const v=JSON.parse(w);h.value.unshift({id:"_",content:v.content,role:v.user_id,ts:v.ts,type:v.type})})}catch(f){console.error("获取聊天消息失败:",f)}finally{p.value=!1}i&&b()},I=e=>M.value.find(t=>t.id===e),j=()=>{if(!m.value)return;const e=s.curUser.id;if(!e){A.warning("请先登录");return}h.value.push({id:"_",content:m.value,role:e,type:"text"});const t=JSON.stringify({type:"text",content:m.value,chatType:"chat_room",roomId:_.value.chatRoomId,userId:e});o.value?.emit("message",t),console.log("send message:",t),m.value="",b()},H=async()=>{const e=h.value.length+1;await S(-e,B,!1)},z=e=>{console.log("btnAudioClk",e)},F=()=>{l.value&&l.value.scrollTo({top:0,behavior:"smooth"})},R=()=>{l.value&&(C.value=l.value.scrollTop>100)};return Q(async()=>{await O(),await $(),await S(-1,B,!0),J(),V(()=>{l.value&&l.value.addEventListener("scroll",R)})}),Z(()=>{o.value&&o.value.disconnect(),l.value&&l.value.removeEventListener("scroll",R)}),(e,t)=>{const i=me,f=we,g=_e,w=de,v=K("van-pull-refresh"),G=ie,P=ue;return a(),r("div",ke,[c("h1",ye,"Chat length ["+k(h.value.length)+"]",1),c("div",xe,[d(v,{modelValue:p.value,"onUpdate:modelValue":t[0]||(t[0]=n=>p.value=n),onRefresh:H,class:"h-full","scroll-target":()=>e.$refs.chatContent},{default:y(()=>[c("div",{ref_key:"chatContent",ref:l,class:"h-full overflow-y-auto"},[(a(!0),r(X,null,Y(h.value,(n,W)=>(a(),r("div",{key:W,class:"p-1.5 w-full message-item"},[n.role==L.value?(a(),r("div",Ce,[c("div",be,k(n.content),1),d(i,{src:I(n.role)?.icon,class:"w-12 h-12 ml-1"},null,8,["src"]),n.audioSrc?E("",!0):(a(),r("div",{key:0,class:"absolute -right-10 top-1 rounded-[50%] border border-cyan-950 w-8 h-8 flex items-center justify-center text-black",onClick:Ee=>z(n)},[n.playing?(a(),T(f,{key:0,class:"w-6 h-6"})):(a(),T(g,{key:1,class:"w-6 h-6"}))],8,Se))])):(a(),r("div",Ie,[d(i,{src:I(n.role)?.icon,class:"w-12 h-12 ml-1"},null,8,["src"]),c("div",Re,k(n.content),1)]))]))),128))],512),C.value?(a(),r("div",{key:0,class:"fixed bottom-20 right-4 z-50 w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center cursor-pointer shadow-lg",onClick:F},[d(w,{size:20,color:"white"},{default:y(()=>[d(ee(te))]),_:1})])):E("",!0)]),_:1},8,["modelValue","scroll-target"])]),c("div",Ue,[d(G,{modelValue:m.value,"onUpdate:modelValue":t[1]||(t[1]=n=>m.value=n),class:"w-full h-17 ml-2 mt-2",type:"textarea",placeholder:"Please input"},null,8,["modelValue"]),d(P,{class:"!w-16 !h-13 mx-2 mt-2",type:"primary",onClick:j},{default:y(()=>[...t[2]||(t[2]=[oe(" Send ",-1)])]),_:1})])])}}}),Oe=ce(Ve,[["__scopeId","data-v-5add3bf0"]]);export{Oe as default};
