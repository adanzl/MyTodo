import{A as fe,E as y,G as pe,u as ve,c as ge,H as ye,B as Ce,I as be,C as he,f as ke,J as R,K as Ve,L as xe,M as Ee,N as ze,O as Ue,t as De,P as Se,D as Oe,Q as Be,R as Ne,r as we}from"./element-plus-CEI_9LYZ.js";import{f as T,h as Ie,j as A,k as Le,m as F,n as $e,o as Ge}from"./shared-1TZFBAIg.js";import{w as Q}from"./utils-B-B_-3AX.js";import{B as Pe,o as Me,G as C,I as _,Z as l,Q as s,W as je,E as u,O as w,r as b,e as Je,D as i,a3 as m,aa as Z,u as I,M as E,U as L}from"./vue-vendor-Bzw_s7xI.js";import"./vendor-B3rMqREe.js";const Re={class:""},Te={class:"flex w-[400px] items-center mb-2"},Ae={class:"flex items-center"},Fe={class:"flex-1 flex items-center justify-end"},Qe={class:"h-24 flex"},Ze={key:0,class:"flex items-center w-24"},qe={key:1,class:"relative z-50 w-full h-full"},He={key:1,class:"relative w-24"},Ke={class:"flex flex-col"},We={class:"flex items-center"},Xe={class:"flex items-center pl-2"},Ye={class:"flex flex-col gap-2 [&_.el-button+_.el-button]:!ml-0"},ea={class:"flex items-center"},aa={key:1},ta={class:"flex items-center"},la={key:1},z=10,ua=Pe({__name:"Lottery",setup(sa){const h=b(0),k=Je(()=>p.value.find(a=>a.id===h.value)||p.value[0]),c=b({data:[],pageNum:1,pageSize:10,totalCount:0,totalPage:0}),p=b([]),U=b(!1),x=b({fee:10}),D=b(!1),v=b([]),S=async()=>{try{const a=await T("t_gift_category");if(a&&a.data){const t=a.data.data||[];p.value=[...t],p.value.unshift({id:0,name:"全部"}),h.value===0&&p.value.length>0&&(h.value=p.value[0].id),v.value=[],v.value.push({id:-1,name:"",edited:!0}),Q(t,o=>{v.value.push({id:o.id,name:o.name,cost:o.cost,edited:!1})})}}catch(a){console.error(a),y.error(JSON.stringify(a))}},V=async(a,t,o)=>{U.value=!0;try{let r;a&&a!==0&&(r={cate_id:a});const d=await T("t_gift",r,t,o);if(d&&d.data){const O=d.data.data||[];c.value.data=[],c.value.pageNum=d.data.pageNum??t,c.value.pageSize=d.data.pageSize??o,c.value.totalCount=d.data.totalCount??0,c.value.totalPage=d.data.totalPage??Math.ceil((d.data.totalCount??0)/(d.data.pageSize??o)),Q(O,g=>{c.value.data.push({id:g.id,name:g.name,img:g.image,cate_id:g.cate_id,cost:g.cost,enable:g.enable===1,edited:!1})})}}catch(r){console.error(r),y.error(JSON.stringify(r))}finally{U.value=!1}},q=async()=>{try{await Ge("lottery",2,JSON.stringify(x.value))}catch(a){console.error("更新费用失败:",a),y.error("更新费用失败")}},H=()=>{const a=k.value;a&&V(a.id,1,z)},K=()=>{c.value.data.unshift({id:-1,name:"",img:"",cate_id:k.value.id,cost:0,enable:!1,edited:!0})},W=(a,t)=>{t.cate_id=a},X=async a=>{try{a.edited=!1,await A("t_gift",a.id),await V(k.value.id,c.value.pageNum,c.value.pageSize)}catch(t){console.error("删除奖品失败:",t),y.error("删除奖品失败")}},Y=async(a,t)=>{if(a.id===-1)c.value.data.splice(t,1);else{a.edited=!1;try{const o=await Le("t_gift",a.id);Object.assign(a,{id:o.id,name:o.name,img:o.image,cate_id:o.cate_id,cost:o.cost,enable:o.enable===1})}catch(o){console.error("获取奖品数据失败:",o)}}},ee=async a=>{try{const t={id:a.id,name:a.name,image:a.img,cate_id:a.cate_id,enable:a.enable?1:0,cost:a.cost};await F("t_gift",t),await V(k.value.id,c.value.pageNum,c.value.pageSize)}catch(t){console.error("保存奖品失败:",t),y.error("保存奖品失败")}},$=async(a,t)=>{if(a&&a.raw)try{const o=await $e(a.raw,{quality:.5});console.log("压缩后的base64",o.length),t.img=o}catch(o){console.error("图片压缩失败:",o),y.error("图片压缩失败")}},ae=(a,t)=>{V(k.value.id,a,t)},G=(a,t,o)=>{console.log("handleCateBlur",a,t)},te=async(a,t)=>{try{const o={id:a.id,name:a.name,cost:a.cost};await F("t_gift_category",o),await S()}catch(o){console.error("保存类别失败:",o),y.error("保存类别失败")}},le=async a=>{try{await A("t_gift_category",a.id),await S()}catch(t){console.error("删除类别失败:",t),y.error("删除类别失败")}},P=a=>{a.edited=!0},se=(a,t)=>{a.id===-1?(a.name="",a.cost=0):a.edited=!1},ne=async()=>{try{const a=await Ie("lottery",2);a&&Object.assign(x.value,JSON.parse(a))}catch(a){console.error("获取抽奖设置失败:",a)}};return Me(async()=>{await S(),await V(0,1,z),await ne()}),(a,t)=>{const o=pe,r=ve,d=ge,O=Be,g=Ne,oe=ye,B=ke,M=Ve,j=Ee,f=Oe,N=Ue,de=ze,ie=we,ce=De,ue=Se,J=Ce,re=be,me=he,_e=fe;return i(),C(w,null,[_("div",Re,[_("div",Te,[l(o,{class:"w-24"},{default:s(()=>[...t[5]||(t[5]=[m("普通抽奖费用",-1)])]),_:1}),l(r,{modelValue:x.value.fee,"onUpdate:modelValue":t[0]||(t[0]=e=>x.value.fee=e),class:"!w-32 ml-2",type:"number"},null,8,["modelValue"]),l(d,{type:"primary",class:"ml-2",onClick:q},{default:s(()=>[...t[6]||(t[6]=[m(" Update ",-1)])]),_:1})]),l(O),_("div",Ae,[l(oe,{size:"large",modelValue:h.value,"onUpdate:modelValue":t[1]||(t[1]=e=>h.value=e),class:"",onChange:H},{default:s(()=>[(i(!0),C(w,null,Z(p.value,e=>(i(),u(g,{key:e.id,value:e.id},{default:s(()=>[m(L(e.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"]),l(d,{type:"primary",class:"ml-1",onClick:t[2]||(t[2]=e=>D.value=!0)},{default:s(()=>[l(B,null,{default:s(()=>[l(I(R))]),_:1})]),_:1}),_("div",Fe,[l(d,{type:"primary",class:"",onClick:K},{default:s(()=>[...t[7]||(t[7]=[m("添加奖品",-1)])]),_:1})])]),je((i(),u(J,{data:c.value.data},{default:s(()=>[l(f,{width:"130",label:"Image"},{default:s(({row:e})=>[_("div",Qe,[e.edited?(i(),C("div",Ze,[e.img?(i(),C("div",qe,[l(j,{class:"w-24 cursor-pointer !z-[99]",src:e.img,"preview-src-list":[e.img],"preview-teleported":!0,fit:"contain"},null,8,["src","preview-src-list"]),l(M,{class:"absolute bottom-0 right-0 !z-[100]",action:"#","show-file-list":!1,"auto-upload":!1,"on-change":n=>$(n,e)},{default:s(()=>[l(d,{size:"small",type:"primary",circle:""},{default:s(()=>[l(B,null,{default:s(()=>[l(I(R))]),_:1})]),_:1})]),_:1},8,["on-change"])])):(i(),u(M,{key:0,class:"flex items-center justify-center bg-white w-full h-full",action:"#","list-type":"picture-card",limit:1,"auto-upload":!1,"show-file-list":!1,"on-change":n=>$(n,e)},{default:s(()=>[l(B,null,{default:s(()=>[l(I(xe))]),_:1})]),_:1},8,["on-change"]))])):(i(),C("div",He,[l(j,{class:"w-24 cursor-pointer !z-[9999]",src:e.img,"preview-src-list":[e.img],"preview-teleported":!0,fit:"contain"},null,8,["src","preview-src-list"])]))])]),_:1}),l(f,{label:"Info",width:"200"},{default:s(({row:e})=>[_("div",Ke,[l(de,{column:1,size:"small",border:"","label-width":"50"},{default:s(()=>[l(N,{label:"ID",width:"100"},{default:s(()=>[l(r,{modelValue:e.id,"onUpdate:modelValue":n=>e.id=n,size:"small",disabled:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l(N,{label:"名称"},{default:s(()=>[l(r,{modelValue:e.name,"onUpdate:modelValue":n=>e.name=n,size:"small",disabled:!e.edited},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1024),l(N,{label:"Cost"},{default:s(()=>[l(r,{modelValue:e.cost,"onUpdate:modelValue":n=>e.cost=n,size:"small",disabled:!e.edited},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1024)]),_:2},1024)])]),_:1}),l(f,{label:"Category",width:"180"},{default:s(({row:e})=>[_("div",We,[l(ce,{disabled:!e.edited,modelValue:e.cate_id,"onUpdate:modelValue":n=>e.cate_id=n,onChange:n=>W(n,e)},{default:s(()=>[(i(!0),C(w,null,Z(p.value,n=>(i(),u(ie,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["disabled","modelValue","onUpdate:modelValue","onChange"])])]),_:1}),l(f,{label:"启用",width:"80"},{default:s(({row:e})=>[_("div",Xe,[l(ue,{modelValue:e.enable,"onUpdate:modelValue":n=>e.enable=n,size:"large",disabled:!e.edited},null,8,["modelValue","onUpdate:modelValue","disabled"])])]),_:1}),l(f,{label:"Operations"},{default:s(({row:e})=>[_("div",Ye,[e.id!==-1?(i(),u(d,{key:0,class:"w-16",size:"small",type:"danger",onClick:n=>X(e)},{default:s(()=>[...t[8]||(t[8]=[m(" Delete ",-1)])]),_:1},8,["onClick"])):E("",!0),e.edited?(i(),u(d,{key:1,class:"w-16",size:"small",onClick:n=>Y(e,c.value.data.indexOf(e))},{default:s(()=>[...t[9]||(t[9]=[m(" Cancel ",-1)])]),_:1},8,["onClick"])):(i(),u(d,{key:2,size:"small",class:"w-16",onClick:n=>P(e)},{default:s(()=>[...t[10]||(t[10]=[m(" Edit ",-1)])]),_:1},8,["onClick"])),e.edited?(i(),u(d,{key:3,class:"w-16",size:"small",type:"primary",onClick:n=>ee(e)},{default:s(()=>[...t[11]||(t[11]=[m(" Save ",-1)])]),_:1},8,["onClick"])):E("",!0)])]),_:1})]),_:1},8,["data"])),[[_e,U.value]]),l(re,{layout:"prev, pager, next",total:c.value.totalCount,"page-size":z,"current-page":c.value.pageNum,class:"mt-2",background:"",onCurrentChange:t[3]||(t[3]=e=>ae(e,z))},null,8,["total","current-page"])]),l(me,{modelValue:D.value,"onUpdate:modelValue":t[4]||(t[4]=e=>D.value=e),title:"类别管理",width:"800","destroy-on-close":""},{default:s(()=>[l(J,{data:v.value},{default:s(()=>[l(f,{property:"id",label:"ID",width:"50"}),l(f,{property:"name",label:"Name",width:"100"},{default:s(({row:e})=>[_("div",ea,[e.edited?(i(),u(r,{key:0,modelValue:e.name,"onUpdate:modelValue":n=>e.name=n,size:"small",onBlur:n=>G(e,"name",v.value.indexOf(e))},null,8,["modelValue","onUpdate:modelValue","onBlur"])):(i(),C("span",aa,L(e.name),1))])]),_:1}),l(f,{property:"cost",label:"Cost",width:"200"},{default:s(({row:e})=>[_("div",ta,[e.edited?(i(),u(r,{key:0,modelValue:e.cost,"onUpdate:modelValue":n=>e.cost=n,size:"small",clearable:"",onBlur:n=>G(e,"cost",v.value.indexOf(e))},null,8,["modelValue","onUpdate:modelValue","onBlur"])):(i(),C("span",la,L(e.cost),1))])]),_:1}),l(f,{label:"OP"},{default:s(({row:e})=>[e.edited?(i(),u(d,{key:0,class:"w-16",size:"small",type:"primary",onClick:n=>te(e,v.value.indexOf(e))},{default:s(()=>[...t[12]||(t[12]=[m(" Save ",-1)])]),_:1},8,["onClick"])):E("",!0),e.edited?(i(),u(d,{key:1,class:"w-16",size:"small",onClick:n=>se(e,v.value.indexOf(e))},{default:s(()=>[...t[13]||(t[13]=[m(" Cancel ",-1)])]),_:1},8,["onClick"])):(i(),u(d,{key:2,size:"small",class:"w-16",onClick:n=>P(e)},{default:s(()=>[...t[14]||(t[14]=[m(" Edit ",-1)])]),_:1},8,["onClick"])),e.id!==-1?(i(),u(d,{key:3,class:"w-16",size:"small",type:"danger",onClick:n=>le(e)},{default:s(()=>[...t[15]||(t[15]=[m(" Delete ",-1)])]),_:1},8,["onClick"])):E("",!0)]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue"])],64)}}});export{ua as default};
