import{ao as M,D as a,G as r,I as c,B as F,o as Q,n as R,k as W,U as k,Z as u,Q as y,r as d,a8 as K,O as X,aa as Y,u as ee,M as E,a3 as te,E as T,e as V}from"./vue-vendor-Bzw_s7xI.js";import{E as B,u as oe,c as se,f as ne,U as ae,b as le}from"./element-plus-CEI_9LYZ.js";import{l as re}from"./socket-W85Wkm6P.js";import{q as ce,h as ie,r as ue}from"./shared-1TZFBAIg.js";import{u as de,_ as he}from"./index-gfppqctp.js";import{x as me}from"./utils-B-B_-3AX.js";import"./vendor-B3rMqREe.js";import"./vant-DC8oOVF3.js";const pe={viewBox:"0 0 512 512",width:"1.2em",height:"1.2em"};function ve(x,s){return a(),r("svg",pe,[...s[0]||(s[0]=[c("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M157.65 192H88a8 8 0 0 0-8 8v112a8 8 0 0 0 8 8h69.65a16 16 0 0 1 10.14 3.63l91.47 75a8 8 0 0 0 12.74-6.46V119.83a8 8 0 0 0-12.74-6.44l-91.47 75a16 16 0 0 1-10.14 3.61M352 320c9.74-19.41 16-40.81 16-64c0-23.51-6-44.4-16-64m48 176c19.48-34 32-64 32-112s-12-77.7-32-112"},null,-1)])])}const _e=M({name:"ion-volume-medium-outline",render:ve}),fe={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function ge(x,s){return a(),r("svg",fe,[...s[0]||(s[0]=[c("path",{fill:"currentColor",d:"M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10a10 10 0 0 0 10-10A10 10 0 0 0 12 2m0 2c4.41 0 8 3.59 8 8s-3.59 8-8 8s-8-3.59-8-8s3.59-8 8-8M9 9v6h6V9"},null,-1)])])}const we=M({name:"mdi-stop-circle-outline",render:ge}),ke={class:"max-w-250 h-full bg-blue-100 flex flex-col"},ye={class:"text-center"},xe={class:"h-[300px]"},Ce={key:0,class:"flex"},be={class:"max-w-[70%] min-w-[40px] bg-green-500 text-white p-2 ml-auto rounded-lg shadow-md relative"},Se=["onClick"],Ie={key:1,class:"flex"},Ue={class:"max-w-[70%] min-w-[40px] bg-pink-200 rounded-lg ml-2 p-2 shadow-md mr-auto relative"},Re={class:"flex bg-green-500"},A=3,Ee=F({__name:"Chat",setup(x){const s=de(),N=V(()=>s.userList),L=V(()=>s.curUser.id),v=d(!1),h=d(""),l=d(null),m=d([]),C=d(!1),_=d({open:!1,ttsSpeed:1.1,ttsRole:"",aiConversationId:"",chatRoomId:"v_chat_room_001"}),o=d(null),D=ce().replace("api","");function O(){o.value&&o.value.disconnect(),o.value=re(D,{transports:["websocket"],timeout:2e4,autoConnect:!1,forceNew:!0}),o.value.on("connect",()=>{const e={key:"123456",ttsAuto:!1,chatRoomId:_.value.chatRoomId,user:s.curUser.name||""};console.log("Connected to the server. Send handshake...",e),o.value?.emit("handshake",e)}),o.value.on("handshakeResponse",e=>{console.log("handshakeResponse:",e)}),o.value.on("connect_error",e=>{console.error("Connection error:",e)}),o.value.on("disconnect",()=>console.log("Disconnected from the server.")),o.value.on("error",e=>console.error("msg error:",e)),o.value.on("close",()=>console.log("WebSocket connection closed.")),o.value.on("endChat",e=>{console.log("endChat",e)}),o.value.on("msgChat",e=>{e.chat_type==="chat_room"?m.value.push({id:"_",content:e.content,role:e.user_id,ts:e.ts,type:e.type}):B.error(JSON.stringify(e))}),o.value.connect()}const $=async()=>{await s.refreshUserList()},J=async()=>{try{const e=s.curUser.id;if(e==null)return;const t=await ie("chatSetting",e);if(t){const i=typeof t=="string"?JSON.parse(t):t;_.value=i.data||i}}catch(e){console.error("获取聊天设置失败:",e)}},b=()=>{R(()=>{setTimeout(()=>{const e=l.value;e&&(e.scrollTop=e.scrollHeight)},10)})},S=async(e,t,i)=>{v.value=!0;try{const g=(await ue("chat:"+_.value.chatRoomId,e,t)).data||[];me(g,w=>{const p=JSON.parse(w);m.value.unshift({id:"_",content:p.content,role:p.user_id,ts:p.ts,type:p.type})})}catch(f){console.error("获取聊天消息失败:",f)}finally{v.value=!1}i&&b()},I=e=>N.value.find(t=>t.id===e),j=()=>{if(!h.value)return;const e=s.curUser.id;if(!e){B.warning("请先登录");return}m.value.push({id:"_",content:h.value,role:e,type:"text"});const t=JSON.stringify({type:"text",content:h.value,chatType:"chat_room",roomId:_.value.chatRoomId,userId:e});o.value?.emit("message",t),console.log("send message:",t),h.value="",b()},H=async()=>{const e=m.value.length+1;await S(-e,A,!1)},z=e=>{console.log("btnAudioClk",e)},G=()=>{l.value&&l.value.scrollTo({top:0,behavior:"smooth"})},U=()=>{l.value&&(C.value=l.value.scrollTop>100)};return Q(async()=>{await $(),await J(),await S(-1,A,!0),O(),R(()=>{l.value&&l.value.addEventListener("scroll",U)})}),W(()=>{o.value&&o.value.disconnect(),l.value&&l.value.removeEventListener("scroll",U)}),(e,t)=>{const i=le,f=we,g=_e,w=ne,p=K("van-pull-refresh"),P=oe,Z=se;return a(),r("div",ke,[c("h1",ye,"Chat length ["+k(m.value.length)+"]",1),c("div",xe,[u(p,{modelValue:v.value,"onUpdate:modelValue":t[0]||(t[0]=n=>v.value=n),onRefresh:H,class:"h-full","scroll-target":()=>e.$refs.chatContent},{default:y(()=>[c("div",{ref_key:"chatContent",ref:l,class:"h-full overflow-y-auto"},[(a(!0),r(X,null,Y(m.value,(n,q)=>(a(),r("div",{key:q,class:"p-1.5 w-full message-item"},[n.role==L.value?(a(),r("div",Ce,[c("div",be,k(n.content),1),u(i,{src:I(n.role)?.icon,class:"w-12 h-12 ml-1"},null,8,["src"]),n.audioSrc?E("",!0):(a(),r("div",{key:0,class:"absolute -right-10 top-1 rounded-[50%] border border-cyan-950 w-8 h-8 flex items-center justify-center text-black",onClick:Te=>z(n)},[n.playing?(a(),T(f,{key:0,class:"w-6 h-6"})):(a(),T(g,{key:1,class:"w-6 h-6"}))],8,Se))])):(a(),r("div",Ie,[u(i,{src:I(n.role)?.icon,class:"w-12 h-12 ml-1"},null,8,["src"]),c("div",Ue,k(n.content),1)]))]))),128))],512),C.value?(a(),r("div",{key:0,class:"fixed bottom-20 right-4 z-50 w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center cursor-pointer shadow-lg",onClick:G},[u(w,{size:20,color:"white"},{default:y(()=>[u(ee(ae))]),_:1})])):E("",!0)]),_:1},8,["modelValue","scroll-target"])]),c("div",Re,[u(P,{modelValue:h.value,"onUpdate:modelValue":t[1]||(t[1]=n=>h.value=n),class:"w-full h-17 ml-2 mt-2",type:"textarea",placeholder:"Please input"},null,8,["modelValue"]),u(Z,{class:"!w-16 !h-13 mx-2 mt-2",type:"primary",onClick:j},{default:y(()=>[...t[2]||(t[2]=[te(" Send ",-1)])]),_:1})])])}}}),$e=he(Ee,[["__scopeId","data-v-5add3bf0"]]);export{$e as default};
