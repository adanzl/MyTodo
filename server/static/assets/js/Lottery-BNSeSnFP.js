import{m as _e,r as w,c as ge,A as ve,t as E,O as h,a1 as l,Z as ye,Q as s,o as p,N as R,q as c,ae as _,ao as A,u as I,bG as F,aW as he,M as S,W as G}from"./vue-vendor-DIrWXCnL.js";import{g as J,d as H,a as Ce,s as Z}from"./index-D8BRhcwO.js";import{g as be,s as ke}from"./rds-LutXD4hC.js";import{u as xe,m as Ve,d as Ee,w as ze,x as Ue,v as we,q as De,y as Oe,r as Se,E as z,g as Le,z as Ne,A as Be,s as $e,B as Re,C as Ie,l as Ge,D as Pe,F as Me,k as Te}from"./element-plus-DKhpzu-P.js";import{r as Q}from"./utils-C11zrYka.js";import"./vant-CsaYtkgD.js";import"./vendor-DiwfJ622.js";async function je(O,U={}){const d={...{maxWidth:800,maxHeight:600,quality:.8},...U};if(O.type==="image/svg+xml")return new Promise((x,b)=>{const u=new FileReader;u.onload=r=>{const g=r.target?.result;if(g.startsWith("data:image/svg+xml;base64,"))x(g);else{const m=btoa(new TextEncoder().encode(g).reduce((v,y)=>v+String.fromCharCode(y),""));x(`data:image/svg+xml;base64,${m}`)}},u.onerror=()=>b("SVG读取失败: 文件读取错误"),u.readAsText(O)});const C=O.type==="image/png"?"image/png":"image/jpeg";return new Promise((x,b)=>{const u=new Image;u.src=URL.createObjectURL(O),u.onload=async()=>{const r=document.createElement("canvas"),g=r.getContext("2d");if(!g){b("无法获取 canvas 上下文");return}let[m,v]=[u.width,u.height];if(m>d.maxWidth||v>d.maxHeight){const y=Math.min(d.maxWidth/m,d.maxHeight/v);m=Math.floor(m*y),v=Math.floor(v*y)}r.width=m,r.height=v,g.clearRect(0,0,m,v),g.drawImage(u,0,0,m,v);try{const y=r.toDataURL(C,d.quality);URL.revokeObjectURL(u.src),x(y)}catch(y){b(`压缩失败: ${y instanceof Error?y.message:"未知错误"}`)}},u.onerror=r=>{b(`图片加载失败: ${r instanceof Error?r.message:"未知错误"}`),URL.revokeObjectURL(u.src)}})}const We={class:""},qe={class:"flex w-[400px] items-center mb-2"},Ae={class:"flex items-center"},Fe={class:"flex-1 flex items-center justify-end"},Je={class:"h-24 flex"},He={key:0,class:"flex items-center w-24"},Ze={key:1,class:"relative z-50 w-full h-full"},Qe={key:1,class:"relative w-24"},Ke={class:"flex flex-col"},Xe={class:"flex items-center"},Ye={class:"flex items-center pl-2"},ea={class:"flex flex-col gap-2 [&_.el-button+_.el-button]:!ml-0"},aa={class:"flex items-center"},ta={key:1},la={class:"flex items-center"},sa={key:1},L=10,ma=_e({__name:"Lottery",setup(O){const U=w(0),D=ge(()=>C.value.find(a=>a.id===U.value)||C.value[0]),d=w({data:[],pageNum:1,pageSize:10,totalCount:0,totalPage:0}),C=w([]),x=w(!1),b=w({fee:10}),u=w(!1),r=w([]),g=async()=>{try{const a=await J("t_gift_category");if(a&&a.data){const t=a.data.data||[];C.value=[...t],C.value.unshift({id:0,name:"全部"}),U.value===0&&C.value.length>0&&(U.value=C.value[0].id),r.value=[],r.value.push({id:-1,name:"",edited:!0}),Q(t,o=>{r.value.push({id:o.id,name:o.name,cost:o.cost,edited:!1})})}}catch(a){console.error(a),z.error(JSON.stringify(a))}},m=async(a,t,o)=>{x.value=!0;try{let f;a&&a!==0&&(f={cate_id:a});const i=await J("t_gift",f,t,o);if(i&&i.data){const N=i.data.data||[];d.value.data=[],d.value.pageNum=i.data.pageNum??t,d.value.pageSize=i.data.pageSize??o,d.value.totalCount=i.data.totalCount??0,d.value.totalPage=i.data.totalPage??Math.ceil((i.data.totalCount??0)/(i.data.pageSize??o)),Q(N,V=>{d.value.data.push({id:V.id,name:V.name,img:V.image,cate_id:V.cate_id,cost:V.cost,enable:V.enable===1,edited:!1})})}}catch(f){console.error(f),z.error(JSON.stringify(f))}finally{x.value=!1}},v=async()=>{try{await ke("lottery",2,JSON.stringify(b.value))}catch(a){console.error("更新费用失败:",a),z.error("更新费用失败")}},y=()=>{const a=D.value;a&&m(a.id,1,L)},K=()=>{d.value.data.unshift({id:-1,name:"",img:"",cate_id:D.value.id,cost:0,enable:!1,edited:!0})},X=(a,t)=>{t.cate_id=a},Y=async a=>{try{a.edited=!1,await H("t_gift",a.id),await m(D.value.id,d.value.pageNum,d.value.pageSize)}catch(t){console.error("删除奖品失败:",t),z.error("删除奖品失败")}},ee=async(a,t)=>{if(a.id===-1)d.value.data.splice(t,1);else{a.edited=!1;try{const o=await Ce("t_gift",a.id);Object.assign(a,{id:o.id,name:o.name,img:o.image,cate_id:o.cate_id,cost:o.cost,enable:o.enable===1})}catch(o){console.error("获取奖品数据失败:",o)}}},ae=async a=>{try{const t={id:a.id,name:a.name,image:a.img,cate_id:a.cate_id,enable:a.enable?1:0,cost:a.cost};await Z("t_gift",t),await m(D.value.id,d.value.pageNum,d.value.pageSize)}catch(t){console.error("保存奖品失败:",t),z.error("保存奖品失败")}},P=async(a,t)=>{if(a&&a.raw)try{const o=await je(a.raw,{quality:.5});console.log("压缩后的base64",o.length),t.img=o}catch(o){console.error("图片压缩失败:",o),z.error("图片压缩失败")}},te=(a,t)=>{m(D.value.id,a,t)},M=(a,t,o)=>{console.log("handleCateBlur",a,t)},le=async(a,t)=>{try{const o={id:a.id,name:a.name,cost:a.cost};await Z("t_gift_category",o),await g()}catch(o){console.error("保存类别失败:",o),z.error("保存类别失败")}},se=async a=>{try{await H("t_gift_category",a.id),await g()}catch(t){console.error("删除类别失败:",t),z.error("删除类别失败")}},T=a=>{a.edited=!0},ne=(a,t)=>{a.id===-1?(a.name="",a.cost=0):a.edited=!1},oe=async()=>{try{const a=await be("lottery",2);a&&Object.assign(b.value,JSON.parse(a))}catch(a){console.error("获取抽奖设置失败:",a)}};return ve(async()=>{await g(),await m(0,1,L),await oe()}),(a,t)=>{const o=xe,f=Ve,i=Ee,N=ze,V=Me,de=Ue,B=Le,j=Ne,W=Be,k=$e,$=Ie,ie=Re,ce=Te,re=Ge,ue=Pe,q=De,me=Oe,pe=Se,fe=we;return c(),E(R,null,[h("div",We,[h("div",qe,[l(o,{class:"w-24"},{default:s(()=>[...t[5]||(t[5]=[_("普通抽奖费用",-1)])]),_:1}),l(f,{modelValue:b.value.fee,"onUpdate:modelValue":t[0]||(t[0]=e=>b.value.fee=e),class:"!w-32 ml-2",type:"number"},null,8,["modelValue"]),l(i,{type:"primary",class:"ml-2",onClick:v},{default:s(()=>[...t[6]||(t[6]=[_(" Update ",-1)])]),_:1})]),l(N),h("div",Ae,[l(de,{size:"large",modelValue:U.value,"onUpdate:modelValue":t[1]||(t[1]=e=>U.value=e),class:"",onChange:y},{default:s(()=>[(c(!0),E(R,null,A(C.value,e=>(c(),p(V,{key:e.id,value:e.id},{default:s(()=>[_(G(e.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"]),l(i,{type:"primary",class:"ml-1",onClick:t[2]||(t[2]=e=>u.value=!0)},{default:s(()=>[l(B,null,{default:s(()=>[l(I(F))]),_:1})]),_:1}),h("div",Fe,[l(i,{type:"primary",class:"",onClick:K},{default:s(()=>[...t[7]||(t[7]=[_("添加奖品",-1)])]),_:1})])]),ye((c(),p(q,{data:d.value.data},{default:s(()=>[l(k,{width:"130",label:"Image"},{default:s(({row:e})=>[h("div",Je,[e.edited?(c(),E("div",He,[e.img?(c(),E("div",Ze,[l(W,{class:"w-24 cursor-pointer !z-[99]",src:e.img,"preview-src-list":[e.img],"preview-teleported":!0,fit:"contain"},null,8,["src","preview-src-list"]),l(j,{class:"absolute bottom-0 right-0 !z-[100]",action:"#","show-file-list":!1,"auto-upload":!1,"on-change":n=>P(n,e)},{default:s(()=>[l(i,{size:"small",type:"primary",circle:""},{default:s(()=>[l(B,null,{default:s(()=>[l(I(F))]),_:1})]),_:1})]),_:1},8,["on-change"])])):(c(),p(j,{key:0,class:"flex items-center justify-center bg-white w-full h-full",action:"#","list-type":"picture-card",limit:1,"auto-upload":!1,"show-file-list":!1,"on-change":n=>P(n,e)},{default:s(()=>[l(B,null,{default:s(()=>[l(I(he))]),_:1})]),_:1},8,["on-change"]))])):(c(),E("div",Qe,[l(W,{class:"w-24 cursor-pointer !z-[9999]",src:e.img,"preview-src-list":[e.img],"preview-teleported":!0,fit:"contain"},null,8,["src","preview-src-list"])]))])]),_:1}),l(k,{label:"Info",width:"200"},{default:s(({row:e})=>[h("div",Ke,[l(ie,{column:1,size:"small",border:"","label-width":"50"},{default:s(()=>[l($,{label:"ID",width:"100"},{default:s(()=>[l(f,{modelValue:e.id,"onUpdate:modelValue":n=>e.id=n,size:"small",disabled:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l($,{label:"名称"},{default:s(()=>[l(f,{modelValue:e.name,"onUpdate:modelValue":n=>e.name=n,size:"small",disabled:!e.edited},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1024),l($,{label:"Cost"},{default:s(()=>[l(f,{modelValue:e.cost,"onUpdate:modelValue":n=>e.cost=n,size:"small",disabled:!e.edited},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1024)]),_:2},1024)])]),_:1}),l(k,{label:"Category",width:"180"},{default:s(({row:e})=>[h("div",Xe,[l(re,{disabled:!e.edited,modelValue:e.cate_id,"onUpdate:modelValue":n=>e.cate_id=n,onChange:n=>X(n,e)},{default:s(()=>[(c(!0),E(R,null,A(C.value,n=>(c(),p(ce,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["disabled","modelValue","onUpdate:modelValue","onChange"])])]),_:1}),l(k,{label:"启用",width:"80"},{default:s(({row:e})=>[h("div",Ye,[l(ue,{modelValue:e.enable,"onUpdate:modelValue":n=>e.enable=n,size:"large",disabled:!e.edited},null,8,["modelValue","onUpdate:modelValue","disabled"])])]),_:1}),l(k,{label:"Operations"},{default:s(({row:e})=>[h("div",ea,[e.id!==-1?(c(),p(i,{key:0,class:"w-16",size:"small",type:"danger",onClick:n=>Y(e)},{default:s(()=>[...t[8]||(t[8]=[_(" Delete ",-1)])]),_:1},8,["onClick"])):S("",!0),e.edited?(c(),p(i,{key:1,class:"w-16",size:"small",onClick:n=>ee(e,d.value.data.indexOf(e))},{default:s(()=>[...t[9]||(t[9]=[_(" Cancel ",-1)])]),_:1},8,["onClick"])):(c(),p(i,{key:2,size:"small",class:"w-16",onClick:n=>T(e)},{default:s(()=>[...t[10]||(t[10]=[_(" Edit ",-1)])]),_:1},8,["onClick"])),e.edited?(c(),p(i,{key:3,class:"w-16",size:"small",type:"primary",onClick:n=>ae(e)},{default:s(()=>[...t[11]||(t[11]=[_(" Save ",-1)])]),_:1},8,["onClick"])):S("",!0)])]),_:1})]),_:1},8,["data"])),[[fe,x.value]]),l(me,{layout:"prev, pager, next",total:d.value.totalCount,"page-size":L,"current-page":d.value.pageNum,class:"mt-2",background:"",onCurrentChange:t[3]||(t[3]=e=>te(e,L))},null,8,["total","current-page"])]),l(pe,{modelValue:u.value,"onUpdate:modelValue":t[4]||(t[4]=e=>u.value=e),title:"类别管理",width:"800","destroy-on-close":""},{default:s(()=>[l(q,{data:r.value},{default:s(()=>[l(k,{property:"id",label:"ID",width:"50"}),l(k,{property:"name",label:"Name",width:"100"},{default:s(({row:e})=>[h("div",aa,[e.edited?(c(),p(f,{key:0,modelValue:e.name,"onUpdate:modelValue":n=>e.name=n,size:"small",onBlur:n=>M(e,"name",r.value.indexOf(e))},null,8,["modelValue","onUpdate:modelValue","onBlur"])):(c(),E("span",ta,G(e.name),1))])]),_:1}),l(k,{property:"cost",label:"Cost",width:"200"},{default:s(({row:e})=>[h("div",la,[e.edited?(c(),p(f,{key:0,modelValue:e.cost,"onUpdate:modelValue":n=>e.cost=n,size:"small",clearable:"",onBlur:n=>M(e,"cost",r.value.indexOf(e))},null,8,["modelValue","onUpdate:modelValue","onBlur"])):(c(),E("span",sa,G(e.cost),1))])]),_:1}),l(k,{label:"OP"},{default:s(({row:e})=>[e.edited?(c(),p(i,{key:0,class:"w-16",size:"small",type:"primary",onClick:n=>le(e,r.value.indexOf(e))},{default:s(()=>[...t[12]||(t[12]=[_(" Save ",-1)])]),_:1},8,["onClick"])):S("",!0),e.edited?(c(),p(i,{key:1,class:"w-16",size:"small",onClick:n=>ne(e,r.value.indexOf(e))},{default:s(()=>[...t[13]||(t[13]=[_(" Cancel ",-1)])]),_:1},8,["onClick"])):(c(),p(i,{key:2,size:"small",class:"w-16",onClick:n=>T(e)},{default:s(()=>[...t[14]||(t[14]=[_(" Edit ",-1)])]),_:1},8,["onClick"])),e.id!==-1?(c(),p(i,{key:3,class:"w-16",size:"small",type:"danger",onClick:n=>se(e)},{default:s(()=>[...t[15]||(t[15]=[_(" Delete ",-1)])]),_:1},8,["onClick"])):S("",!0)]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue"])],64)}}});export{ma as default};
