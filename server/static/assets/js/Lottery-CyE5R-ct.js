import{G as pe,u as fe,c as ve,H as ge,I as ye,A as Ce,B as be,J as he,C as ke,E as y,f as Ve,K as R,L as xe,M as Ee,N as ze,D as De,O as Ue,P as Se,t as Ne,Q as Oe,R as Be,r as we}from"./element-plus-M7zOPo2E.js";import{b as T,j as $e,k as A,m as Ie,n as F,o as Le}from"./api-shared-Cph26xYJ.js";import{c as Ge}from"./utils-shared-DVqbzSND.js";import{u as Q}from"./utils-Dtqx8Ray.js";import{j as Pe,r as b,c as je,t as Je,n as C,s as _,Q as l,M as Me,G as s,l as u,F as w,o as i,$ as m,a6 as q,u as $,D as E,J as I}from"./vue-vendor-C-hNZ0TW.js";import"./vendor-4xlYshH7.js";import"./types-shared-DZNZ_0yA.js";const Re={class:""},Te={class:"flex w-[400px] items-center mb-2"},Ae={class:"flex items-center"},Fe={class:"flex-1 flex items-center justify-end"},Qe={class:"h-24 flex"},qe={key:0,class:"flex items-center w-24"},He={key:1,class:"relative z-50 w-full h-full"},Ke={key:1,class:"relative w-24"},Ze={class:"flex flex-col"},We={class:"flex items-center"},Xe={class:"flex items-center pl-2"},Ye={class:"flex flex-col gap-2 [&_.el-button+_.el-button]:!ml-0"},ea={class:"flex items-center"},aa={key:1},ta={class:"flex items-center"},la={key:1},z=10,ma=Pe({__name:"Lottery",setup(sa){const h=b(0),k=je(()=>f.value.find(a=>a.id===h.value)||f.value[0]),c=b({data:[],pageNum:1,pageSize:10,totalCount:0,totalPage:0}),f=b([]),D=b(!1),x=b({fee:10}),U=b(!1),v=b([]),S=async()=>{try{const a=await T("t_gift_category");if(a&&a.data){const t=a.data.data||[];f.value=[...t],f.value.unshift({id:0,name:"全部"}),h.value===0&&f.value.length>0&&(h.value=f.value[0].id),v.value=[],v.value.push({id:-1,name:"",edited:!0}),Q(t,o=>{v.value.push({id:o.id,name:o.name,cost:o.cost,edited:!1})})}}catch(a){console.error(a),y.error(JSON.stringify(a))}},V=async(a,t,o)=>{D.value=!0;try{let r;a&&a!==0&&(r={cate_id:a});const d=await T("t_gift",r,t,o);if(d&&d.data){const N=d.data.data||[];c.value.data=[],c.value.pageNum=d.data.pageNum??t,c.value.pageSize=d.data.pageSize??o,c.value.totalCount=d.data.totalCount??0,c.value.totalPage=d.data.totalPage??Math.ceil((d.data.totalCount??0)/(d.data.pageSize??o)),Q(N,g=>{c.value.data.push({id:g.id,name:g.name,img:g.image,cate_id:g.cate_id,cost:g.cost,enable:g.enable===1,edited:!1})})}}catch(r){console.error(r),y.error(JSON.stringify(r))}finally{D.value=!1}},H=async()=>{try{await Le("lottery",2,JSON.stringify(x.value))}catch(a){console.error("更新费用失败:",a),y.error("更新费用失败")}},K=()=>{const a=k.value;a&&V(a.id,1,z)},Z=()=>{c.value.data.unshift({id:-1,name:"",img:"",cate_id:k.value.id,cost:0,enable:!1,edited:!0})},W=(a,t)=>{t.cate_id=a},X=async a=>{try{a.edited=!1,await A("t_gift",a.id),await V(k.value.id,c.value.pageNum,c.value.pageSize)}catch(t){console.error("删除奖品失败:",t),y.error("删除奖品失败")}},Y=async(a,t)=>{if(a.id===-1)c.value.data.splice(t,1);else{a.edited=!1;try{const o=await Ie("t_gift",a.id);Object.assign(a,{id:o.id,name:o.name,img:o.image,cate_id:o.cate_id,cost:o.cost,enable:o.enable===1})}catch(o){console.error("获取奖品数据失败:",o)}}},ee=async a=>{try{const t={id:a.id,name:a.name,image:a.img,cate_id:a.cate_id,enable:a.enable?1:0,cost:a.cost};await F("t_gift",t),await V(k.value.id,c.value.pageNum,c.value.pageSize)}catch(t){console.error("保存奖品失败:",t),y.error("保存奖品失败")}},L=async(a,t)=>{if(a&&a.raw)try{const o=await Ge(a.raw,{quality:.5});console.log("压缩后的base64",o.length),t.img=o}catch(o){console.error("图片压缩失败:",o),y.error("图片压缩失败")}},ae=(a,t)=>{V(k.value.id,a,t)},G=(a,t,o)=>{console.log("handleCateBlur",a,t)},te=async(a,t)=>{try{const o={id:a.id,name:a.name,cost:a.cost};await F("t_gift_category",o),await S()}catch(o){console.error("保存类别失败:",o),y.error("保存类别失败")}},le=async a=>{try{await A("t_gift_category",a.id),await S()}catch(t){console.error("删除类别失败:",t),y.error("删除类别失败")}},P=a=>{a.edited=!0},se=(a,t)=>{a.id===-1?(a.name="",a.cost=0):a.edited=!1},ne=async()=>{try{const a=await $e("lottery",2);a&&Object.assign(x.value,JSON.parse(a))}catch(a){console.error("获取抽奖设置失败:",a)}};return Je(async()=>{await S(),await V(0,1,z),await ne()}),(a,t)=>{const o=pe,r=fe,d=ve,N=ge,g=Be,oe=ye,O=Ve,j=xe,J=ze,p=De,B=Se,de=Ue,ie=we,ce=Ne,ue=Oe,M=be,re=he,me=ke,_e=Ce;return i(),C(w,null,[_("div",Re,[_("div",Te,[l(o,{class:"w-24"},{default:s(()=>[...t[5]||(t[5]=[m("普通抽奖费用",-1)])]),_:1}),l(r,{modelValue:x.value.fee,"onUpdate:modelValue":t[0]||(t[0]=e=>x.value.fee=e),class:"!w-32 ml-2",type:"number"},null,8,["modelValue"]),l(d,{type:"primary",class:"ml-2",onClick:H},{default:s(()=>[...t[6]||(t[6]=[m(" Update ",-1)])]),_:1})]),l(N),_("div",Ae,[l(oe,{size:"large",modelValue:h.value,"onUpdate:modelValue":t[1]||(t[1]=e=>h.value=e),class:"",onChange:K},{default:s(()=>[(i(!0),C(w,null,q(f.value,e=>(i(),u(g,{key:e.id,value:e.id},{default:s(()=>[m(I(e.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"]),l(d,{type:"primary",class:"ml-1",onClick:t[2]||(t[2]=e=>U.value=!0)},{default:s(()=>[l(O,null,{default:s(()=>[l($(R))]),_:1})]),_:1}),_("div",Fe,[l(d,{type:"primary",class:"",onClick:Z},{default:s(()=>[...t[7]||(t[7]=[m("添加奖品",-1)])]),_:1})])]),Me((i(),u(M,{data:c.value.data},{default:s(()=>[l(p,{width:"130",label:"Image"},{default:s(({row:e})=>[_("div",Qe,[e.edited?(i(),C("div",qe,[e.img?(i(),C("div",He,[l(J,{class:"w-24 cursor-pointer !z-[99]",src:e.img,"preview-src-list":[e.img],"preview-teleported":!0,fit:"contain"},null,8,["src","preview-src-list"]),l(j,{class:"absolute bottom-0 right-0 !z-[100]",action:"#","show-file-list":!1,"auto-upload":!1,"on-change":n=>L(n,e)},{default:s(()=>[l(d,{size:"small",type:"primary",circle:""},{default:s(()=>[l(O,null,{default:s(()=>[l($(R))]),_:1})]),_:1})]),_:1},8,["on-change"])])):(i(),u(j,{key:0,class:"flex items-center justify-center bg-white w-full h-full",action:"#","list-type":"picture-card",limit:1,"auto-upload":!1,"show-file-list":!1,"on-change":n=>L(n,e)},{default:s(()=>[l(O,null,{default:s(()=>[l($(Ee))]),_:1})]),_:1},8,["on-change"]))])):(i(),C("div",Ke,[l(J,{class:"w-24 cursor-pointer !z-[9999]",src:e.img,"preview-src-list":[e.img],"preview-teleported":!0,fit:"contain"},null,8,["src","preview-src-list"])]))])]),_:1}),l(p,{label:"Info",width:"200"},{default:s(({row:e})=>[_("div",Ze,[l(de,{column:1,size:"small",border:"","label-width":"50"},{default:s(()=>[l(B,{label:"ID",width:"100"},{default:s(()=>[l(r,{modelValue:e.id,"onUpdate:modelValue":n=>e.id=n,size:"small",disabled:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l(B,{label:"名称"},{default:s(()=>[l(r,{modelValue:e.name,"onUpdate:modelValue":n=>e.name=n,size:"small",disabled:!e.edited},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1024),l(B,{label:"Cost"},{default:s(()=>[l(r,{modelValue:e.cost,"onUpdate:modelValue":n=>e.cost=n,size:"small",disabled:!e.edited},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1024)]),_:2},1024)])]),_:1}),l(p,{label:"Category",width:"180"},{default:s(({row:e})=>[_("div",We,[l(ce,{disabled:!e.edited,modelValue:e.cate_id,"onUpdate:modelValue":n=>e.cate_id=n,onChange:n=>W(n,e)},{default:s(()=>[(i(!0),C(w,null,q(f.value,n=>(i(),u(ie,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["disabled","modelValue","onUpdate:modelValue","onChange"])])]),_:1}),l(p,{label:"启用",width:"80"},{default:s(({row:e})=>[_("div",Xe,[l(ue,{modelValue:e.enable,"onUpdate:modelValue":n=>e.enable=n,size:"large",disabled:!e.edited},null,8,["modelValue","onUpdate:modelValue","disabled"])])]),_:1}),l(p,{label:"Operations"},{default:s(({row:e})=>[_("div",Ye,[e.id!==-1?(i(),u(d,{key:0,class:"w-16",size:"small",type:"danger",onClick:n=>X(e)},{default:s(()=>[...t[8]||(t[8]=[m(" Delete ",-1)])]),_:1},8,["onClick"])):E("",!0),e.edited?(i(),u(d,{key:1,class:"w-16",size:"small",onClick:n=>Y(e,c.value.data.indexOf(e))},{default:s(()=>[...t[9]||(t[9]=[m(" Cancel ",-1)])]),_:1},8,["onClick"])):(i(),u(d,{key:2,size:"small",class:"w-16",onClick:n=>P(e)},{default:s(()=>[...t[10]||(t[10]=[m(" Edit ",-1)])]),_:1},8,["onClick"])),e.edited?(i(),u(d,{key:3,class:"w-16",size:"small",type:"primary",onClick:n=>ee(e)},{default:s(()=>[...t[11]||(t[11]=[m(" Save ",-1)])]),_:1},8,["onClick"])):E("",!0)])]),_:1})]),_:1},8,["data"])),[[_e,D.value]]),l(re,{layout:"prev, pager, next",total:c.value.totalCount,"page-size":z,"current-page":c.value.pageNum,class:"mt-2",background:"",onCurrentChange:t[3]||(t[3]=e=>ae(e,z))},null,8,["total","current-page"])]),l(me,{modelValue:U.value,"onUpdate:modelValue":t[4]||(t[4]=e=>U.value=e),title:"类别管理",width:"800","destroy-on-close":""},{default:s(()=>[l(M,{data:v.value},{default:s(()=>[l(p,{property:"id",label:"ID",width:"50"}),l(p,{property:"name",label:"Name",width:"100"},{default:s(({row:e})=>[_("div",ea,[e.edited?(i(),u(r,{key:0,modelValue:e.name,"onUpdate:modelValue":n=>e.name=n,size:"small",onBlur:n=>G(e,"name",v.value.indexOf(e))},null,8,["modelValue","onUpdate:modelValue","onBlur"])):(i(),C("span",aa,I(e.name),1))])]),_:1}),l(p,{property:"cost",label:"Cost",width:"200"},{default:s(({row:e})=>[_("div",ta,[e.edited?(i(),u(r,{key:0,modelValue:e.cost,"onUpdate:modelValue":n=>e.cost=n,size:"small",clearable:"",onBlur:n=>G(e,"cost",v.value.indexOf(e))},null,8,["modelValue","onUpdate:modelValue","onBlur"])):(i(),C("span",la,I(e.cost),1))])]),_:1}),l(p,{label:"OP"},{default:s(({row:e})=>[e.edited?(i(),u(d,{key:0,class:"w-16",size:"small",type:"primary",onClick:n=>te(e,v.value.indexOf(e))},{default:s(()=>[...t[12]||(t[12]=[m(" Save ",-1)])]),_:1},8,["onClick"])):E("",!0),e.edited?(i(),u(d,{key:1,class:"w-16",size:"small",onClick:n=>se(e,v.value.indexOf(e))},{default:s(()=>[...t[13]||(t[13]=[m(" Cancel ",-1)])]),_:1},8,["onClick"])):(i(),u(d,{key:2,size:"small",class:"w-16",onClick:n=>P(e)},{default:s(()=>[...t[14]||(t[14]=[m(" Edit ",-1)])]),_:1},8,["onClick"])),e.id!==-1?(i(),u(d,{key:3,class:"w-16",size:"small",type:"danger",onClick:n=>le(e)},{default:s(()=>[...t[15]||(t[15]=[m(" Delete ",-1)])]),_:1},8,["onClick"])):E("",!0)]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue"])],64)}}});export{ma as default};
