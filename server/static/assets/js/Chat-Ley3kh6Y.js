import{ai as N,n as r,o as l,s as c,j as W,c as U,r as u,t as Z,A as T,y as q,J as k,Q as d,G as y,ae as K,D as E,F as X,a6 as Y,u as ee,$ as te,l as V}from"./vue-vendor-C-hNZ0TW.js";import{u as oe,c as se,E as A,f as ne,T as le,b as ae}from"./element-plus-DTFHWHVb.js";import{l as re}from"./socket-DEWE7BO1.js";import{d as ce,k as ie,l as ue}from"./api-shared-BhtujeU1.js";import{u as de,_ as me}from"./index-fLjpm1sV.js";import{w as he}from"./utils-BjcahYMR.js";import"./vendor-4xlYshH7.js";import"./types-shared-BezSyEn9.js";import"./utils-shared-DLZnwTx3.js";import"./vant-7Cqjo8an.js";const pe={viewBox:"0 0 512 512",width:"1.2em",height:"1.2em"};function ve(x,s){return l(),r("svg",pe,[...s[0]||(s[0]=[c("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M157.65 192H88a8 8 0 0 0-8 8v112a8 8 0 0 0 8 8h69.65a16 16 0 0 1 10.14 3.63l91.47 75a8 8 0 0 0 12.74-6.46V119.83a8 8 0 0 0-12.74-6.44l-91.47 75a16 16 0 0 1-10.14 3.61M352 320c9.74-19.41 16-40.81 16-64c0-23.51-6-44.4-16-64m48 176c19.48-34 32-64 32-112s-12-77.7-32-112"},null,-1)])])}const _e=N({name:"ion-volume-medium-outline",render:ve}),fe={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function ge(x,s){return l(),r("svg",fe,[...s[0]||(s[0]=[c("path",{fill:"currentColor",d:"M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10a10 10 0 0 0 10-10A10 10 0 0 0 12 2m0 2c4.41 0 8 3.59 8 8s-3.59 8-8 8s-8-3.59-8-8s3.59-8 8-8M9 9v6h6V9"},null,-1)])])}const we=N({name:"mdi-stop-circle-outline",render:ge}),ke={class:"max-w-250 h-full bg-blue-100 flex flex-col"},ye={class:"text-center"},xe={class:"h-[300px]"},Ce={key:0,class:"flex"},be={class:"max-w-[70%] min-w-[40px] bg-green-500 text-white p-2 ml-auto rounded-lg shadow-md relative"},Se=["onClick"],Ie={key:1,class:"flex"},Re={class:"max-w-[70%] min-w-[40px] bg-pink-200 rounded-lg ml-2 p-2 shadow-md mr-auto relative"},Ue={class:"flex bg-green-500"},B=3,Te=W({__name:"Chat",setup(x){const s=de(),L=U(()=>s.userList),M=U(()=>s.curUser.id),v=u(!1),m=u(""),a=u(null),h=u([]),C=u(!1),_=u({open:!1,ttsSpeed:1.1,ttsRole:"",aiConversationId:"",chatRoomId:"v_chat_room_001"}),o=u(null),$=ue().replace("api","");function D(){o.value&&o.value.disconnect(),o.value=re($,{transports:["websocket"],timeout:2e4,autoConnect:!1,forceNew:!0}),o.value.on("connect",()=>{const e={key:"123456",ttsAuto:!1,chatRoomId:_.value.chatRoomId,user:s.curUser.name||""};console.log("Connected to the server. Send handshake...",e),o.value?.emit("handshake",e)}),o.value.on("handshakeResponse",e=>{console.log("handshakeResponse:",e)}),o.value.on("connect_error",e=>{console.error("Connection error:",e)}),o.value.on("disconnect",()=>console.log("Disconnected from the server.")),o.value.on("error",e=>console.error("msg error:",e)),o.value.on("close",()=>console.log("WebSocket connection closed.")),o.value.on("endChat",e=>{console.log("endChat",e)}),o.value.on("msgChat",e=>{e.chat_type==="chat_room"?h.value.push({id:"_",content:e.content,role:e.user_id,ts:e.ts,type:e.type}):A.error(JSON.stringify(e))}),o.value.connect()}const J=async()=>{await s.refreshUserList()},j=async()=>{try{const e=s.curUser.id;if(e==null)return;const t=await ce("chatSetting",e);if(t){const i=typeof t=="string"?JSON.parse(t):t;_.value=i.data||i}}catch(e){console.error("获取聊天设置失败:",e)}},b=()=>{T(()=>{setTimeout(()=>{const e=a.value;e&&(e.scrollTop=e.scrollHeight)},10)})},S=async(e,t,i)=>{v.value=!0;try{const g=(await ie("chat:"+_.value.chatRoomId,e,t)).data||[];he(g,w=>{const p=JSON.parse(w);h.value.unshift({id:"_",content:p.content,role:p.user_id,ts:p.ts,type:p.type})})}catch(f){console.error("获取聊天消息失败:",f)}finally{v.value=!1}i&&b()},I=e=>L.value.find(t=>t.id===e),O=()=>{if(!m.value)return;const e=s.curUser.id;if(!e){A.warning("请先登录");return}h.value.push({id:"_",content:m.value,role:e,type:"text"});const t=JSON.stringify({type:"text",content:m.value,chatType:"chat_room",roomId:_.value.chatRoomId,userId:e});o.value?.emit("message",t),console.log("send message:",t),m.value="",b()},H=async()=>{const e=h.value.length+1;await S(-e,B,!1)},z=e=>{console.log("btnAudioClk",e)},F=()=>{a.value&&a.value.scrollTo({top:0,behavior:"smooth"})},R=()=>{a.value&&(C.value=a.value.scrollTop>100)};return Z(async()=>{await J(),await j(),await S(-1,B,!0),D(),T(()=>{a.value&&a.value.addEventListener("scroll",R)})}),q(()=>{o.value&&o.value.disconnect(),a.value&&a.value.removeEventListener("scroll",R)}),(e,t)=>{const i=ae,f=we,g=_e,w=ne,p=K("van-pull-refresh"),G=oe,P=se;return l(),r("div",ke,[c("h1",ye,"Chat length ["+k(h.value.length)+"]",1),c("div",xe,[d(p,{modelValue:v.value,"onUpdate:modelValue":t[0]||(t[0]=n=>v.value=n),onRefresh:H,class:"h-full","scroll-target":()=>e.$refs.chatContent},{default:y(()=>[c("div",{ref_key:"chatContent",ref:a,class:"h-full overflow-y-auto"},[(l(!0),r(X,null,Y(h.value,(n,Q)=>(l(),r("div",{key:Q,class:"p-1.5 w-full message-item"},[n.role==M.value?(l(),r("div",Ce,[c("div",be,k(n.content),1),d(i,{src:I(n.role)?.icon,class:"w-12 h-12 ml-1"},null,8,["src"]),n.audioSrc?E("",!0):(l(),r("div",{key:0,class:"absolute -right-10 top-1 rounded-[50%] border border-cyan-950 w-8 h-8 flex items-center justify-center text-black",onClick:Ee=>z(n)},[n.playing?(l(),V(f,{key:0,class:"w-6 h-6"})):(l(),V(g,{key:1,class:"w-6 h-6"}))],8,Se))])):(l(),r("div",Ie,[d(i,{src:I(n.role)?.icon,class:"w-12 h-12 ml-1"},null,8,["src"]),c("div",Re,k(n.content),1)]))]))),128))],512),C.value?(l(),r("div",{key:0,class:"fixed bottom-20 right-4 z-50 w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center cursor-pointer shadow-lg",onClick:F},[d(w,{size:20,color:"white"},{default:y(()=>[d(ee(le))]),_:1})])):E("",!0)]),_:1},8,["modelValue","scroll-target"])]),c("div",Ue,[d(G,{modelValue:m.value,"onUpdate:modelValue":t[1]||(t[1]=n=>m.value=n),class:"w-full h-17 ml-2 mt-2",type:"textarea",placeholder:"Please input"},null,8,["modelValue"]),d(P,{class:"!w-16 !h-13 mx-2 mt-2",type:"primary",onClick:O},{default:y(()=>[...t[2]||(t[2]=[te(" Send ",-1)])]),_:1})])])}}}),Oe=me(Te,[["__scopeId","data-v-5add3bf0"]]);export{Oe as default};
