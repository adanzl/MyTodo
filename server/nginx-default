server {
    listen 8848 default_server;
    listen 443 ssl;
    listen [::]:8848 default_server;

    root /mnt/data/project/MyTodo/dist;
    index index.html index.htm index.nginx-debian.html;

    ssl_certificate /etc/ssl/self-signed/selfsigned.crt;
    ssl_certificate_key /etc/ssl/self-signed/selfsigned.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;

    server_name _;

    # ========== 全局性能优化 ==========
    
    # 全局 gzip 压缩配置
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_comp_level 6;
    gzip_disable "msie6";
    gzip_types 
        text/plain 
        text/css 
        text/xml 
        text/javascript 
        application/json 
        application/javascript 
        application/xml+rss 
        application/x-javascript 
        application/xhtml+xml
        application/x-font-ttf 
        application/vnd.ms-fontobject 
        font/opentype 
        image/svg+xml 
        image/x-icon
        application/wasm;

    # 统一超时设置（所有 proxy location 继承）
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # 统一缓冲区优化（所有 proxy location 继承）
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;

    # 处理跨域问题
    #add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
    add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
    
    # 使用 types 指令确保正确的 MIME 类型
    types {
        application/javascript js mjs;
        text/css css;
        text/html html;
    }
    default_type application/octet-stream;

    location /web {
        alias /mnt/data/project/MyTodo/server/static;
        index index.html;
        try_files $uri $uri/ /web/index.html;
        autoindex on;
        
        # 缓存静态资源
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    location /cockpit-secret/ {
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_ssl_verify off;
        proxy_pass https://127.0.0.1:9090/cockpit-secret/;
        
        # 超时和缓冲区已通过全局配置继承，无需重复设置
        
        # 缓存静态资源
        location ~* /cockpit-secret/.*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|gz)$ {
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_ssl_verify off;
            proxy_pass https://127.0.0.1:9090;
            
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }
    
    location /corder/ {
        proxy_pass http://localhost:8001/;
        proxy_set_header Host $http_host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection upgrade;
        proxy_set_header Accept-Encoding gzip;
        
        # 超时和缓冲区已通过全局配置继承
    }

    location ^~ /api/ {
        proxy_pass http://127.0.0.1:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # API 可能需要更短的超时，可以覆盖全局设置
        proxy_read_timeout 30s;
        # 其他超时和缓冲区继承全局配置
    }
    
    location /socket.io/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
        proxy_buffering off;
    
        # WebSocket 需要长超时，覆盖全局设置
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }
    
    location /portainer/ {
        proxy_pass http://127.0.0.1:9000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect http://127.0.0.1:9000/ /portainer/;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 超时和缓冲区已通过全局配置继承
    }

    location /redis_insight/ {
        set $auth_cookie "";
        if ($http_cookie ~* "auth=([^;]+)") {
            set $auth_cookie $1;
        }
        if ($auth_cookie != "cockpit") {
            return 403;
        }
        proxy_pass          http://127.0.0.1:9001/redis_insight/;
        proxy_read_timeout  900;
        proxy_set_header    Host $host;
        proxy_set_header    X-Real-IP $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_http_version  1.1;
        proxy_set_header    Upgrade $http_upgrade;
        proxy_set_header    Connection "upgrade";

        proxy_redirect      off;
        proxy_buffering     off;
        
        # 超时和缓冲区已通过全局配置继承（proxy_read_timeout 已单独设置）
    }

    location /dify/ {
        proxy_pass          http://127.0.0.1:9098/;
        proxy_set_header    Host $host;
        proxy_set_header    X-Real-IP $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;
        proxy_set_header    X-Forwarded-Prefix /dify;
        rewrite ^/dify/(.*)$ /$1 break;
        
        # 超时和缓冲区已通过全局配置继承
    }

    location /dbgate/ {
        proxy_pass          http://127.0.0.1:8003/;
        proxy_set_header    Host $host;
        proxy_set_header    X-Real-IP $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;
        proxy_set_header    X-Forwarded-Prefix /dbgate;
        
        # 超时和缓冲区已通过全局配置继承
    }

    location /browser/ {
        proxy_pass          http://localhost:9103/;
        proxy_http_version 1.1;
        proxy_set_header    Upgrade $http_upgrade;
        proxy_set_header    Connection "upgrade";
        proxy_set_header    Host $host;
        proxy_set_header    X-Real-IP $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # WebSocket 需要长超时，覆盖全局设置
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
        proxy_buffering off;
    }

    location / {
        try_files $uri $uri/ /index.html index;
        
        # 缓存 HTML 文件（较短时间，因为可能更新）
        location ~* \.(html|htm)$ {
            expires 1h;
            add_header Cache-Control "public, must-revalidate";
        }
        
        # 缓存静态资源（较长时间）
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|json)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }

    # 处理 OPTIONS 请求
    location = / {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
        }
    }
}