# 业务说明：边界条件及与后端约定

本文档说明前端复杂业务的边界条件及与后端的接口/数据约定，便于协作与维护。

---

## 1. 日程规则

### 1.1 数据来源与接口

- **拉取**：`GET /getData?table=t_schedule&fields=data,user_id`，返回存档 JSON 及 `user_id`；前端用 `UData.parseUserData` 解析为 `UserData`。
- **保存**：`POST /setData`，body `{ table: "t_schedule", data: { id, data: JSON.stringify(data) } }`，其中 `data` 为当前用户日程存档（可含多日、多任务的完成状态与覆盖字段）。
- **积分变更**：完成/取消完成日程时前端调用 `POST /addScore`，后端据此更新用户积分；前端通过 `getUserInfo` 或事件刷新展示。

### 1.2 重复类型（repeat）

| repeat id | 含义 | 说明 |
| --- | --- | --- |
| 0 | 无重复 | 仅开始日当天展示 |
| 1 | 每天 | 开始日及之后每日展示，受 `repeatEndTs` 限制 |
| 2 | 每星期 | 与开始日「星期几」相同的工作日展示 |
| 3 | 每月 | 与开始日「日期」相同的日期展示 |
| 4 | 每年 | 与开始日「月+日」相同的日期展示 |
| 5 | 工作日 | 周一～周五展示 |
| 6 | 每周末 | 周六、周日展示 |
| 999 | 自定义 | 由 `repeatData.week` 指定星期几（0=周日…6=周六） |

**边界条件**：

- 若存在 `repeatEndTs`，则仅在该日期及之前的日期参与计算；之后不再展示。
- 自定义重复：`repeatData.week` 为空或未包含当天则不展示。
- 日程在「开始日当天」一定展示；开始日之前的日期不展示。

### 1.3 日程存档与覆盖

- **save**：`UserData.save[dKey][scheduleId]` 为某日某任务的完成情况（`ScheduleSave`），`dKey` 为 `YYYY-MM-DD`。
- **state**：0=未完成，1=完成；切换时会触发积分变更（`addScore`）及 `UPDATE_USER_INFO` 等事件。
- **scheduleOverride**：可选，表示该日对该任务的覆盖（标题、颜色、子任务等）；仅影响当日展示与保存，不写回主日程列表。

---

## 2. 抽奖规则

### 2.1 与后端约定

- **抽奖配置**：Redis 表 `lottery`，id 固定为 `2`；前端通过 `getRdsData(table="lottery", id=2)` 拉取，通过 `setRdsData` 写入（值为 JSON 字符串）。
- **抽奖执行**：`POST /doLottery`，body `{ user_id, cate_id }`；后端按分类与权重随机结果并扣积分，返回结果数据。
- **奖品信息**：`GET /getData?table=t_gift&fields=*`，按 id 拉取单个奖品信息。

### 2.2 边界条件

- 抽奖前需保证用户已登录且积分充足；不足时后端返回错误，前端需提示。
- `cate_id` 与后端抽奖分类一致；前端展示的分类列表需与后端配置一致。

---

## 3. 关键操作二次确认与反馈

为降低误操作风险，下列关键操作均具备**二次确认**和**轻量反馈**（Toast 或弹窗）：

| 操作 | 确认方式 | 反馈方式 | 代码位置 |
| --- | --- | --- | --- |
| **删除日程** | 弹窗「确认删除」+ 文案「确定要删除日程「xxx」吗？删除后不可恢复。」 | 确认后 Toast「已删除日程」 | `PageSchedule.ts`（btnScheduleRemoveClk、onDelSchedulerConfirm） |
| **抽奖** | 弹窗「确认抽奖」+ 文案「确定使用积分进行抽奖吗？（分类名）」 | 成功后 Toast「抽奖成功」+ REWARD 弹窗；失败 Toast 错误信息 | `PageLottery.vue`（btnLotteryClk） |
| **删除课表课程** | 弹窗「确认删除」+ 课程名 | 成功后 Toast「已删除课程」；失败 Toast「删除课程失败」 | `PageTimetable.vue`（deleteCourse） |
| **移除心愿单** | 弹窗「确认移除心愿单」+ 奖品信息 | 成功后 Toast「移除心愿成功」 | `PageLottery.vue`（btnRemoveWishClk） |
| **删除 TTS 任务** | 弹窗「确定删除任务「xxx」吗？此操作不可恢复。」 | 成功后 Toast「已删除」；失败 Toast 错误信息 | `TabTtsTasks.vue`（confirmDelete） |
| **日程内删除子任务** | 弹窗「确认删除 ： xxx」 | 无独立 Toast，依赖保存后整体反馈 | `SchedulePopModal.ts`（btnSubtaskRemoveClk） |

---

## 4. 相关代码位置

| 业务 | 类型/常量 | 逻辑入口 |
| --- | --- | --- |
| 日程重复 | `types/ScheduleType.ts`（RepeatOptions、getNextRepeatDate） | `types/UserData.ts`（UData.createDayData） |
| 日程存档 | `types/UserData.ts`（ScheduleSave、setScheduleSave） | `api/schedule.ts`（getSave、setSave） |
| 抽奖 | `api/lottery.ts`（doLottery、getLotteryData） | `views/lottery-page/*` |
