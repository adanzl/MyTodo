# 日程 / 日历 / 课表与后端同步策略

本文档说明日程、日历、课表与后端的**拉取频率、冲突处理、离线与缓存策略**，便于协作与维护。

---

## 1. 数据源与接口概览

| 模块 | 后端表/接口 | 拉取 | 保存 | 说明 |
| --- | --- | --- | --- | --- |
| **日程 / 日历** | `t_schedule`（存档） | `getSave(id)` → GET /getData | `setSave(id, data)` → POST /setData | 按存档 id 全量读写，一份存档含 schedules + save（日完成状态） |
| **课表** | Redis `t_timetable` | `getRdsData("t_timetable", 0)` | `setRdsData("t_timetable", 0, value)` | 单 key（id=0），全量 JSON |

---

## 2. 日程与日历

### 2.1 拉取频率

- **进入 Tab 时拉取**：日程页（PageSchedule）、日历页（PageCalendar）在 `onIonViewDidEnter` 时调用 `refreshAllData(scheduleListId)`，即每次进入该 Tab 拉取一次 `getSave(id)`。
- **切换存档/组时拉取**：监听事件 `C_EVENT.UPDATE_SCHEDULE_GROUP`，触发时再次 `refreshAllData(globalVar.scheduleListId)`。
- **无定时轮询**：不设 setInterval 等定时拉取；用户需切换 Tab 或触发上述事件才会从服务端取最新数据。

### 2.2 冲突处理

- **无版本号/时间戳**：接口为全量覆盖，无乐观锁或 last-modified。
- **策略**：**Last-Write-Wins**。多端或多 Tab 同时编辑时，后一次 `setSave` 会覆盖前一次；无服务端合并、无冲突提示。
- **建议**：若需多端协同，可后续引入版本号或服务端合并策略，并在前端对冲突场景做提示或二次确认。

### 2.3 离线与缓存

- **当前**：无本地持久化缓存。拉取失败时展示 toast（`JSON.stringify(err)`），保存失败仅 `console.error`；断网时无法查看上次数据（除非页面未销毁仍持有内存中的数据）。
- **建议**：可对 `getSave` 结果做本地缓存（如 LocalStorage / IndexedDB），拉取失败时先展示缓存并标记「离线」；恢复网络后可选「重新拉取」或「以服务端为准覆盖本地」。

---

## 3. 课表

### 3.1 拉取频率

- **进入页面时拉取**：PageTimetable 在 `onMounted` 时调用 `loadTimetableData()`，即 `getRdsData("t_timetable", 0)` 一次。
- **手动刷新**：用户点击刷新按钮时再次 `loadTimetableData()`。
- **无定时轮询**：不设定时拉取。

### 3.2 冲突处理

- **前端本地校验**：仅做「同一 weekday + 同一 child 下，课程时间段不重叠」的校验（`checkTimeConflicts()`）；冲突时弹窗提示，禁止保存。
- **与后端/多端**：无版本号、无服务端冲突合并。`setRdsData` 为全量覆盖，多端同时编辑会互相覆盖，策略同样是 **Last-Write-Wins**。

### 3.3 离线与缓存

- **当前**：无本地持久化缓存。`getRdsData` 失败时在 catch 中 `timetableData = {}`，并 `console.error`；断网时再次进入课表页会得到空数据。
- **建议**：可将最近一次成功拉取或保存的课表 JSON 写入 LocalStorage / IndexedDB，离线或请求失败时先展示缓存并提示「当前为离线数据」。

---

## 4. 汇总表

| 项目 | 日程/日历 | 课表 |
| --- | --- | --- |
| **拉取频率** | 进入 Tab / 切换存档或组时拉取；无定时轮询 | 进入页面 + 手动刷新；无定时轮询 |
| **冲突处理** | Last-Write-Wins，无版本号与合并 | 本地时间段冲突校验；与后端/多端仍为 Last-Write-Wins |
| **离线/缓存** | 无本地缓存；失败仅 toast/console | 无本地缓存；失败则展示空 |

---

## 5. 相关代码位置

| 模块 | 拉取/刷新 | 保存 | 事件 |
| --- | --- | --- | --- |
| 日程 | `PageSchedule.ts`：`refreshAllData`、`onIonViewDidEnter` | `PageSchedule.ts`：`doSaveUserData` → `setSave`；`CalendarCover.vue`：`setSave` | `C_EVENT.UPDATE_SCHEDULE_GROUP` |
| 日历 | `PageCalendar.vue`：`refreshAllData`、`onIonViewDidEnter` | 同日程（共用 `getSave`/`setSave`） | 同上 |
| 课表 | `PageTimetable.vue`：`loadTimetableData`、`onMounted`、`refreshData` | `PageTimetable.vue`：`setRdsData("t_timetable", 0, ...)` | 无 |

---

最后更新：2026-01-31
